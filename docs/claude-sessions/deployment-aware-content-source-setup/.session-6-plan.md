# Session 06 Plan: Desktop Compatibility and Migration

## Mission

Finish backward-compatibility, upgrade, and documentation work so existing
installs survive the new deployment-aware source model cleanly. When this
session is done, every existing user -- desktop `local_fs`, self-host with
`service_account_key`, or cloud -- has a documented and tested upgrade path.
Session 07 can then validate both fresh installs and upgraded installs E2E.

---

## Current State (post Session 05)

### What exists
- `ContentSourceEntry` already has both `service_account_key` (legacy) and
  `connection_id` (new) fields with `skip_serializing_if = "Option::is_none"`.
- Watchtower dispatches `connection_id` (priority 1) > `service_account_key`
  (priority 2) for Google Drive auth strategy.
- Validation warns (non-blocking) when both are present.
- Legacy TOML configs with only `service_account_key` parse and work.
- Frontend onboarding and settings both use `connection_id` for new flows.
- Settings page shows a "Legacy SA key" notice to existing users.
- `tuitbot upgrade` (deprecated) / `tuitbot update --config-only` detects
  missing feature groups and patches TOML in-place.
- `config.example.toml` does NOT yet have `content_sources` or `connectors`
  sections.
- `docs/configuration.md` documents `service_account_key` as the only Drive
  auth method; no mention of `connection_id` or connectors.

### What's missing for Session 06
1. **Upgrade group for content sources**: The `upgrade.rs` `UpgradeGroup` enum
   only covers Persona, Targets, ApprovalMode, EnhancedLimits. No detection
   or patching for `connectors` or `deployment_mode`.
2. **config.example.toml**: Needs `[content_sources]`, `[connectors]`, and
   `deployment_mode` sections.
3. **docs/configuration.md**: Google Drive section is SA-key-only. Needs
   `connection_id`, `[connectors.google_drive]`, and per-deployment guidance.
4. **docs/getting-started.md**: No mention of content sources in quickstart.
5. **docs/lan-mode.md**: No mention of content source setup for LAN users.
6. **Regression tests**: No tests for mixed old+new source states, upgrade
   detection of missing connectors section, or TOML patching of connector
   config.
7. **migration-plan.md**: Deliverable document.
8. **session-06-handoff.md**: Deliverable document.

---

## Design Decisions

### DD1: Extend existing `UpgradeGroup` enum, not a separate migration command

The session instructions mention a "CLI `upgrade-config` subcommand." Rather
than adding a new top-level command, extend the existing `UpgradeGroup` enum
in `upgrade.rs` with two new variants: `ContentSources` and `Connectors`.

**Rationale:**
- The `tuitbot update` command already runs `upgrade::detect_missing_features()`
  as Phase 2. Adding new groups is automatically picked up.
- The `check_before_run()` pre-flight hook also uses this path -- users get
  prompted before `tuitbot run` if connectors section is missing.
- No new CLI surface to document or maintain.
- Consistent with how all other config feature additions are handled.

**Tradeoff:** The upgrade wizard prompts are necessarily simple (text input for
client ID/secret). Full OAuth linking requires the dashboard. The CLI path
adds the `[connectors.google_drive]` TOML scaffold; the user completes the
OAuth flow in the browser.

### DD2: Desktop `local_fs` is untouched by upgrade logic

Desktop users with `local_fs` sources have a complete, working setup. The
upgrade wizard should NOT modify their content sources. It only offers to add
the `[connectors.google_drive]` section if they want Drive as a secondary
source.

### DD3: SelfHost legacy SA-key users get a non-blocking notice

The upgrade wizard detects `service_account_key` without `connection_id` and
prints a notice explaining the new OAuth flow. It does NOT remove or modify
`service_account_key` -- that path continues to work. The notice directs users
to the dashboard Settings > Content Sources to link their Google account.

### DD4: `config.example.toml` shows both approaches with comments

The example file shows the `connection_id` approach as primary (recommended)
with the legacy `service_account_key` approach commented out and marked
deprecated. This guides new users while documenting the legacy path.

### DD5: Non-interactive upgrade applies sensible defaults

When `--non-interactive` is used (e.g., CI, Docker), the upgrade:
- Skips `ContentSources` group (no default sources to add)
- Adds empty `[connectors.google_drive]` scaffold if missing (with empty
  strings, ready for env-var override via `TUITBOT_CONNECTORS__GOOGLE_DRIVE__*`)

### DD6: `deployment_mode` auto-detection for Docker

Add a new `DeploymentMode` upgrade group. Detection: if `deployment_mode` key
is absent from TOML, add it. Interactive prompt asks Desktop/SelfHost/Cloud.
Non-interactive defaults to `desktop` (safe default -- matches `DeploymentMode::default()`).
If the `TUITBOT_DEPLOYMENT_MODE` env var is set, skip the prompt and use that.

---

## Files to Create/Modify

### New Files
| File | Purpose |
|------|---------|
| `docs/roadmap/deployment-aware-content-source-setup/migration-plan.md` | User-facing migration guide (deliverable) |
| `docs/roadmap/deployment-aware-content-source-setup/session-06-handoff.md` | Handoff document (deliverable) |

### Modified Files

#### 1. `crates/tuitbot-cli/src/commands/upgrade.rs`
**Changes:**
- Add `UpgradeGroup::DeploymentMode` variant (key path: `deployment_mode`)
- Add `UpgradeGroup::Connectors` variant (key path: `connectors.google_drive.client_id`)
- Add `UpgradeGroup::ContentSources` variant (key path: `content_sources`)
  - Detection only (no auto-patching in non-interactive mode)
- Add `UpgradeAnswers` fields: `deployment_mode`, `connectors`, `content_sources_notice_shown`
- Implement `prompt_deployment_mode()` (interactive: select Desktop/SelfHost/Cloud)
- Implement `prompt_connectors()` (interactive: enter GCP OAuth client_id and client_secret, or skip)
- Implement legacy SA-key notice logic (detect existing `service_account_key` entries, print migration guidance)
- Implement `patch_deployment_mode()` using `toml_edit`
- Implement `patch_connectors()` using `toml_edit`
- Update `apply_defaults()` for non-interactive path
- Update tests: detection of new groups, patching new groups, mixed old+new states

**Risk:** `upgrade.rs` is currently 827 lines. With three new groups plus tests, it will
approach the 500-line soft limit for `.rs` files (sans tests). If it grows past 500 lines
of non-test code, extract the new patch/prompt functions into a submodule
(`upgrade/` directory with `mod.rs` + `content_sources.rs`). Monitor during
implementation and split proactively if line count is trending high.

**Mitigation:** The existing test module is ~280 lines. The production code is ~450 lines.
Adding ~120 lines for three new groups (prompt + patch + detection) keeps production
code under 570, which is borderline. Plan for extraction to module directory if it hits
~550 production lines.

#### 2. `crates/tuitbot-core/src/config/tests.rs`
**Changes:**
Add regression tests for:
- `mixed_old_and_new_google_drive_source`: Config with both `service_account_key` and
  `connection_id` parses, round-trips, and validates without error.
- `legacy_local_fs_config_unaffected_by_deployment_mode`: Desktop mode with `local_fs`
  source validates OK. SelfHost mode with `local_fs` also validates OK (it's allowed).
- `legacy_sa_key_only_config_still_valid`: A Google Drive source with only
  `service_account_key` (no `connection_id`) passes validation in all deployment modes.
- `empty_content_sources_valid`: An empty `content_sources.sources = []` passes validation.
- `connection_id_without_sa_key_valid`: A Google Drive source with only `connection_id`
  (no `service_account_key`) passes validation.
- `google_drive_source_needs_either_auth`: Test that a Google Drive source with NEITHER
  `connection_id` NOR `service_account_key` triggers a validation warning (non-blocking).

#### 3. `crates/tuitbot-server/tests/api_tests.rs`
**Changes:**
Add tests for:
- `settings_patch_preserves_legacy_sa_key`: PATCH `/api/settings` with a partial update
  that doesn't touch `content_sources` preserves existing `service_account_key` in the
  on-disk TOML.
- `settings_get_redacts_sa_key_alongside_connection_id`: When a source has both
  `service_account_key` AND `connection_id`, GET `/api/settings` redacts the SA key
  but returns the `connection_id` intact.
- `settings_init_with_connection_id`: POST `/api/settings/init` with a Google Drive
  source using `connection_id` (no SA key) succeeds and round-trips.

#### 4. `config.example.toml`
**Changes:**
Add three new sections at the end of the file:

```toml
# --- Deployment Mode ---
# Controls which content source types are available.
# "desktop" (default) — Tauri app with native file picker and local filesystem
# "self_host" — Docker/VPS with browser UI; local paths and Google Drive
# "cloud" — Managed service; Google Drive and manual ingest only
# deployment_mode = "desktop"

# --- Content Sources ---
# Configure where Watchtower ingests content for Winning DNA enrichment.
# Desktop users: point to your Obsidian vault or notes folder.
# Self-hosted/Cloud users: connect Google Drive via the dashboard.

# Example: Local folder source (Desktop / SelfHost)
# [[content_sources.sources]]
# source_type = "local_fs"
# path = "~/Obsidian/my-vault"
# watch = true
# file_patterns = ["*.md", "*.txt"]
# loop_back_enabled = true

# Example: Google Drive source (recommended for SelfHost / Cloud)
# [[content_sources.sources]]
# source_type = "google_drive"
# folder_id = "1aBcD_eFgHiJkLmNoPqRsTuVwXyZ"
# connection_id = 1                    # from dashboard: Settings > Content Sources > Connect
# watch = true
# file_patterns = ["*.md", "*.txt"]
# poll_interval_seconds = 300
# loop_back_enabled = false

# Legacy: service-account JSON key (deprecated — use connection_id instead)
# service_account_key = "~/.tuitbot/service-account.json"

# --- Connectors ---
# OAuth application credentials for remote source linking.
# Get these from Google Cloud Console > APIs & Services > Credentials.
# Desktop apps may bundle defaults via environment variables.
# [connectors.google_drive]
# client_id = "YOUR_GCP_OAUTH_CLIENT_ID.apps.googleusercontent.com"
# client_secret = "GOCSPX-YOUR_CLIENT_SECRET"
# redirect_uri = "http://localhost:3001/api/connectors/google-drive/callback"
```

#### 5. `docs/configuration.md`
**Changes:**
- Update the "Content Sources" section to document both auth methods for Google Drive.
- Add `connection_id` field to the Google Drive source field table.
- Add new subsection "### Google Drive via Linked Account (Recommended)".
- Mark `service_account_key` as "Legacy" in the field table.
- Add a "### Connectors" subsection documenting `[connectors.google_drive]`.
- Update the Deployment Mode table to mention preferred source type per mode.
- Add "### Upgrading from Service Account to Linked Account" subsection.
- Add `deployment_mode` to the quick-reference table at top.
- Add `[connectors]` to the quick-reference table at top.

#### 6. `docs/getting-started.md`
**Changes:**
- Add a brief "Content Sources (Optional)" step after the "tuitbot init" section.
- Per-deployment guidance:
  - Desktop: "Point to your Obsidian vault in the dashboard Settings."
  - SelfHost: "Connect Google Drive in the dashboard."
  - Cloud: "Connect Google Drive during onboarding."

#### 7. `docs/lan-mode.md`
**Changes:**
- Add a "Content Sources" section near the end.
- Explain that LAN mode users should connect Google Drive via the dashboard
  (browser-based OAuth flow works over LAN).
- Note that `local_fs` paths resolve relative to the server filesystem, not
  the client browser.

---

## Order of Operations

### Phase 1: Config tests (regression coverage first)

**Step 1.1** — Read `crates/tuitbot-core/src/config/tests.rs`
**Step 1.2** — Add regression tests for legacy config parsing and mixed states:
- `mixed_old_and_new_google_drive_source`
- `legacy_local_fs_config_unaffected_by_deployment_mode`
- `legacy_sa_key_only_config_still_valid`
- `empty_content_sources_valid`
- `connection_id_without_sa_key_valid`

**Step 1.3** — Run `cargo test -p tuitbot-core -- config` to verify new tests pass.

### Phase 2: Validation enhancement

**Step 2.1** — Read `crates/tuitbot-core/src/config/validation.rs`
**Step 2.2** — Add non-blocking validation warning for Google Drive sources that
have neither `connection_id` nor `service_account_key` (currently the Watchtower
skips them silently; validation should surface this).
**Step 2.3** — Run config tests again.

### Phase 3: Upgrade wizard extension

**Step 3.1** — Read `crates/tuitbot-cli/src/commands/upgrade.rs` fully.
**Step 3.2** — Add `UpgradeGroup::DeploymentMode`:
- Key path: `deployment_mode`
- Display name: "Deployment Mode"
- Description: "Declare how Tuitbot runs (desktop, self-hosted, or cloud)"
- `prompt_deployment_mode()`: select from Desktop/SelfHost/Cloud
- `patch_deployment_mode()`: insert `deployment_mode = "..."` at top level
- Non-interactive default: `"desktop"`
**Step 3.3** — Add `UpgradeGroup::Connectors`:
- Key path: `connectors.google_drive.client_id`
- Display name: "Google Drive Connector"
- Description: "OAuth credentials for Google Drive integration"
- `prompt_connectors()`: prompt for client_id and client_secret (or skip)
- `patch_connectors()`: insert `[connectors.google_drive]` section
- Non-interactive default: empty `[connectors.google_drive]` scaffold
**Step 3.4** — Add `UpgradeGroup::ContentSources`:
- Key path: `content_sources`
- Display name: "Content Sources"
- Description: "Configure content ingestion from local folders or Google Drive"
- Interactive mode: print informational notice about configuring via dashboard; no prompt
- Non-interactive mode: skip entirely (no default sources to add)
- Patch: add empty `[content_sources]` with a comment
**Step 3.5** — Add legacy SA-key migration notice:
- After processing all groups, scan existing TOML for `service_account_key` entries
- If found AND no `connection_id` sibling, print:
  ```
  Tip: Your Google Drive source uses a service-account key (legacy).
  Consider switching to a linked account for simpler setup.
  Open the dashboard > Settings > Content Sources > Connect Google Drive.
  ```
**Step 3.6** — Add/update tests in `upgrade.rs` `mod tests`:
- `detect_missing_deployment_mode`
- `detect_missing_connectors`
- `detect_missing_content_sources`
- `detect_nothing_missing_with_new_groups` (extend full config)
- `patch_deployment_mode_top_level`
- `patch_connectors_section`
- `patch_content_sources_scaffold`
- `detect_legacy_sa_key_notice` (test the notice detection logic)
**Step 3.7** — Run `cargo test -p tuitbot-cli` and fix any issues.
**Step 3.8** — Evaluate line count. If `upgrade.rs` exceeds ~550 production lines,
convert to module directory: `upgrade/mod.rs` + `upgrade/content_sources.rs`.
Update `commands/mod.rs` and `main.rs` imports accordingly.

### Phase 4: Server API tests

**Step 4.1** — Read `crates/tuitbot-server/tests/api_tests.rs`
**Step 4.2** — Add:
- `settings_patch_preserves_legacy_sa_key`
- `settings_get_redacts_sa_key_alongside_connection_id`
- `settings_init_with_connection_id`
**Step 4.3** — Run `cargo test -p tuitbot-server` and fix any issues.

### Phase 5: Example config and docs

**Step 5.1** — Update `config.example.toml` with content sources, connectors,
and deployment mode sections (all commented out, following existing style).
**Step 5.2** — Update `docs/configuration.md`:
- Expand Google Drive section with linked-account method
- Add Connectors subsection
- Add migration guidance subsection
- Update quick-reference table
**Step 5.3** — Update `docs/getting-started.md` with content source guidance.
**Step 5.4** — Update `docs/lan-mode.md` with content source section.

### Phase 6: Migration plan document

**Step 6.1** — Write `docs/roadmap/deployment-aware-content-source-setup/migration-plan.md`
covering:
- Scenario matrix (Desktop local_fs, SelfHost SA-key, SelfHost local path,
  Cloud SA-key)
- Step-by-step for each scenario
- Rollback instructions
- What `tuitbot update` does vs manual dashboard steps

### Phase 7: Quality gates and handoff

**Step 7.1** — Run full CI checklist:
```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
```
**Step 7.2** — Fix any warnings or failures.
**Step 7.3** — Write `docs/roadmap/deployment-aware-content-source-setup/session-06-handoff.md`.

---

## Risks and Mitigations

### R1: `upgrade.rs` file size exceeds 500-line limit
**Likelihood:** Medium. Currently 827 lines including ~280 lines of tests.
Production code is ~450 lines. Adding ~120 lines of new logic puts it at ~570.
**Mitigation:** If production code exceeds 500 lines, convert `upgrade.rs` to
`upgrade/mod.rs` + `upgrade/content_sources.rs` following the `commands/settings/`
and `commands/init/` patterns.

### R2: Breaking existing upgrade wizard flow
**Likelihood:** Low. New groups are appended to `UpgradeGroup::all()` after
existing groups, preserving the existing upgrade wizard order.
**Mitigation:** The `detect_nothing_missing_from_full_config` test must be
updated to include the new key paths; this catches regressions.

### R3: `toml_edit` patching edge cases with array-of-tables
**Likelihood:** Low-Medium. `[[content_sources.sources]]` is an array of inline
tables in TOML. `toml_edit` handles these differently from regular tables.
**Mitigation:** The `patch_content_sources()` function only adds an empty
`[content_sources]` section header (no array entries). Array entries are
configured via the dashboard or manual TOML editing. Test the patch output
is parseable.

### R4: Non-interactive mode used in Docker builds
**Likelihood:** Medium. Docker/CI users rely on `--non-interactive` or env vars.
**Mitigation:** Non-interactive defaults are conservative (empty connectors
scaffold, desktop deployment mode). Users must explicitly configure via env
vars (`TUITBOT_DEPLOYMENT_MODE=self_host`,
`TUITBOT_CONNECTORS__GOOGLE_DRIVE__CLIENT_ID=...`). Document this path.

### R5: Docs updates create merge conflicts with other sessions
**Likelihood:** Low. Session 06 is the only session touching docs.
**Mitigation:** Keep doc changes minimal and focused. Don't reformat existing
sections unnecessarily.

---

## Verification Steps

### After each phase

| Phase | Verification |
|-------|-------------|
| 1 (Config tests) | `cargo test -p tuitbot-core -- config` |
| 2 (Validation) | `cargo test -p tuitbot-core -- config` |
| 3 (Upgrade wizard) | `cargo test -p tuitbot-cli` |
| 4 (Server tests) | `cargo test -p tuitbot-server` |
| 5 (Docs/Example) | Manual review; TOML examples parse with `toml::from_str` |
| 6 (Migration doc) | Manual review |

### Final quality gate
```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
```

---

## Test Matrix

### Config parsing (tuitbot-core)

| Test | Source Type | SA Key | Conn ID | Deploy Mode | Expected |
|------|-----------|--------|---------|-------------|----------|
| Legacy local_fs | local_fs | - | - | desktop | OK |
| Legacy local_fs | local_fs | - | - | self_host | OK |
| Legacy local_fs | local_fs | - | - | cloud | Error (rejected) |
| Legacy Drive | google_drive | yes | - | any | OK + warn in logs |
| New Drive | google_drive | - | yes | any | OK |
| Mixed Drive | google_drive | yes | yes | any | OK + warn (conn_id wins) |
| No auth Drive | google_drive | - | - | any | OK (skipped at runtime) |
| Empty sources | - | - | - | any | OK |

### Upgrade detection (tuitbot-cli)

| Config State | Missing Groups |
|-------------|---------------|
| Pre-Session-06 config (no deployment_mode, no connectors, no content_sources) | DeploymentMode, Connectors, ContentSources |
| Has deployment_mode, missing connectors | Connectors, ContentSources |
| Has all sections | (empty) |
| Has content_sources + connectors but no deployment_mode | DeploymentMode |

### Server API (tuitbot-server)

| Test | Method | Endpoint | Config State | Expected |
|------|--------|----------|-------------|----------|
| Preserve legacy SA key | PATCH | /api/settings | Has SA key | SA key unchanged on disk |
| Redact with conn_id | GET | /api/settings | Has both SA + conn_id | SA = "[redacted]", conn_id intact |
| Init with conn_id | POST | /api/settings/init | conn_id only | 200, round-trips |

---

## Dependency Graph

```
Phase 1 (config tests) ──┐
                          ├── Phase 3 (upgrade wizard) ── Phase 7 (QA + handoff)
Phase 2 (validation) ─────┤
                          ├── Phase 4 (server tests) ───┘
                          └── Phase 5 (docs) ───────────┘
                               Phase 6 (migration doc) ─┘
```

Phases 1-2 can run first. Phases 3, 4, 5, 6 can proceed in parallel after 1-2.
Phase 7 is final.

---

## Estimated File Touches

| File | Lines Added (est.) | Lines Modified (est.) |
|------|-------------------|--------------------- |
| `crates/tuitbot-core/src/config/tests.rs` | ~80 | 0 |
| `crates/tuitbot-core/src/config/validation.rs` | ~15 | 0 |
| `crates/tuitbot-cli/src/commands/upgrade.rs` | ~200 | ~15 |
| `crates/tuitbot-server/tests/api_tests.rs` | ~100 | 0 |
| `config.example.toml` | ~35 | 0 |
| `docs/configuration.md` | ~60 | ~15 |
| `docs/getting-started.md` | ~15 | 0 |
| `docs/lan-mode.md` | ~15 | 0 |
| `docs/roadmap/.../migration-plan.md` | ~120 | 0 (new) |
| `docs/roadmap/.../session-06-handoff.md` | ~80 | 0 (new) |
| **Total** | **~720** | **~30** |
