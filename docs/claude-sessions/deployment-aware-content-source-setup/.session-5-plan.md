# Session 05 Implementation Plan -- Onboarding and Settings UX

## Goal

Make onboarding and settings deployment-aware so desktop users see local vault
setup first while self-host and cloud users see a linked remote-sync flow first.
Replace service-account-key inputs with a connector link/status/disconnect UX
that matches the backend contract from Sessions 03--04.

---

## Current State (What Exists)

### Backend (ready -- no changes needed this session)
- **Connector routes** (`routes/connectors.rs`): link, callback, status, disconnect
- **Storage layer** (`storage/watchtower/connections.rs`): Connection struct with
  `id`, `connector_type`, `account_email`, `display_name`, `status`, `metadata_json`,
  `created_at`, `updated_at`. Credentials intentionally excluded from default queries.
- **DriveAuthStrategy** (`source/google_drive/mod.rs`): dual-auth dispatch
- **ConnectionBroken** error + Watchtower handling
- **ConnectorConfig in AppState** (`state.rs`): shared OAuth config
- **DeploymentCapabilities** (`config/types.rs`): `preferred_source_default` field
  already returns `"local_fs"` for Desktop, `"google_drive"` for SelfHost/Cloud

### Frontend (needs work)
- **`api.ts`**: Has `DeploymentCapabilities` type with `preferred_source_default`,
  `TuitbotConfig` type with `connection_id` on sources and `connectors` section.
  Missing: connector API methods.
- **`runtime.ts`**: Loads capabilities. Bug: `DESKTOP_DEFAULTS` lacks
  `preferred_source_default` field.
- **`onboarding.ts`**: Hardcoded `source_type: 'local_fs'` default. Has
  `service_account_key` field. Missing: `connection_id` field.
- **`SourcesStep.svelte`**: Flat source-type selector, service-account-key text
  input for Google Drive. No deployment-aware default, no connector flow.
- **`ContentSourcesSection.svelte`**: Same service-account-key UI pattern.
  No connector status/link/disconnect.
- **`+page.svelte` (onboarding)**: Submit builds `content_sources` with
  `service_account_key`. No `connection_id` reference.
- **`ReviewStep.svelte`**: Does not display content source config in review.
- **No connector store exists.**

---

## Files to Create/Modify

### New Files (2)
1. `dashboard/src/lib/stores/connectors.ts` -- Connector state management
2. `dashboard/src/lib/components/onboarding/DriveConnectCard.svelte` -- Reusable
   Drive connect/status component for onboarding and settings

### Modified Files (7)
3. `dashboard/src/lib/api.ts` -- Add connector API methods + Connection type
4. `dashboard/src/lib/stores/runtime.ts` -- Fix DESKTOP_DEFAULTS missing field
5. `dashboard/src/lib/stores/onboarding.ts` -- Replace service_account_key with
   connection_id; add deployment-aware default
6. `dashboard/src/lib/components/onboarding/SourcesStep.svelte` -- Mode-aware
   layout; connector flow replaces service-account inputs
7. `dashboard/src/routes/onboarding/+page.svelte` -- Update submit to use
   connection_id; add preferred_source_default initialization
8. `dashboard/src/routes/(app)/settings/ContentSourcesSection.svelte` -- Connector
   link/status/disconnect UI; remove service-account-key input
9. `dashboard/src/lib/components/onboarding/ReviewStep.svelte` -- Show content
   source summary (source type, connected account or vault path)

### Documentation Files (2)
10. `docs/roadmap/deployment-aware-content-source-setup/frontend-flow.md`
11. `docs/roadmap/deployment-aware-content-source-setup/session-05-handoff.md`

---

## Design Decisions

### KD1: Connector store as a standalone module (not embedded in settings store)

The settings store (`settings.ts`) manages the TOML config lifecycle (load, draft,
validate, save). Connector state (active connections, link flow progress) is
separate from the config and has its own API surface. A standalone
`connectors.ts` store avoids coupling the OAuth flow to the save/discard
config draft pattern.

The connector store will expose:
- `connections` (writable): list of active connections
- `linkingState` (writable): `'idle' | 'linking' | 'success' | 'error'`
- `linkError` (writable): error message string or null
- `loadConnections()`: fetch from GET /status
- `startLink(force?)`: POST /link, open popup, listen for postMessage
- `disconnect(id)`: DELETE /{id}, refresh list

### KD2: DriveConnectCard as a shared component

Both the onboarding SourcesStep and the settings ContentSourcesSection need
identical connect/status/disconnect UX for Google Drive. Extract this into a
single `DriveConnectCard.svelte` component that:
- Shows "Connect Google Drive" button when no active connection
- Shows connected account email + "Disconnect" button when linked
- Shows "Reconnect" button when status is expired
- Shows linking spinner during OAuth flow
- Accepts `onconnected(connectionId)` and `ondisconnected()` callbacks

### KD3: Onboarding initializes source_type from preferred_source_default

The onboarding `$effect` in `SourcesStep.svelte` currently only auto-switches
away from local_fs when capabilities disallow it. The new logic will:
1. On mount, read `$capabilities?.preferred_source_default`
2. Set `sourceType` to that value (replacing hardcoded `'local_fs'`)
3. Keep the existing guard that forces google_drive when local_folder is false

This means Desktop users land on local_fs with the Browse button, while
SelfHost/Cloud users land on Google Drive with the Connect button.

### KD4: Self-host local_fs is collapsed/advanced, not hidden

Per the charter, SelfHost users should still be able to configure local_fs
as an advanced option. The UI will show local_fs under an expandable
"Advanced: Local Server Folder" section (collapsed by default) when
the deployment mode is `self_host`. Cloud mode continues to hide local_fs
entirely.

### KD5: Onboarding submit uses connection_id instead of service_account_key

When the user completes the Google Drive link during onboarding, the
`connection_id` returned by the backend is stored in the onboarding store.
The submit function builds the `content_sources` payload with `connection_id`
and omits `service_account_key`. This matches the new Watchtower priority
(connection_id > service_account_key > skip).

### KD6: Folder selection deferred to settings (MVP scope)

The backend's Google Drive provider uses a `folder_id` to scope file listing.
During onboarding, the user can optionally enter a folder ID after connecting.
Full folder browsing (list shared drives / folders via API) is out of scope
for this session -- it requires additional Google Drive API integration. The
input field remains a text field with a hint about where to find the folder ID
in the Google Drive URL.

### KD7: postMessage validation for connector callback

The OAuth callback page (`connectors.rs:321-336`) posts a message via
`window.opener.postMessage(...)`. The frontend listener must:
- Check `event.origin` matches the expected server origin
- Check `event.data.type === 'connector_linked'`
- Extract `event.data.id` as the new connection_id

This prevents cross-origin injection attacks.

---

## Implementation Order

### Phase 1: Foundation (API + Store + Runtime fix)

**Step 1.1: Add Connection type and connector API methods to api.ts**

Location: `dashboard/src/lib/api.ts`

Add after the existing types section:
```typescript
// --- Connector types ---

export interface Connection {
    id: number;
    connector_type: string;
    account_email: string | null;
    display_name: string | null;
    status: string;
    metadata_json: string;
    created_at: string;
    updated_at: string;
}

export interface LinkResponse {
    authorization_url: string;
    state: string;
}

export interface ConnectorStatusResponse {
    connections: Connection[];
}

export interface DisconnectResponse {
    disconnected: boolean;
    id: number;
}
```

Add to the `api` object:
```typescript
connectors: {
    googleDrive: {
        link: (force?: boolean) =>
            request<LinkResponse>(
                `/api/connectors/google-drive/link${force ? '?force=true' : ''}`,
                { method: 'POST' }
            ),
        status: () =>
            request<ConnectorStatusResponse>('/api/connectors/google-drive/status'),
        disconnect: (id: number) =>
            request<DisconnectResponse>(
                `/api/connectors/google-drive/${id}`,
                { method: 'DELETE' }
            ),
    }
}
```

Rationale: All backend endpoints exist. These are thin typed wrappers.

**Step 1.2: Fix DESKTOP_DEFAULTS in runtime.ts**

Location: `dashboard/src/lib/stores/runtime.ts`

Add the missing `preferred_source_default` field to `DESKTOP_DEFAULTS`:
```typescript
const DESKTOP_DEFAULTS: RuntimeCapabilities = {
    deployment_mode: 'desktop',
    capabilities: {
        local_folder: true,
        manual_local_path: true,
        google_drive: true,
        inline_ingest: true,
        file_picker_native: false,
        preferred_source_default: 'local_fs'  // <-- add this
    }
};
```

**Step 1.3: Create connectors store**

Location: `dashboard/src/lib/stores/connectors.ts` (NEW)

```typescript
import { writable, derived } from 'svelte/store';
import { api, type Connection } from '$lib/api';

// Writable stores
export const connections = writable<Connection[]>([]);
export const connectionsLoaded = writable(false);
export const linkingState = writable<'idle' | 'linking' | 'success' | 'error'>('idle');
export const linkError = writable<string | null>(null);

// Derived
export const activeGoogleDrive = derived(connections, ($conns) =>
    $conns.find(c => c.connector_type === 'google_drive' && c.status === 'active') ?? null
);
export const expiredGoogleDrive = derived(connections, ($conns) =>
    $conns.find(c => c.connector_type === 'google_drive' && c.status === 'expired') ?? null
);

// Actions
export async function loadConnections(): Promise<void> { ... }
export async function startLink(force?: boolean): Promise<number | null> { ... }
export async function disconnectConnection(id: number): Promise<void> { ... }
```

Key implementation details for `startLink()`:
1. Set `linkingState` to `'linking'`
2. Call `api.connectors.googleDrive.link(force)`
3. Open popup: `window.open(authorization_url, 'tuitbot_connector', 'width=600,height=700')`
4. Listen for `message` event on window
5. Validate origin and message type
6. On success: set `linkingState` to `'success'`, refresh connections, return id
7. On error/timeout: set `linkingState` to `'error'`, set `linkError`
8. Cleanup listener on completion

The listener uses a Promise that resolves when the popup posts back or
rejects after a 5-minute timeout. The popup reference is stored so we can
detect if the user closes it manually.

### Phase 2: Onboarding Store Update

**Step 2.1: Update OnboardingData interface and defaults**

Location: `dashboard/src/lib/stores/onboarding.ts`

Changes:
- Remove `service_account_key` field
- Add `connection_id: number | null` (default: `null`)
- Keep `source_type: string` (default remains `'local_fs'` -- overridden at
  runtime by preferred_source_default)
- Keep `folder_id: string` -- still needed for google_drive sources

```typescript
export interface OnboardingData {
    // ... existing fields ...
    // Content Sources
    source_type: string;
    vault_path: string;
    vault_watch: boolean;
    vault_loop_back: boolean;
    folder_id: string;
    connection_id: number | null;  // replaces service_account_key
    poll_interval_seconds: number;
    // ...
}
```

Default in `createOnboardingStore()`:
```typescript
source_type: 'local_fs',
vault_path: '',
vault_watch: true,
vault_loop_back: true,
folder_id: '',
connection_id: null,
poll_interval_seconds: 300,
```

Also update `reset()` to match.

### Phase 3: Shared Component

**Step 3.1: Create DriveConnectCard component**

Location: `dashboard/src/lib/components/onboarding/DriveConnectCard.svelte` (NEW)

Props:
```typescript
interface Props {
    onconnected?: (connectionId: number, email: string) => void;
    ondisconnected?: () => void;
}
```

Internal state: reads from connector store (`$activeGoogleDrive`,
`$expiredGoogleDrive`, `$linkingState`, `$linkError`).

Renders one of five states:

1. **Idle / No connection**: "Connect Google Drive" button. Clicking calls
   `startLink()` from the store.

2. **Linking in progress**: Spinner + "Waiting for Google authorization..."
   text. Cancel button to abort.

3. **Success / Active connection**: Green badge with account email.
   "Disconnect" button. Calls `ondisconnected()` callback on disconnect.

4. **Expired connection**: Warning badge with account email + "Reconnect"
   button. Reconnect calls `startLink(true)` (force=true to replace).

5. **Error**: Error message + "Try Again" button. Shows `$linkError`.

Visual design follows existing patterns:
- Uses `--color-accent`, `--color-success`, `--color-danger`, `--color-surface`
- Consistent border-radius (8px), font sizes (13-14px)
- Lucide icons: `Cloud`, `Check`, `AlertCircle`, `Loader2`, `Unlink`

### Phase 4: SourcesStep Refactor (Onboarding)

**Step 4.1: Rewrite SourcesStep.svelte**

Location: `dashboard/src/lib/components/onboarding/SourcesStep.svelte`

Major changes:
- Import `DriveConnectCard`
- Import `capabilities`, `deploymentMode` from runtime store
- Import `loadConnections` from connectors store

**Source type initialization** -- Replace hardcoded default with
capability-driven logic:
```typescript
// Initialize source type from capabilities
$effect(() => {
    const pref = $capabilities?.preferred_source_default;
    if (pref && sourceType === 'local_fs' && pref !== 'local_fs') {
        sourceType = pref;
    }
});
```

This only fires once (when capabilities load) and does not override an
explicit user choice because it only triggers when `sourceType` is still
at its default value.

**Layout by deployment mode:**

*Desktop mode:*
- Source type selector (local_fs default, google_drive secondary)
- When local_fs: existing path input + Browse button + toggles (no change)
- When google_drive: DriveConnectCard + folder_id input + poll toggle

*SelfHost mode:*
- Source type selector (google_drive default)
- When google_drive: DriveConnectCard + folder_id input + poll toggle
- When local_fs: shown under "Advanced: Local Server Folder" collapsed section

*Cloud mode:*
- No source type selector (google_drive is the only option)
- DriveConnectCard + folder_id input + poll toggle
- Hint: "Local folders are not available in cloud mode"

**Connector callback integration:**
When DriveConnectCard fires `onconnected(id, email)`:
- Set `connection_id` in onboarding store via `onboardingData.updateField()`
- Clear any existing `service_account_key` (for safety)

When `ondisconnected()`:
- Clear `connection_id` in onboarding store

**Copy updates (Obsidian-friendly):**
- Desktop local_fs label: "Obsidian Vault / Notes Folder"
- Desktop local_fs hint: "Select your Obsidian vault or Markdown notes folder.
  Tuitbot indexes your content for smarter replies and posts."
- Browse button title: "Select Obsidian vault or notes folder"

**Remove service-account-key inputs entirely** from the onboarding flow.
The legacy SA key path is settings-only for existing users (not new onboarding).

**Step 4.2: Update onboarding +page.svelte submit**

Location: `dashboard/src/routes/onboarding/+page.svelte`

Changes to the `submit()` function:

Replace the google_drive branch:
```typescript
// OLD:
if (data.source_type === 'google_drive' && data.folder_id) {
    config.content_sources = {
        sources: [{
            source_type: 'google_drive',
            path: null,
            folder_id: data.folder_id,
            service_account_key: data.service_account_key || null,
            ...
        }]
    };
}

// NEW:
if (data.source_type === 'google_drive' && (data.connection_id || data.folder_id)) {
    config.content_sources = {
        sources: [{
            source_type: 'google_drive',
            path: null,
            folder_id: data.folder_id || null,
            service_account_key: null,
            connection_id: data.connection_id,
            watch: data.vault_watch,
            file_patterns: ['*.md', '*.txt'],
            loop_back_enabled: false,
            poll_interval_seconds: data.poll_interval_seconds || 300,
        }]
    };
}
```

Key: `connection_id` is now the primary field; `service_account_key` is
always null in new onboarding.

**Step 4.3: Update ReviewStep.svelte**

Location: `dashboard/src/lib/components/onboarding/ReviewStep.svelte`

Add a "Content Source" summary section that shows:
- Source type (Local Folder / Google Drive / Not configured)
- For local_fs: vault path
- For google_drive: connected account email (from connector store) or
  "Not connected" + folder ID if set

### Phase 5: Settings ContentSourcesSection Refactor

**Step 5.1: Rewrite ContentSourcesSection.svelte**

Location: `dashboard/src/routes/(app)/settings/ContentSourcesSection.svelte`

This is the largest change. The component needs to:

1. **Load connector state on mount**: Call `loadConnections()` from the
   connectors store alongside `loadCapabilities()`.

2. **Replace service-account-key inputs** with DriveConnectCard when
   `sourceType === 'google_drive'`.

3. **Show connection status in context**: When an active connection exists,
   show the email and a "Linked" badge next to the source type selector.

4. **Handle connect/disconnect callbacks**:
   - On connect: update the draft's `content_sources.sources[0].connection_id`
     via `updateSource()`. Clear `service_account_key`.
   - On disconnect: clear `connection_id` from draft. Note: the user must
     save settings for this to take effect on the Watchtower.

5. **Legacy SA key display**: If the loaded config has a non-null
   `service_account_key` (existing legacy user) AND no `connection_id`,
   show a read-only notice: "Using legacy service account key. Connect a
   Google account to upgrade." Do NOT show the actual key value (it comes
   back as `[redacted]` from the server anyway per Session 02 work).

6. **Deployment-aware source type selector**:
   - Desktop: local_fs first, google_drive second
   - SelfHost: google_drive first, local_fs under "Advanced" toggle
   - Cloud: google_drive only

7. **Folder ID input** remains a text field (same as before) for google_drive
   sources.

8. **Poll interval** remains for google_drive sources.

9. **Watch/LoopBack toggles** remain unchanged for local_fs.

### Phase 6: Validation and Guards

**Step 6.1: Frontend validation in SourcesStep**

- Google Drive without a connection: show warning "Connect your Google Drive
  account to enable automatic syncing. You can skip this step and configure
  it later in Settings."
- Google Drive with connection but no folder_id: show info hint "Without a
  folder ID, Tuitbot will index your entire Drive. You can specify a folder
  later in Settings."

**Step 6.2: Frontend validation in ContentSourcesSection**

- Google Drive with expired connection: show warning banner with "Reconnect"
  action.
- Google Drive with connection_id but connection not found (deleted externally):
  show error + suggest re-linking.
- Save button should not be blocked by connector state -- the Watchtower
  handles missing/expired connections gracefully (Session 04 work).

**Step 6.3: Guard against secret leakage**

- The `Connection` type never includes `encrypted_credentials` (backend
  excludes it from default queries).
- The `service_account_key` is returned as `[redacted]` from GET /settings.
- The frontend never displays raw credentials.
- The DriveConnectCard only shows `account_email` and `status`.

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Popup blocked by browser | OAuth flow fails silently | Detect popup blocked (window.open returns null), show manual fallback with URL copy button |
| postMessage origin mismatch | Callback not received | Use `resolveBaseUrl()` from api.ts for origin check; fallback to polling /status |
| Connector not configured (no GCP credentials) | Link button 400s | Check `$capabilities?.google_drive` before showing connect button; show "Google Drive connector not configured" hint |
| User closes popup before completing OAuth | Linking state stuck | Detect popup closed via interval check on `popup.closed`; reset to idle after 2s |
| Existing service_account_key users confused by new UI | Support burden | Show clear migration banner; legacy path continues to work silently |
| SourcesStep.svelte exceeds 400-line limit | CLAUDE.md violation | Extract DriveConnectCard (shared) and LocalFolderSection (inline) to keep under limit |
| Race condition: connection created during onboarding but submit fails | Orphaned connection row | Acceptable: orphaned connections are harmless and discoverable via settings |

---

## Verification Steps

### Automated checks (quality gates)

```bash
# Rust (should be no-op for this session, but verify no regressions)
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings

# Frontend
cd dashboard && npm run check && npm run build
```

### Manual verification matrix

| Scenario | Expected Behavior |
|----------|-------------------|
| Desktop onboarding | Source type defaults to local_fs; Browse button works; vault path saved |
| Desktop onboarding, switch to Google Drive | DriveConnectCard shows; link flow opens popup; connection_id saved |
| SelfHost onboarding | Source type defaults to google_drive; DriveConnectCard shows |
| SelfHost onboarding, expand Advanced | Local folder path input appears; can enter server-side path |
| Cloud onboarding | Only google_drive shown; no local_fs option; DriveConnectCard shows |
| Settings: existing local_fs user | No change in behavior; path and toggles work |
| Settings: existing SA key user | Legacy notice shown; "Connect" button to upgrade |
| Settings: new connection flow | Link -> popup -> callback -> email shown -> save |
| Settings: disconnect | Click disconnect -> confirm -> connection removed -> draft updated |
| Settings: expired connection | Warning + "Reconnect" button shown |
| Popup blocked | Error message with manual URL fallback |
| Server without GCP config | "Google Drive connector not configured" message |
| Submit without connection | Config saved without content_sources (optional step) |

---

## Exact Order of Operations

1. **api.ts** -- Add Connection type, LinkResponse, ConnectorStatusResponse,
   DisconnectResponse types. Add `api.connectors.googleDrive` methods.

2. **runtime.ts** -- Add `preferred_source_default: 'local_fs'` to DESKTOP_DEFAULTS.

3. **connectors.ts** -- Create new store with loadConnections, startLink,
   disconnectConnection. Include postMessage listener logic.

4. **onboarding.ts** -- Replace `service_account_key: string` with
   `connection_id: number | null`. Update defaults and reset.

5. **DriveConnectCard.svelte** -- Create shared component with five-state UI.

6. **SourcesStep.svelte** -- Rewrite with deployment-aware source type default,
   DriveConnectCard integration, Obsidian-friendly copy, collapsed advanced
   section for SelfHost.

7. **+page.svelte (onboarding)** -- Update submit to use connection_id.

8. **ReviewStep.svelte** -- Add content source summary section.

9. **ContentSourcesSection.svelte** -- Rewrite with DriveConnectCard, remove
   SA key input, add legacy migration banner, deployment-aware layout.

10. **frontend-flow.md** -- Document the complete frontend flow by mode.

11. **session-05-handoff.md** -- Document completed work, decisions, open issues.

12. **Run quality gates** -- cargo fmt/clippy/test + npm run check + npm run build.

---

## File Size Budget

| File | Current Lines | Estimated After | Limit |
|------|--------------|----------------|-------|
| SourcesStep.svelte | 412 | ~350 (extract DriveConnectCard) | 400 |
| ContentSourcesSection.svelte | 465 | ~380 (extract DriveConnectCard) | 400 |
| DriveConnectCard.svelte | NEW | ~200 | 400 |
| connectors.ts | NEW | ~120 | N/A |
| api.ts | 1180 | ~1230 | N/A (not Svelte) |
| onboarding.ts | 95 | ~85 | N/A |
| runtime.ts | 57 | ~58 | N/A |
| ReviewStep.svelte | 226 | ~270 | 400 |

All Svelte files stay within the 400-line limit. DriveConnectCard extraction
is the key to keeping both SourcesStep and ContentSourcesSection under budget.

---

## Deliverables Checklist

- [ ] `dashboard/src/lib/api.ts` -- Connector types + API methods
- [ ] `dashboard/src/lib/stores/runtime.ts` -- Fix DESKTOP_DEFAULTS
- [ ] `dashboard/src/lib/stores/connectors.ts` -- NEW connector store
- [ ] `dashboard/src/lib/stores/onboarding.ts` -- connection_id field
- [ ] `dashboard/src/lib/components/onboarding/DriveConnectCard.svelte` -- NEW
- [ ] `dashboard/src/lib/components/onboarding/SourcesStep.svelte` -- Refactored
- [ ] `dashboard/src/routes/onboarding/+page.svelte` -- Updated submit
- [ ] `dashboard/src/lib/components/onboarding/ReviewStep.svelte` -- Source summary
- [ ] `dashboard/src/routes/(app)/settings/ContentSourcesSection.svelte` -- Refactored
- [ ] `docs/roadmap/deployment-aware-content-source-setup/frontend-flow.md`
- [ ] `docs/roadmap/deployment-aware-content-source-setup/session-05-handoff.md`
- [ ] Quality gates pass (cargo fmt/clippy/test + npm check/build)
