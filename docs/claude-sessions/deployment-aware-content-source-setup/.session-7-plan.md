# Session 07 Implementation Plan: Validation and Release Readiness

## Objective

Validate the deployment-aware content-source epic end-to-end, fix any
blocking issues, document residual risks, and produce a go/no-go release
report.

---

## Pre-Validation State (from exploration)

### Quality Gates -- Current Status

| Gate | Status | Notes |
|------|--------|-------|
| `cargo fmt --all --check` | PASS | Clean |
| `cargo clippy --workspace -- -D warnings` | PASS | Clean |
| `RUSTFLAGS="-D warnings" cargo test --workspace` | PASS | 1812 pass, 11 ignored, 0 fail |
| `npm run check` (svelte-check) | PASS | 0 errors, 6 warnings (pre-existing, unrelated) |
| `npm run build` | PASS | Static build succeeds |

All quality gates pass as of the planning snapshot. No blocking issues
requiring code fixes.

### Test Coverage by Crate

| Crate | Tests | Notes |
|-------|-------|-------|
| tuitbot-cli | 140 | Includes 10 upgrade wizard tests for new groups |
| tuitbot-core | 1085 | Includes config, connector, crypto, source, storage tests |
| tuitbot-server (unit) | 495 (11 ignored) | Includes connector/settings/API tests |
| tuitbot-server (api_tests) | 52 | Includes 3 backward-compat + connector endpoint tests |
| tuitbot-server (fresh_install_auth) | 8 | Fresh install + claim flow |

---

## Findings from Codebase Exploration

### Finding 1: Expired Connection UI Is Unreachable (Moderate)

**Problem:** `get_connections_by_type()` in `storage/watchtower/connections.rs:146`
filters `WHERE status = 'active'`. The `GET /api/connectors/google-drive/status`
endpoint uses this function. This means the frontend's `expiredGoogleDrive`
derived store (`connectors.ts:17-18`) will never find a match on page load.

**Impact:** When the Watchtower marks a connection as `expired` (after token
revocation), a subsequent page load shows the "Connect" idle state instead of
"Expired -- Reconnect". Users can still reconnect but lose the contextual
nudge.

**Affected files:**
- `crates/tuitbot-core/src/storage/watchtower/connections.rs` (query)
- `crates/tuitbot-server/src/routes/connectors.rs` (status handler)
- `dashboard/src/lib/stores/connectors.ts` (derived store)
- `dashboard/src/lib/components/onboarding/DriveConnectCard.svelte` (expired UI)
- `dashboard/src/routes/(app)/settings/ContentSourcesSection.svelte` (expired warning)

**Decision:** Document as residual risk. Not a release blocker (functional
path works; UX degraded). Fix in follow-up by adding a
`get_all_connections_by_type()` variant or removing the `status = 'active'`
filter from the status endpoint query (since `Connection` struct already
omits secrets).

### Finding 2: postMessage Target Origin Uses Wildcard (Low)

**Problem:** The OAuth callback HTML in `connectors.rs:329` sends
`postMessage(data, "*")` with a wildcard target origin.

**Mitigation already in place:** The frontend receiver (`connectors.ts:77`)
validates the message origin against `resolveBaseUrl()` and
`window.location.origin`. Since the callback page is served by the same
server, the origin will match.

**Decision:** Acceptable. The sensitive data in the message is only the
connection `id` (an integer DB row ID), not a secret. The receiver-side
validation prevents foreign origins from being accepted. Optionally
tighten the sender origin in a follow-up.

### Finding 3: Upgrade Wizard Interactive Credential Prompts (Low)

**Problem:** `prompt_connectors()` in `commands/upgrade/content_sources.rs`
uses `dialoguer::Input` for GCP client ID and secret entry. Terminal input
is not masked.

**Mitigation:** Already documented in Session 06 handoff. The recommended
path is env vars (`TUITBOT_CONNECTORS__GOOGLE_DRIVE__*`) or the dashboard
OAuth flow. The CLI prompts are a convenience escape hatch.

**Decision:** Document as known limitation. Not a blocker.

### Finding 4: All Charter Decisions Are Implemented

| Charter Decision | Status | Verification |
|-----------------|--------|--------------|
| D1: Mode-specific defaults | Implemented | `DeploymentMode::capabilities()`, capability tests |
| D2: Connector model | Implemented | `connections` table, CRUD, `RemoteConnector` trait |
| D3: OAuth 2.0 PKCE flow | Implemented | 4 connector routes, PKCE tests, wiremock tests |
| D4: Legacy boundaries | Implemented | `connection_id` > `service_account_key` > skip |
| D5: Security rules | Implemented | SA key redaction, Connection struct excludes secrets, AES-256-GCM |
| D6: Capability reporting | Implemented | `/api/settings/status` returns capabilities |

### Finding 5: Secret Handling Is Sound

| Surface | Check | Result |
|---------|-------|--------|
| `GET /api/settings` response | `service_account_key` | Redacted to `"[redacted]"` |
| `GET /api/connectors/google-drive/status` | `encrypted_credentials` | Omitted from `Connection` struct |
| Server log messages | Secrets in tracing calls | No secrets logged (only error descriptions) |
| Frontend TypeScript types | Secret fields | `api.ts` includes `service_account_key: string \| null` but server always redacts |
| Config file on disk | `connector_key` | Stored with 0600 permissions |
| `postMessage` callback | Payload content | Only `{ type, connector, id }` -- no tokens |

### Finding 6: All Session Artifacts Are Complete and Coherent

| Artifact | Status |
|----------|--------|
| `charter.md` | Complete (6 design decisions, 7-session plan) |
| `source-connection-contract.md` | Matches implementation |
| `drive-connection-flow.md` | Matches connector routes |
| `watchtower-sync-contract.md` | Matches `google_drive/mod.rs` dual-auth |
| `frontend-flow.md` | Matches SourcesStep + ContentSourcesSection |
| `migration-plan.md` | Matches upgrade wizard + config tests |
| Sessions 01-06 handoffs | Complete chain, all open issues resolved |

---

## Files to Create

| File | Purpose |
|------|---------|
| `docs/roadmap/deployment-aware-content-source-setup/release-readiness.md` | Go/no-go release report |
| `docs/roadmap/deployment-aware-content-source-setup/session-07-handoff.md` | Final session handoff |

## Files to Potentially Modify (only if blocking issues found)

No code changes are expected based on the current state. All quality gates
pass. If a blocker is discovered during the verification steps below, the
plan allows for targeted fixes.

---

## Key Design Decisions

### KD1: Release verdict is GO with documented residual risks

**Rationale:** All quality gates pass. All charter decisions are implemented.
All critical paths have test coverage. The expired-connection UI gap
(Finding 1) is a UX polish issue, not a functional or security blocker.
The feature can ship safely with the residual risks documented.

### KD2: Do not fix the expired-connection query in this session

**Rationale:** Changing `get_connections_by_type` to include non-active
statuses would require updating the `status_google_drive` handler, adding
tests, and verifying the frontend handles mixed statuses correctly. This
is additive work beyond the validation scope. Document it as a follow-up
item in the release-readiness report.

### KD3: Do not tighten the postMessage wildcard origin in this session

**Rationale:** The receiver-side validation is sufficient. Tightening the
sender would require dynamically injecting the origin into the callback
HTML, adding complexity. The risk is negligible since the payload contains
only a DB row ID.

---

## Risks and Mitigations

| Risk | Severity | Mitigation |
|------|----------|------------|
| Expired connections invisible in UI after revocation | Moderate | Document in release report; follow-up task |
| `postMessage("*")` wildcard origin | Low | Receiver validates; payload is non-secret |
| CLI credential prompts unmasked | Low | Env vars recommended; documented limitation |
| No end-to-end test with real Google OAuth | Expected | Cannot test real OAuth in CI; PKCE flow fully covered by wiremock |
| `connector_key` file lost during backup/restore | Low | Document in migration plan; key can be regenerated (re-auth required) |

---

## Exact Order of Operations

### Step 1: Run Quality Gates (verify clean state)

```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
cd dashboard && npm run check && npm run build
```

All must pass before proceeding. If any fail, fix the blocker before
continuing.

### Step 2: Verify Critical Path -- Desktop Fresh Setup

**Code-review checklist (no manual testing required; covered by tests):**

1. `config_status_includes_capabilities` (api_tests.rs) -- desktop mode
   returns `local_folder: true`, `file_picker_native: true`,
   `preferred_source_default: "local_fs"`.
2. `deployment_mode_capabilities_desktop` (config/tests.rs) -- confirms
   capability struct.
3. `settings_init_with_connection_id` (api_tests.rs) -- POST /api/settings/init
   with `connection_id` succeeds.
4. `e2e_local_folder_ingest_to_seed_pipeline` (source/tests/integration.rs)
   -- local folder -> ingest -> seed -> draft context.
5. Frontend: `SourcesStep.svelte` initializes `sourceType` from
   `preferred_source_default` (desktop = `local_fs`), shows
   `LocalFolderInput` first.

**Verify:** All referenced tests pass in Step 1 output.

### Step 3: Verify Critical Path -- Self-Host/LAN Fresh Setup

**Code-review checklist:**

1. `config_status_capabilities_match_cloud_mode` (api_tests.rs) -- non-desktop
   modes return `preferred_source_default: "google_drive"`.
2. `deployment_mode_capabilities_self_host` (config/tests.rs) --
   `local_folder: true`, `file_picker_native: false`.
3. Connector endpoint tests: `connector_link_not_configured`,
   `connector_callback_missing_params`, `connector_callback_invalid_state`,
   `connector_callback_is_auth_exempt`, `connector_status_empty`,
   `connector_status_with_connection`, `connector_disconnect_not_found`.
4. Frontend: `SourcesStep.svelte` shows `google_drive` first for
   self-host; local_fs available but not default.
5. LAN mode: `docs/lan-mode.md` content sources section present.

### Step 4: Verify Critical Path -- Cloud Fresh Setup

**Code-review checklist:**

1. `deployment_mode_capabilities_cloud` (config/tests.rs) --
   `local_folder: false`.
2. `validate_local_fs_source_rejected_in_cloud_mode` (config/tests.rs) --
   local_fs source produces validation error.
3. Frontend: `SourcesStep.svelte` shows "Local folder not available"
   notice in cloud mode; forces `google_drive`.

### Step 5: Verify Critical Path -- Legacy Upgrade

**Code-review checklist:**

1. `legacy_sa_key_only_config_still_valid` (config/tests.rs) -- SA-key-only
   configs validate in all deployment modes.
2. `mixed_old_and_new_google_drive_source` (config/tests.rs) -- both auth
   methods coexist.
3. `settings_patch_preserves_legacy_sa_key` (api_tests.rs) -- PATCH
   doesn't destroy SA key.
4. `settings_get_redacts_sa_key_alongside_connection_id` (api_tests.rs) --
   GET redacts SA key, returns connection_id.
5. Upgrade wizard tests: `detect_missing_deployment_mode`,
   `detect_missing_connectors`, `detect_missing_content_sources`,
   `patch_deployment_mode_top_level`, `patch_connectors_section`,
   `patch_content_sources_scaffold`, `detect_legacy_sa_key_notice`.
6. `connection_id_without_sa_key_valid` (config/tests.rs) -- new-style
   config validates.
7. `google_drive_source_no_auth_warns` (config/tests.rs) -- transition
   state (no auth) produces warning, not error.

### Step 6: Verify Secret Handling

**Code-review checklist:**

1. `Connection` struct (`connections.rs:17-28`) omits `encrypted_credentials`.
2. All `get_connection*` queries use explicit column lists excluding
   `encrypted_credentials`.
3. `settings.rs:296-306` redacts `service_account_key` in GET response.
4. `connector_status_with_connection` test asserts `encrypted_credentials`
   is null in response.
5. Server log calls (`connectors.rs`) use `error = %e` format (error
   description, not raw secrets).
6. Frontend `api.ts:465` has `service_account_key` type but server always
   redacts.
7. `postMessage` payload contains only `{ type, connector, id }`.
8. `connector_key` file created with 0600 permissions
   (`crypto.rs:ensure_connector_key`).

### Step 7: Reconcile Roadmap Artifacts with Shipped Code

Review each artifact against the codebase and note any discrepancies:

- `charter.md` vs implementation (D1-D6 all satisfied)
- `source-connection-contract.md` vs `connections.rs` + `types.rs`
- `drive-connection-flow.md` vs `connectors.rs` (routes)
- `watchtower-sync-contract.md` vs `google_drive/mod.rs` (dual-auth)
- `frontend-flow.md` vs `SourcesStep.svelte` + `ContentSourcesSection.svelte`
- `migration-plan.md` vs `commands/upgrade/` + `config/tests.rs`

### Step 8: Write Release Readiness Report

Create `docs/roadmap/deployment-aware-content-source-setup/release-readiness.md`
with:

```markdown
# Release Readiness Report -- Deployment-Aware Content Source Setup

## Verdict: GO

## Quality Gates
(pass/fail table)

## Validation Matrix
(critical path x deployment mode table)

## Secret Handling Audit
(surface x check table)

## Charter Compliance
(D1-D6 status table)

## Residual Risks
1. Expired connection UI unreachable (moderate)
2. postMessage wildcard origin (low)
3. CLI credential prompts unmasked (low)
4. No real-OAuth e2e test (expected)

## Follow-Up Work
1. Add get_all_connections_by_type for status endpoint
2. Optionally tighten postMessage sender origin
3. Consider masking dialoguer credential input

## Test Coverage Summary
(counts by crate)

## Session History
(sessions 01-07 summary)
```

### Step 9: Write Session 07 Handoff

Create `docs/roadmap/deployment-aware-content-source-setup/session-07-handoff.md`
with:

```markdown
# Session 07 Handoff -- Validation and Release Readiness

## Completed Work
1. Quality gates verified (all pass)
2. Critical paths validated (desktop, self-host, cloud, legacy upgrade)
3. Secret handling audited (no leaks found)
4. Roadmap artifacts reconciled (all consistent)
5. Release readiness report published (GO verdict)

## Findings
(findings 1-6 from exploration)

## Release Decision
GO -- feature is ready to ship with documented residual risks.

## Residual Risks
(from release report)

## This Is the Final Session
The deployment-aware content-source epic is complete.
No further sessions are planned.
```

---

## Verification Steps

1. **Before writing deliverables:** Re-run all quality gates to confirm
   clean state.
2. **After writing deliverables:** Verify the two new files exist and are
   well-formed markdown.
3. **Final check:** `git diff --stat` to confirm only the two deliverable
   files were created (no accidental source changes).

---

## Time Estimate Breakdown

| Step | Effort |
|------|--------|
| Quality gates | Run commands, verify output |
| Critical path verification (4 paths) | Code review against test names |
| Secret handling audit | Grep + code review |
| Artifact reconciliation | Read + compare |
| Release readiness report | Write ~100-line markdown |
| Session 07 handoff | Write ~60-line markdown |

Total: Two deliverable files, no code changes expected.
