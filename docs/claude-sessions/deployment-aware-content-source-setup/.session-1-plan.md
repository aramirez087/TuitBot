# Session 1 Implementation Plan: Charter and Source Strategy

## Objective

Audit the current deployment-mode and content-source flow across desktop, self-host, and cloud modes.  Produce two deliverables -- `charter.md` and `session-01-handoff.md` -- that lock the product and technical contract before any code changes begin.

This session is **documentation-only**; no source code, tests, or existing docs are modified.

---

## Current State Analysis

### How deployment modes currently expose content sources

After reading all 12 repository anchor files, here is the status quo:

#### Config model (`config/types.rs`)

- `DeploymentMode` enum: `Desktop` (default), `SelfHost`, `Cloud`.
- `DeploymentCapabilities` is derived per mode:
  - **Desktop**: `local_folder=true, manual_local_path=true, google_drive=true, inline_ingest=true, file_picker_native=true`.
  - **SelfHost**: same as Desktop except `file_picker_native=false`.
  - **Cloud**: `local_folder=false, manual_local_path=false, google_drive=true, inline_ingest=true, file_picker_native=false`.
- `ContentSourceEntry` supports two source types: `"local_fs"` and `"google_drive"`.
- Google Drive requires `service_account_key` (path to JSON key file on server filesystem) and `folder_id`.

#### Google Drive provider (`source/google_drive.rs`)

- Authentication is **service-account JWT** only -- reads a JSON key file from a local path, builds RS256 JWT, exchanges for access token.
- No user-account OAuth flow exists.
- Custom minimal RSA/PKCS#8 implementation (lines 298-677) -- no external crypto crate.
- Token cached in-memory with 60-second expiry margin.

#### Watchtower (`automation/watchtower/mod.rs`)

- Splits configured sources into local (watchable via `notify`) and remote (pollable via API).
- `GoogleDriveProvider` instantiated with `folder_id` + `service_account_key_path`.
- Both local and remote funnel through `ingest_content()`.
- Fallback polling when `notify` watcher fails.

#### Server settings (`routes/settings.rs`)

- `GET /api/settings/status` returns `deployment_mode` and `capabilities` (unauthenticated).
- `POST /api/settings/init` accepts full JSON config, writes TOML, optional passphrase claim.
- `PATCH /api/settings` merges partial JSON into existing TOML.
- No connector/link management endpoints exist.

#### Frontend onboarding (`SourcesStep.svelte`, `onboarding.ts`, `+page.svelte`)

- Default source type is `"local_fs"` regardless of deployment mode.
- Cloud mode auto-switches to `"google_drive"` via `$effect` when `local_folder` is false.
- Self-host users see the same `local_fs`-first flow as desktop, but without native picker -- they type server-side paths manually.
- Google Drive setup requires pasting `folder_id` and `service_account_key` path into text inputs.
- Onboarding assembles config and POSTs to `/api/settings/init`.

#### Frontend settings (`ContentSourcesSection.svelte`)

- Post-onboarding settings mirror the same two-source UI.
- Same auto-switch logic for cloud.
- Same service-account-key text input for Google Drive.

### Identified problems

| # | Problem | Impact |
|---|---------|--------|
| 1 | SelfHost onboarding defaults to `local_fs` and asks for a raw server-side path | Confusing UX for non-technical users; path must be valid on the server, not the browser machine |
| 2 | Google Drive requires a service-account JSON key file on the server filesystem | Complex setup: user must create a GCP project, enable Drive API, create service account, share folder, place key file on server |
| 3 | No user-account OAuth flow for Google Drive | Cannot do "Connect my Google Drive" -- only service-account JWT |
| 4 | No connector abstraction for future remote sources (OneDrive, Dropbox, Notion, etc.) | Adding a new source requires ad-hoc config fields and provider code |
| 5 | `service_account_key` path is stored in TOML and visible in `GET /api/settings` response | Key file path exposed in JSON -- not the secret itself, but still a leak vector |
| 6 | No migration path if config shape changes | Existing `google_drive` configs with `service_account_key` field would break |

---

## Key Design Decisions

### D1: Mode-specific onboarding defaults

| Mode | Primary source in onboarding | Secondary option | Rationale |
|------|------------------------------|------------------|-----------|
| **Desktop** | Local folder (native picker) | Google Drive (linked account) | Users have the vault on their machine |
| **SelfHost** | Google Drive (linked account) | Local folder (server-side path, collapsed/advanced) | Server filesystem is not intuitive from a browser |
| **Cloud** | Google Drive (linked account) | Manual ingest only (no local_fs) | No filesystem access |

Rule: `source_type` default in `onboarding.ts` must be **derived from `deploymentMode`**, not hardcoded to `"local_fs"`.

### D2: Connector model for remote sources

Replace the per-source-type config fields with a generic **connector** abstraction:

```
ConnectorEntry {
    connector_type: String,    // "google_drive", future: "onedrive", "dropbox", "notion"
    connection_id: String,     // references a row in `connections` table
    folder_id: Option<String>, // source-specific locator
    // ... other source-specific fields
}
```

A `connections` table in SQLite stores:
- `id` (PK)
- `connector_type` (e.g., "google_drive")
- `account_email` (display only, for UI)
- `encrypted_credentials` (refresh token, encrypted at rest)
- `status` ("active", "expired", "revoked")
- `created_at`, `updated_at`

API responses never include `encrypted_credentials` -- only `account_email`, `status`, and `connector_type`.

### D3: Google Drive user-account OAuth flow

Replace service-account JWT with **user-account OAuth 2.0 + PKCE**:

1. Frontend calls `POST /api/connectors/google-drive/link` -- server generates `state` + PKCE `code_verifier`, stores them, returns `authorization_url`.
2. User opens URL, grants Drive read-only access, Google redirects to local callback.
3. Callback handler exchanges authorization code for access + refresh tokens.
4. Server stores refresh token (encrypted), caches access token in memory.
5. Watchtower's `GoogleDriveProvider` uses the stored refresh token instead of a service-account key.

This matches the existing X API auth pattern (`tuitbot auth` does OAuth 2.0 PKCE already).

### D4: Legacy migration boundaries

| Existing config | Migration path |
|-----------------|---------------|
| `local_fs` with `path` field | **No change needed** -- fully preserved. Desktop and SelfHost continue to support it. |
| `google_drive` with `service_account_key` + `folder_id` | **Preserved at runtime** -- the old `GoogleDriveProvider` JWT path remains as a fallback. New installs use linked accounts. A config upgrade tool (`tuitbot upgrade-config`) can be added in Session 06. |
| `service_account_key` field in TOML | **Not deleted** -- old field is accepted during deserialization (serde `default`), but new UIs never write it. Docs recommend migrating to linked account. |

Zero breakage policy: existing configs must continue to work without user intervention after upgrade.

### D5: Security rules

1. `encrypted_credentials` column never returned in any API response.
2. `service_account_key` file path (legacy) redacted to `"[redacted]"` in `GET /api/settings` response.
3. Refresh tokens encrypted at rest using a per-instance key derived from the passphrase hash (or a separate random key stored in `~/.tuitbot/connector_key`).
4. Access tokens cached in memory only -- never persisted.
5. Log messages must not include tokens, keys, or credentials -- use `tracing::field::debug` with redacting wrappers.

### D6: Capability reporting extension

Add `preferred_source_default` to `DeploymentCapabilities`:

```rust
pub struct DeploymentCapabilities {
    // ... existing fields ...
    /// The recommended default source type for onboarding.
    pub preferred_source_default: String,  // "local_fs" or "google_drive"
}
```

Desktop returns `"local_fs"`, SelfHost and Cloud return `"google_drive"`.

The frontend reads this field to set the initial `source_type` in the onboarding store, replacing the hardcoded `"local_fs"` default.

---

## Implementation Slices (Sessions 2-7)

### Session 02: Config and Credential Model (Backend)

**Files to create/modify:**
- `crates/tuitbot-core/src/config/types.rs` -- Add `preferred_source_default` to `DeploymentCapabilities`; add `connection_id` to `ContentSourceEntry`; keep `service_account_key` as `Option` for backward compat
- `crates/tuitbot-core/src/config/mod.rs` -- Update validation to accept both legacy and new shapes
- `crates/tuitbot-core/src/config/tests.rs` -- Test legacy deserialization, new shape, and capability reporting
- `migrations/NNNN_create_connections_table.sql` -- Create `connections` table
- `crates/tuitbot-core/src/storage/watchtower/mod.rs` -- Add CRUD for `connections` table
- `crates/tuitbot-server/src/routes/settings.rs` -- Redact `service_account_key` in GET responses
- `dashboard/src/lib/api.ts` -- Add TypeScript types for updated capabilities

**Deliverables:**
- `docs/roadmap/deployment-aware-content-source-setup/source-connection-contract.md`
- `docs/roadmap/deployment-aware-content-source-setup/session-02-handoff.md`

### Session 03: Drive Connection Backend (Backend)

**Files to create/modify:**
- `crates/tuitbot-core/src/source/connector/` -- New module directory: `mod.rs` (trait), `google_drive.rs` (OAuth flow logic)
- `crates/tuitbot-core/src/source/connector/crypto.rs` -- Credential encryption/decryption helpers
- `crates/tuitbot-server/src/routes/connectors.rs` -- New file: `POST /api/connectors/google-drive/link`, `POST /api/connectors/google-drive/callback`, `GET /api/connectors/google-drive/status`, `DELETE /api/connectors/google-drive`
- `crates/tuitbot-server/src/routes/mod.rs` -- Register connector routes
- `crates/tuitbot-server/src/lib.rs` -- Wire routes
- `crates/tuitbot-server/tests/api_tests.rs` -- Connector endpoint tests

**Deliverables:**
- `docs/roadmap/deployment-aware-content-source-setup/drive-connection-flow.md`
- `docs/roadmap/deployment-aware-content-source-setup/session-03-handoff.md`

### Session 04: Watchtower Provider Refactor (Backend)

**Files to create/modify:**
- `crates/tuitbot-core/src/source/google_drive.rs` -- Add constructor from `connection_id` (loads refresh token from DB, uses user-account OAuth instead of service-account JWT); keep old constructor as legacy fallback
- `crates/tuitbot-core/src/automation/watchtower/mod.rs` -- When building `GoogleDriveProvider`, check for `connection_id` first, fall back to legacy `service_account_key`; add token refresh retry logic
- `crates/tuitbot-core/src/source/google_drive.rs` (tests) -- Test both legacy and linked-account code paths

**Deliverables:**
- `docs/roadmap/deployment-aware-content-source-setup/session-04-handoff.md`

### Session 05: Onboarding and Settings UX (Frontend)

**Files to create/modify:**
- `dashboard/src/lib/stores/onboarding.ts` -- Default `source_type` derived from `deploymentMode` (via `preferred_source_default`)
- `dashboard/src/lib/stores/runtime.ts` -- Surface `preferred_source_default` from capabilities
- `dashboard/src/lib/components/onboarding/SourcesStep.svelte` -- Desktop: native folder picker first, "Connect Google Drive" as secondary. SelfHost/Cloud: "Connect Google Drive" button first, local folder as advanced/collapsed. Remove service-account-key text input; replace with "Connect" button that calls link endpoint.
- `dashboard/src/routes/(app)/settings/ContentSourcesSection.svelte` -- Same refactor as SourcesStep; show connected account status, disconnect button
- `dashboard/src/lib/api.ts` -- Add connector API client methods
- `dashboard/src/routes/onboarding/+page.svelte` -- No structural changes expected; `submit()` may need to reference `connection_id` instead of `service_account_key`

**Deliverables:**
- `docs/roadmap/deployment-aware-content-source-setup/session-05-handoff.md`

### Session 06: Desktop Compatibility and Migration (Backend + Frontend)

**Files to create/modify:**
- `crates/tuitbot-cli/src/commands/` -- Add `upgrade-config` subcommand that migrates legacy Drive configs to linked-account format
- `docs/configuration.md` -- Update content sources section with new connector flow
- `docs/architecture.md` -- Update Content Source Pipeline section
- Source tests: add integration tests for legacy config -> new provider path

**Deliverables:**
- `docs/roadmap/deployment-aware-content-source-setup/session-06-handoff.md`

### Session 07: Validation and Release Readiness

**Files to verify:**
- Full CI pass: `cargo fmt --all && cargo fmt --all --check`, `RUSTFLAGS="-D warnings" cargo test --workspace`, `cargo clippy --workspace -- -D warnings`
- Dashboard: `cd dashboard && npm run check && npm run build`
- E2E flow: onboarding on each mode, settings edit, Drive connect/disconnect
- Migration: existing config files with legacy shape load correctly

**Deliverables:**
- `docs/roadmap/deployment-aware-content-source-setup/release-readiness.md`

---

## Files to Create in This Session

Only two documentation files, both under `docs/roadmap/deployment-aware-content-source-setup/`:

### 1. `docs/roadmap/deployment-aware-content-source-setup/charter.md`

Contents:
- Problem statement (6 issues identified above)
- Design decisions D1-D6 with rationale
- Mode-specific UX table
- Connector model diagram
- Security rules
- Migration boundaries
- Implementation slice overview (sessions 2-7)

### 2. `docs/roadmap/deployment-aware-content-source-setup/session-01-handoff.md`

Contents:
- Completed work: full audit of 12 anchor files, charter produced
- Open issues: none blocking Session 02
- Exact inputs for Session 02: charter.md, the source-connection-contract deliverable format, and the named files from Session 02 slice

---

## Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Google OAuth requires registered redirect URI | High | Blocks link flow | Document required GCP console setup; provide `http://localhost:3001/api/connectors/google-drive/callback` as default redirect URI. For LAN mode, allow configurable redirect via env var. |
| Credential encryption adds complexity | Medium | Security vs. usability tradeoff | Start with a simple approach: random key in `~/.tuitbot/connector_key` with `0600` permissions, AES-256-GCM via `aes-gcm` crate. Defer passphrase-derived keys to a later iteration. |
| Custom RSA implementation in google_drive.rs | Low (legacy only) | Maintenance burden | Keep it for legacy service-account path; new user-account path uses standard `reqwest` POST for token exchange -- no custom crypto needed. |
| Large frontend refactor in SourcesStep.svelte | Medium | Regression risk | Session 05 should keep the existing local_fs branch mostly intact, only adding the connector flow as a parallel branch. |
| Breaking existing configs | High impact if it happens | User trust | Zero-breakage policy: old fields always deserialize; old providers always instantiate. `#[serde(default)]` on all new fields. |

---

## Verification Steps

Since this session is documentation-only, verification is limited to:

1. **Charter completeness**: All 5 tasks from the session instructions are addressed:
   - [x] Task 1: Document current exposure by mode (Current State Analysis section)
   - [x] Task 2: Define target UX by mode (D1: Mode-specific onboarding defaults)
   - [x] Task 3: Decide connector model (D2, D3: Connector model + OAuth flow)
   - [x] Task 4: Lock migration boundaries (D4: Legacy migration)
   - [x] Task 5: Break into slices with named files (Implementation Slices section)

2. **No code changes**: Verify with `git diff` that no source files were modified.

3. **Both deliverables exist**:
   - `docs/roadmap/deployment-aware-content-source-setup/charter.md`
   - `docs/roadmap/deployment-aware-content-source-setup/session-01-handoff.md`

---

## Exact Order of Operations

1. Create directory `docs/roadmap/deployment-aware-content-source-setup/`.
2. Write `charter.md` incorporating:
   - Current state audit (from this plan's analysis)
   - All 6 design decisions with rationale
   - Mode-specific UX table
   - Connector model description
   - Security rules
   - Migration boundaries with zero-breakage policy
   - Implementation slice summary referencing sessions 2-7
3. Write `session-01-handoff.md` with:
   - Completed: charter locked, all anchor files audited
   - Open issues: none blocking
   - Next session inputs: charter.md path, Session 02 file list, source-connection-contract deliverable format
4. Verify no source code was modified: `git diff --stat` should show only new files under `docs/roadmap/`.
5. Done.
