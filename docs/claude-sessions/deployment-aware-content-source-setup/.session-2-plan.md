# Session 02 Implementation Plan -- Config and Credential Model

## Objective

Implement the shared configuration, capability, and persistence contract that
makes remote account-linked sync the default non-desktop path. This session
establishes the stable connector contract that sessions 03-07 build upon.

---

## 1. Files to Create/Modify

### Files to modify (7)

| File | Change summary |
|------|----------------|
| `crates/tuitbot-core/src/config/types.rs` | Add `preferred_source_default` to `DeploymentCapabilities`; add `connection_id` to `ContentSourceEntry`; add `ConnectorConfig` section |
| `crates/tuitbot-core/src/config/mod.rs` | Export new types (`ConnectorConfig`) |
| `crates/tuitbot-core/src/config/validation.rs` | Validate `connection_id` references for remote sources; validate connector config |
| `crates/tuitbot-core/src/config/env_overrides.rs` | Add env overrides for `TUITBOT_CONNECTORS__GOOGLE_DRIVE__CLIENT_ID` and `CLIENT_SECRET` |
| `crates/tuitbot-core/src/config/tests.rs` | Add tests for new config shape, legacy compatibility, capability reporting |
| `crates/tuitbot-core/src/storage/watchtower/mod.rs` | Add CRUD functions for `connections` table |
| `crates/tuitbot-core/src/storage/reset.rs` | Add `connections` to `TABLES_TO_CLEAR` in FK-safe order |
| `crates/tuitbot-server/src/routes/settings.rs` | Redact `service_account_key` in `GET /api/settings` response |
| `dashboard/src/lib/api.ts` | Add `preferred_source_default` to `DeploymentCapabilities`; add `connection_id` to source entry type |

### Files to create (3)

| File | Purpose |
|------|---------|
| `migrations/20260228000020_connections.sql` | Create `connections` table |
| `docs/roadmap/deployment-aware-content-source-setup/source-connection-contract.md` | Contract documentation |
| `docs/roadmap/deployment-aware-content-source-setup/session-02-handoff.md` | Handoff for session 03 |

---

## 2. Key Design Decisions

### D-2.1: `preferred_source_default` field

Add a `preferred_source_default: String` field to `DeploymentCapabilities`:

```rust
pub struct DeploymentCapabilities {
    pub local_folder: bool,
    pub manual_local_path: bool,
    pub google_drive: bool,
    pub inline_ingest: bool,
    pub file_picker_native: bool,
    pub preferred_source_default: String,  // NEW
}
```

Values per mode:
- `Desktop` -> `"local_fs"`
- `SelfHost` -> `"google_drive"`
- `Cloud` -> `"google_drive"`

**Rationale:** This shifts the default source-type decision from a hardcoded
frontend string to a backend-driven capability, per charter decision D1/D6.

### D-2.2: `connection_id` on `ContentSourceEntry`

Add `connection_id: Option<i64>` to `ContentSourceEntry` with `#[serde(default)]`:

```rust
pub struct ContentSourceEntry {
    // ... existing fields ...
    #[serde(default)]
    pub connection_id: Option<i64>,
}
```

**Legacy safety:** Existing TOML configs lacking this field will deserialize
with `connection_id = None`, triggering the legacy service-account-key path
in the Watchtower (session 04). Zero breakage per charter D4.

### D-2.3: Connector configuration in TOML

Add a new optional top-level config section for connector OAuth credentials.
These are *application-level* credentials (GCP OAuth client ID/secret), not
user credentials. They define which GCP project the OAuth flow uses.

```rust
#[derive(Debug, Clone, Default, Deserialize, Serialize)]
pub struct ConnectorConfig {
    #[serde(default)]
    pub google_drive: GoogleDriveConnectorConfig,
}

#[derive(Debug, Clone, Default, Deserialize, Serialize)]
pub struct GoogleDriveConnectorConfig {
    /// GCP OAuth client ID for user-account Drive linking.
    #[serde(default)]
    pub client_id: Option<String>,
    /// GCP OAuth client secret.
    #[serde(default)]
    pub client_secret: Option<String>,
    /// Override redirect URI (default: http://localhost:3001/api/connectors/google-drive/callback).
    #[serde(default)]
    pub redirect_uri: Option<String>,
}
```

In `Config`:
```rust
pub struct Config {
    // ... existing fields ...
    #[serde(default)]
    pub connectors: ConnectorConfig,
}
```

**Rationale:** Follows the existing config precedence pattern
(CLI > env > TOML > defaults). Environment variables:
- `TUITBOT_CONNECTORS__GOOGLE_DRIVE__CLIENT_ID`
- `TUITBOT_CONNECTORS__GOOGLE_DRIVE__CLIENT_SECRET`
- `TUITBOT_CONNECTORS__GOOGLE_DRIVE__REDIRECT_URI`

This mirrors the existing `x_api.client_id` / `x_api.client_secret` pattern.
Self-hosted operators configure these once; desktop installs can bundle
embedded defaults via env vars in the Tauri sidecar.

### D-2.4: `connections` table schema

```sql
CREATE TABLE IF NOT EXISTS connections (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    account_id TEXT NOT NULL DEFAULT '00000000-0000-0000-0000-000000000000',
    connector_type TEXT NOT NULL,           -- "google_drive", future: "onedrive", etc.
    account_email TEXT,                     -- Display only
    display_name TEXT,                      -- e.g. "My Google Drive"
    encrypted_credentials BLOB,            -- Refresh token, encrypted at rest
    status TEXT NOT NULL DEFAULT 'active',  -- "active", "expired", "revoked"
    metadata_json TEXT NOT NULL DEFAULT '{}', -- Non-secret connector metadata
    created_at TEXT NOT NULL DEFAULT (datetime('now')),
    updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);

CREATE INDEX IF NOT EXISTS idx_connections_type_status
    ON connections(connector_type, status);
```

**Rationale:** Matches charter D2. `encrypted_credentials` is a BLOB for
AES-256-GCM encrypted refresh tokens (session 03 implements encryption).
`metadata_json` stores non-secret config (e.g., Drive folder preferences)
that can safely appear in API responses.

### D-2.5: Redacting `service_account_key` in GET responses

In `get_settings()`, after serializing config to JSON, walk the
`content_sources.sources` array and replace any non-null
`service_account_key` value with the string `"[redacted]"`.

**Rationale:** Charter D5 rule 2. This is a minimal change to the settings
handler -- no business logic, just response sanitization.

### D-2.6: CRUD placement for connections

Add connection CRUD functions to `crates/tuitbot-core/src/storage/watchtower/mod.rs`
alongside the existing `source_contexts` CRUD. These are logically related --
connections feed into source contexts -- and co-location avoids a new module
that would be <100 lines.

If the file grows past 500 lines after adding ~120 lines of connection CRUD,
extract into `crates/tuitbot-core/src/storage/watchtower/connections.rs` as a
submodule with a thin re-export from `mod.rs`.

---

## 3. Order of Operations

### Step 1: Create migration file

**File:** `migrations/20260228000020_connections.sql`

Create the `connections` table with the schema from D-2.4.

**Why first:** All storage CRUD code and tests depend on the table existing.
The migration numbering follows the last migration (`20260228000019`).

### Step 2: Update config types

**File:** `crates/tuitbot-core/src/config/types.rs`

1. Add `preferred_source_default: String` to `DeploymentCapabilities`.
2. Update `DeploymentMode::capabilities()` to populate the new field.
3. Add `connection_id: Option<i64>` with `#[serde(default)]` to `ContentSourceEntry`.
4. Add `ConnectorConfig` and `GoogleDriveConnectorConfig` structs.

**Ordering note:** These are the lowest-level type changes. Everything else
depends on them compiling.

### Step 3: Update config module exports

**File:** `crates/tuitbot-core/src/config/mod.rs`

1. Add `ConnectorConfig` and `GoogleDriveConnectorConfig` to the `pub use types::` block.
2. Add `connectors: ConnectorConfig` field to `Config` with `#[serde(default)]`.

### Step 4: Update env overrides

**File:** `crates/tuitbot-core/src/config/env_overrides.rs`

Add env var handling for:
- `TUITBOT_CONNECTORS__GOOGLE_DRIVE__CLIENT_ID`
- `TUITBOT_CONNECTORS__GOOGLE_DRIVE__CLIENT_SECRET`
- `TUITBOT_CONNECTORS__GOOGLE_DRIVE__REDIRECT_URI`

Follow the exact pattern used by `TUITBOT_X_API__CLIENT_ID`.

### Step 5: Update validation

**File:** `crates/tuitbot-core/src/config/validation.rs`

Add validation rule: if a `ContentSourceEntry` has `source_type = "google_drive"`
and `connection_id.is_some()`, then `service_account_key` should be `None`
(warn if both are set -- but don't block, since session 04 handles precedence).

No other validation changes needed at this point. The connector OAuth config
is optional -- validation for it happens at link-time (session 03).

### Step 6: Add connection CRUD to storage

**File:** `crates/tuitbot-core/src/storage/watchtower/mod.rs`

Add these functions:

```rust
/// Row type for connections.
pub struct Connection {
    pub id: i64,
    pub account_id: String,
    pub connector_type: String,
    pub account_email: Option<String>,
    pub display_name: Option<String>,
    pub status: String,
    pub metadata_json: String,
    pub created_at: String,
    pub updated_at: String,
    // Note: encrypted_credentials intentionally excluded from this struct
}

/// Insert a new connection (without credentials -- session 03 adds encryption).
pub async fn insert_connection(
    pool: &DbPool,
    connector_type: &str,
    account_email: Option<&str>,
    display_name: Option<&str>,
) -> Result<i64, StorageError>

/// Get a connection by ID (never returns encrypted_credentials).
pub async fn get_connection(
    pool: &DbPool,
    id: i64,
) -> Result<Option<Connection>, StorageError>

/// List active connections.
pub async fn get_connections(
    pool: &DbPool,
) -> Result<Vec<Connection>, StorageError>

/// Update connection status.
pub async fn update_connection_status(
    pool: &DbPool,
    id: i64,
    status: &str,
) -> Result<(), StorageError>

/// Delete a connection.
pub async fn delete_connection(
    pool: &DbPool,
    id: i64,
) -> Result<(), StorageError>
```

Key security constraint: The `Connection` struct intentionally omits
`encrypted_credentials`. It is never selected in queries. Only the
connector module (session 03) will read credentials via a separate
dedicated function.

### Step 7: Update factory reset

**File:** `crates/tuitbot-core/src/storage/reset.rs`

Add `"connections"` to `TABLES_TO_CLEAR`. It must appear *before*
`"source_contexts"` in the array since source entries may reference
connections (though no FK constraint exists yet -- defensive ordering).
Place it after `"content_nodes"` and before `"source_contexts"`.

Also update the doc comment table count from "30" to "31".

### Step 8: Redact service_account_key in GET /api/settings

**File:** `crates/tuitbot-server/src/routes/settings.rs`

In `get_settings()`, after serializing the config to `serde_json::Value`,
add a redaction pass:

```rust
// Redact service_account_key from response (charter D5, rule 2)
if let Some(sources) = json
    .get_mut("content_sources")
    .and_then(|cs| cs.get_mut("sources"))
    .and_then(|s| s.as_array_mut())
{
    for source in sources {
        if let Some(key) = source.get_mut("service_account_key") {
            if !key.is_null() {
                *key = serde_json::Value::String("[redacted]".to_string());
            }
        }
    }
}
```

### Step 9: Update frontend types

**File:** `dashboard/src/lib/api.ts`

1. Add `preferred_source_default: string` to `DeploymentCapabilities` interface.
2. Add `connection_id: number | null` to the content source entry type in
   `TuitbotConfig`.

These are additive -- existing code won't break.

### Step 10: Add config tests

**File:** `crates/tuitbot-core/src/config/tests.rs`

Add these test cases:

1. **`preferred_source_default_desktop`** -- Desktop capabilities return `"local_fs"`.
2. **`preferred_source_default_self_host`** -- SelfHost capabilities return `"google_drive"`.
3. **`preferred_source_default_cloud`** -- Cloud capabilities return `"google_drive"`.
4. **`preferred_source_default_json_roundtrip`** -- Capabilities serialize to JSON with the new field.
5. **`content_source_connection_id_defaults_to_none`** -- Existing TOML without `connection_id` parses as `None`.
6. **`content_source_connection_id_roundtrip`** -- TOML with `connection_id = 42` round-trips.
7. **`legacy_google_drive_config_still_parses`** -- Existing TOML with `service_account_key` + `folder_id` (no `connection_id`) parses successfully.
8. **`connector_config_optional`** -- Config without `[connectors]` section uses defaults.
9. **`connector_config_toml_roundtrip`** -- TOML with `[connectors.google_drive]` section round-trips.
10. **`connector_config_env_overrides`** -- `TUITBOT_CONNECTORS__GOOGLE_DRIVE__CLIENT_ID` is picked up.
11. **`connection_id_json_patch_roundtrip`** -- JSON patch with `connection_id` round-trips to TOML.

### Step 11: Add storage tests for connections

**File:** `crates/tuitbot-core/src/storage/watchtower/tests.rs`

Add these test cases:

1. **`migration_creates_connections_table`** -- Verify `connections` table exists.
2. **`insert_and_get_connection`** -- Insert, retrieve, verify fields.
3. **`get_connections_returns_active_only`** -- List filters by `status = 'active'`.
4. **`update_connection_status_works`** -- Change status to `"expired"`, verify.
5. **`delete_connection_works`** -- Delete, verify no longer returned.
6. **`connection_struct_excludes_credentials`** -- Verify `Connection` struct has no credentials field (compile-time guarantee via struct definition).

### Step 12: Update API integration test

**File:** `crates/tuitbot-server/tests/api_tests.rs`

1. **`config_status_includes_preferred_source_default`** -- Verify the new
   field appears in `GET /api/settings/status` response.
2. **`settings_get_redacts_service_account_key`** -- Write a config with
   `service_account_key`, verify `GET /api/settings` returns `"[redacted]"`.

### Step 13: Write contract documentation

**File:** `docs/roadmap/deployment-aware-content-source-setup/source-connection-contract.md`

Document:
- `connections` table schema and column semantics
- `Connection` struct (public API, no credentials)
- `preferred_source_default` values per mode
- `connection_id` field on `ContentSourceEntry`
- Redaction rules for `service_account_key`
- `ConnectorConfig` TOML structure
- Legacy compatibility guarantees

### Step 14: Write session handoff

**File:** `docs/roadmap/deployment-aware-content-source-setup/session-02-handoff.md`

---

## 4. Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Adding `preferred_source_default` to `DeploymentCapabilities` breaks existing JSON consumers | Frontend/tests that assert on exact capability shape fail | Field is additive; existing boolean fields unchanged. Tests updated in step 10. |
| `connection_id` on `ContentSourceEntry` causes TOML serialization of `None` as explicit key | TOML files grow with `connection_id = 0` or similar | `#[serde(default, skip_serializing_if = "Option::is_none")]` on the field |
| New migration breaks existing databases | Users lose data on upgrade | Migration is purely additive (CREATE TABLE IF NOT EXISTS). No ALTER TABLE on existing tables. |
| `Connection` struct accidentally includes credentials in future | Secret leak via API response | Struct definition explicitly excludes `encrypted_credentials`. Code review enforced by convention. Separate `get_connection_credentials()` function in session 03 requires explicit opt-in. |
| `reset.rs` table count mismatch | Factory reset misses new table | Step 7 explicitly adds to the array and updates the count comment. |
| `ConnectorConfig` env vars ignored if TOML section exists | Operator confusion | Env overrides applied *after* TOML load, same as all other env vars. Documented in contract. |
| File size limit: `watchtower/mod.rs` currently ~698 lines | Adding ~120 lines of connection CRUD pushes past 500-line limit | If the file would exceed 500 lines, extract connection CRUD into `watchtower/connections.rs` submodule per CLAUDE.md convention. Currently 698 lines -- already past 500. Must extract to submodule. |

### File size resolution

`watchtower/mod.rs` is already 698 lines (past the 500-line limit). The
correct approach:

1. Create `crates/tuitbot-core/src/storage/watchtower/connections.rs` for
   all new connection CRUD code.
2. Add `mod connections;` and `pub use connections::*;` to `watchtower/mod.rs`.
3. This follows the `commands/settings/` pattern from CLAUDE.md.

---

## 5. Verification Steps

### Build check
```bash
cargo build --workspace
```

### Format and lint
```bash
cargo fmt --all && cargo fmt --all --check
cargo clippy --workspace -- -D warnings
```

### Tests
```bash
RUSTFLAGS="-D warnings" cargo test --workspace
```

### Specific test targets
```bash
# Config tests
cargo test -p tuitbot-core -- config::tests::preferred_source_default
cargo test -p tuitbot-core -- config::tests::content_source_connection_id
cargo test -p tuitbot-core -- config::tests::legacy_google_drive
cargo test -p tuitbot-core -- config::tests::connector_config

# Storage tests
cargo test -p tuitbot-core -- storage::watchtower::tests::migration_creates_connections
cargo test -p tuitbot-core -- storage::watchtower::tests::insert_and_get_connection
cargo test -p tuitbot-core -- storage::watchtower::tests::connection

# Server tests
cargo test -p tuitbot-server -- config_status_includes_preferred
cargo test -p tuitbot-server -- settings_get_redacts
```

### Frontend type check (non-blocking for this session)
```bash
cd dashboard && npm run check
```

---

## 6. Dependency Graph

```
Step 1: migration SQL
  |
  v
Step 2: config types (DeploymentCapabilities, ContentSourceEntry, ConnectorConfig)
  |
  +---> Step 3: config mod.rs exports
  |       |
  |       +---> Step 4: env overrides
  |       |
  |       +---> Step 5: validation
  |
  +---> Step 6: storage CRUD (depends on migration + types)
  |       |
  |       +---> Step 7: factory reset (depends on table name)
  |
  +---> Step 8: settings redaction (depends on types compiling)
  |
  +---> Step 9: frontend types (independent of Rust changes)
  |
  v
Step 10: config tests (depends on steps 2-5)
Step 11: storage tests (depends on steps 1, 6)
Step 12: API tests (depends on steps 8, 2)
  |
  v
Step 13: contract doc (after all code is stable)
Step 14: session handoff (last)
```

Steps 4, 5, 6, 8, 9 can proceed in parallel after step 3.

---

## 7. Exit Criteria Checklist

- [ ] `DeploymentCapabilities` includes `preferred_source_default`
- [ ] `ContentSourceEntry` includes `connection_id: Option<i64>` with serde defaults
- [ ] `ConnectorConfig` section in `Config` for Google Drive OAuth client credentials
- [ ] Env var overrides work for connector config
- [ ] `connections` table created via migration
- [ ] Connection CRUD in storage layer (no credentials in public struct)
- [ ] Factory reset includes `connections` table
- [ ] `GET /api/settings` redacts `service_account_key` to `"[redacted]"`
- [ ] Frontend TypeScript types updated
- [ ] All existing config tests still pass (legacy compatibility)
- [ ] New tests cover: capabilities, connection_id, legacy config, connector config, storage CRUD, API redaction
- [ ] `cargo fmt --all && cargo fmt --all --check` passes
- [ ] `RUSTFLAGS="-D warnings" cargo test --workspace` passes
- [ ] `cargo clippy --workspace -- -D warnings` passes
- [ ] Contract documentation written
- [ ] Session handoff written with inputs for session 03
