## Step 3 — FINALIZE

### Completion Summary

**Files created/modified:**

| File | Change |
|------|--------|
| `crates/tuitbot-mcp/src/state.rs` | Added `granted_scopes: Vec<String>` to `AppState` |
| `crates/tuitbot-mcp/src/lib.rs` | Capture scopes from tokens at startup, pass to `AppState` |
| `crates/tuitbot-mcp/src/tools/manifest.rs` | Added `requires_scopes`, `requires_user_auth`, `requires_elevated_access` to `ToolEntry`; new `x_tool()` helper; 30+ curated X tools annotated with scope metadata |
| `crates/tuitbot-mcp/src/spec/generator.rs` | Populate scope/auth metadata from `EndpointDef` for generated tools |
| `crates/tuitbot-mcp/src/spec/mod.rs` | `MCP_SCHEMA_VERSION` bumped from 1.1 to 1.2 |
| `crates/tuitbot-mcp/src/tools/workflow/capabilities.rs` | Complete rewrite adding `auth`, `scope_analysis`, `endpoint_groups`, `guidance` sections; 12 new tests |
| `crates/tuitbot-mcp/src/server/write.rs` | Pass `granted_scopes` to `get_capabilities` |
| `crates/tuitbot-mcp/src/server/admin.rs` | Pass `granted_scopes` to `get_capabilities` |
| 4 test/benchmark files | Updated call sites with new parameter |
| `roadmap/artifacts/session-06-tool-manifest.json` | Regenerated with new schema |
| `docs/roadmap/x-api-surface-expansion/session-06-handoff.md` | Handoff document |

**Tests run and results:**
- `cargo fmt --all --check` — clean
- `cargo clippy --workspace -- -D warnings` — clean
- `RUSTFLAGS="-D warnings" cargo test --workspace` — all pass
- 12 new capability tests all pass (scope analysis, endpoint groups, auth info, guidance, per-tool metadata)

**Key decisions:**
1. **Scopes stored on `AppState`** rather than re-read from disk — avoids IO in every capability check and keeps state consistent for the session lifetime.
2. **`skip_serializing_if` on new fields** — `requires_scopes` (skip if empty), `requires_user_auth` and `requires_elevated_access` (skip if false). This keeps the manifest compact for non-X tools while being explicit for X API tools.
3. **Endpoint groups computed from spec metadata** — uses `SPEC_ENDPOINTS` to derive per-group scope requirements at runtime. No hardcoded group list.
4. **Guidance engine is deterministic** — evaluates conditions in priority order and returns specific, actionable messages. Falls through to "All systems operational" when nothing is wrong.

**Warnings for next session:**
- The `REQUIRED_SCOPES` constant only covers the 10 scopes Tuitbot requests by default. Extended scopes (list.*, mute.*, block.*, space.*, tweet.moderate.write) are visible in endpoint group availability but won't be granted until the auth flow is updated to request them.
- The manifest snapshot (`session-06-tool-manifest.json`) has been regenerated and will need re-generation if any tools are added/modified.
