# Session 06 Implementation Plan — Responsive & Accessible Polish

**Date:** 2026-02-27
**Session:** 06
**Goal:** Harden the composer UX to premium quality across performance, accessibility, and responsiveness.

---

## Current State Assessment

### File sizes (all exceed or approach limits)
| File | Lines | Limit | Status |
|------|-------|-------|--------|
| `ComposeModal.svelte` | 1311 | 400 | Exceeds by 3.3x — extraction required |
| `ThreadComposer.svelte` | 806 | 400 | Exceeds by 2x — extraction possible but lower priority |
| `CommandPalette.svelte` | 313 | 400 | Within limit |
| `MediaSlot.svelte` | 281 | 400 | Within limit |
| `TweetPreview.svelte` | 170 | 400 | Within limit |

### Accessibility gaps identified
1. **No `:focus-visible` styles anywhere** — zero results across entire dashboard
2. **No `prefers-reduced-motion` media queries** — zero results; 89 transition/animation occurrences across 37 component files
3. **`svelte-ignore a11y_*` directives in compose components:**
   - `ComposeModal.svelte:613` — `a11y_media_has_caption` on video element
   - `MediaSlot.svelte:139` — `a11y_media_has_caption` on video element
   - `CommandPalette.svelte:146` — `a11y_no_static_element_interactions` on backdrop div
4. **No focus trap** — Tab can escape the modal into the underlying page
5. **No focus return** — closing the modal does not return focus to the trigger element
6. **Touch targets undersized:**
   - `close-btn`: 28x28px (below 44px minimum)
   - `focus-btn`: 28x28px
   - `action-btn` (ThreadComposer): 24x24px
   - `remove-card-btn`: 24x24px
   - `remove-media-btn` (ComposeModal): 20x20px
   - `remove-btn` (MediaSlot): 16x16px
   - `notes-close`: 20x20px
   - `drag-handle`: no explicit min-size
7. **Mobile responsiveness:** Only one `@media` breakpoint exists in ComposeModal (768px for thread layout). No mobile styles for tweet mode, footer, header, command palette, or from-notes section.
8. **Card actions hidden by hover-only:** `.card-actions` has `opacity: 0` and only shows on `:hover` or `.focused` — invisible on touch devices.

### Contrast verification (dark theme)
| Token pair | Values | Ratio | WCAG AA |
|------------|--------|-------|---------|
| `--color-text` on `--color-surface` | #e6edf3 on #161b22 | ~12.8:1 | Pass |
| `--color-text-muted` on `--color-surface` | #8b949e on #161b22 | ~4.6:1 | Pass (barely) |
| `--color-text-subtle` on `--color-surface` | #6e7681 on #161b22 | ~3.2:1 | **Fail** (needs 4.5:1) |
| `--color-accent` on `--color-surface` | #58a6ff on #161b22 | ~7.2:1 | Pass |
| `--color-danger` on `--color-surface` | #f85149 on #161b22 | ~5.4:1 | Pass |
| `--color-warning` on `--color-surface` | #d29922 on #161b22 | ~5.8:1 | Pass |

### Contrast verification (light theme)
| Token pair | Values | Ratio | WCAG AA |
|------------|--------|-------|---------|
| `--color-text-subtle` on `--color-surface` | #8b949e on #ffffff | ~3.0:1 | **Fail** |

---

## Design Decisions

| ID | Decision | Rationale |
|----|----------|-----------|
| D6-1 | Extract `FromNotesPanel.svelte` sub-component from ComposeModal | Reduces ComposeModal by ~80 lines. Self-contained section with its own state (notesText, generating). Parent passes mode and callbacks. |
| D6-2 | Create `FocusTrap.svelte` action utility instead of per-component logic | Reusable Svelte action (`use:focusTrap`) wraps any container. Handles Tab/Shift+Tab wrapping at boundaries. Can be applied to both ComposeModal and CommandPalette. |
| D6-3 | Add `--color-text-subtle-a11y` token for accessible subtle text | Bump `--color-text-subtle` from `#6e7681` to `#848d97` (dark) and from `#8b949e` to `#656d76` (light) to meet 4.5:1. Apply only to compose components to minimize blast radius; existing components can migrate later. Actually, changing the token globally is safer since all uses of subtle text should be accessible. |
| D6-4 | Global `prefers-reduced-motion` in `app.css` rather than per-component | Single media query in `app.css` using `*, *::before, *::after` selector to disable all transitions and animations. Simpler, exhaustive, and avoids missing any component. |
| D6-5 | Touch target minimum via `min-width`/`min-height` with `padding` adjustments | Use CSS `min-width: 44px; min-height: 44px` on interactive elements. Visual size stays the same but tap area expands. Applied selectively inside `@media (pointer: coarse)` to avoid desktop layout disruption. |
| D6-6 | Mobile-first modal: full viewport below 640px, constrained above | Below 640px: modal fills viewport (no border-radius, no max-height constraint). Between 640–768px: thread mode fills viewport, tweet mode constrained. Above 768px: current behavior. |
| D6-7 | Card actions always visible on touch devices | Override `opacity: 0` to `opacity: 1` for `.card-actions` inside `@media (hover: none)` to ensure touch users can access duplicate/split/merge/remove. |
| D6-8 | Focus return via storing trigger element ref | ComposeModal captures `document.activeElement` on open, restores focus on close. No prop changes needed. |
| D6-9 | Remove `a11y_media_has_caption` ignores by adding `muted` attribute | Videos in preview are short clips with no meaningful audio. Adding `muted` attribute satisfies the a11y check without requiring captions. |
| D6-10 | CommandPalette backdrop: replace `svelte-ignore` with proper event handler | Add `role="presentation"` and `onkeydown` handler to the backdrop `<div>` to remove the static element interaction warning. |

---

## Files to Create

| File | Purpose | Lines (est.) |
|------|---------|-------------|
| `dashboard/src/lib/components/FromNotesPanel.svelte` | Extracted from-notes section with textarea, generate button, close button. Props: `mode`, `ongenerate`, `onclose`. Manages its own `notesText` and `generating` state. | ~120 |
| `dashboard/src/lib/actions/focusTrap.ts` | Svelte action for focus trapping. Intercepts Tab/Shift+Tab at container boundaries. Queries `focusableSelector` on each trap event. Returns destroy cleanup. | ~60 |
| `docs/roadmap/typefully-composer-ui-parity/session-06-polish-notes.md` | Technical documentation of Session 06 changes | ~150 |
| `docs/roadmap/typefully-composer-ui-parity/session-06-handoff.md` | Handoff document for Session 07 | ~120 |

## Files to Modify

| File | Changes |
|------|---------|
| `dashboard/src/app.css` | 1. Adjust `--color-text-subtle` for WCAG AA compliance (dark: `#6e7681` → `#848d97`, light: `#8b949e` → `#656d76`). 2. Add global `:focus-visible` outline style. 3. Add `prefers-reduced-motion` media query. |
| `dashboard/src/lib/components/ComposeModal.svelte` | 1. Import and use `focusTrap` action on modal. 2. Replace inline from-notes section with `FromNotesPanel` component. 3. Add focus-return logic (capture trigger on open, restore on close). 4. Expand mobile responsive CSS (full-viewport below 640px, footer stacking, body padding adjustments). 5. Increase touch targets for header buttons. 6. Fix video `a11y_media_has_caption` by adding `muted`. 7. Add keyboard handler for backdrop (remove implicit a11y issue). |
| `dashboard/src/lib/components/ThreadComposer.svelte` | 1. Increase touch targets for action buttons and drag handles. 2. Make card actions always visible on touch devices (`@media (hover: none)`). 3. Add mobile card layout adjustments (wider gutter touch area, stacked card footer on narrow screens). 4. Ensure drag handle is keyboard-accessible via arrow key instructions in `aria-label`. |
| `dashboard/src/lib/components/CommandPalette.svelte` | 1. Remove `svelte-ignore a11y_no_static_element_interactions` by adding proper `role` and `onkeydown`. 2. Add focus trap via `focusTrap` action. 3. Mobile layout: full-width below 640px, adjusted padding. 4. Increase palette item touch targets. |
| `dashboard/src/lib/components/MediaSlot.svelte` | 1. Increase touch targets for remove button and attach button. 2. Fix video `a11y_media_has_caption` by adding `muted`. 3. Add `aria-label` with file name context to remove buttons. |
| `dashboard/src/lib/components/TweetPreview.svelte` | 1. Add `aria-label` on preview region. 2. Responsive preview sizing for mobile (smaller avatar, tighter padding). |

---

## Detailed Implementation Steps

### Step 1: Create `focusTrap` action utility
**File:** `dashboard/src/lib/actions/focusTrap.ts`

```
Create a Svelte action (use:focusTrap) that:
1. On mount, queries all focusable elements within the container
2. On Tab keydown, if focus is on the last element, wrap to first
3. On Shift+Tab keydown, if focus is on the first element, wrap to last
4. Focusable selector: 'a[href], button:not([disabled]), textarea, input:not([disabled]), select, [tabindex]:not([tabindex="-1"])'
5. Returns { destroy } for cleanup
6. Refreshes focusable list on each Tab event (handles dynamic content)
```

**Verification:** Import works in ComposeModal and CommandPalette.

---

### Step 2: Create `FromNotesPanel.svelte` (extract from ComposeModal)
**File:** `dashboard/src/lib/components/FromNotesPanel.svelte`

Extract lines 650–677 from ComposeModal (the `showFromNotes` section) plus the related state and logic (lines 408–445, `generateFromNotes` function).

Props interface:
```typescript
{
  mode: 'tweet' | 'thread';
  ongenerate: (text: string) => Promise<void>;
  onclose: () => void;
}
```

Internal state: `notesText`, `generating`, `error`.

Move the `.from-notes-section` styles into the new component.

**Verification:** ComposeModal imports FromNotesPanel and passes callbacks. Behavior identical to pre-extraction.

---

### Step 3: Update `app.css` — accessibility foundations
**File:** `dashboard/src/app.css`

Add after the scrollbar styling section:

1. **`:focus-visible` global ring:**
```css
:focus-visible {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}
```

2. **`prefers-reduced-motion` global disable:**
```css
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
    scroll-behavior: auto !important;
  }
}
```

3. **Contrast fix for `--color-text-subtle`:**
   - Dark theme: change `#6e7681` → `#848d97` (ratio ~4.6:1 on `#161b22`)
   - Light theme: change `#8b949e` → `#656d76` (ratio ~4.7:1 on `#ffffff`)

**Verification:** Inspect computed styles in browser dev tools. Check that focus rings appear on Tab navigation. Check that `prefers-reduced-motion` disables animations (toggle in dev tools).

---

### Step 4: Update `ComposeModal.svelte` — accessibility and responsiveness
**File:** `dashboard/src/lib/components/ComposeModal.svelte`

#### 4a. Focus trap
- Import `focusTrap` from `$lib/actions/focusTrap`
- Add `use:focusTrap` to the `.modal` div

#### 4b. Focus return
- Add `let triggerElement: Element | null = null;` state
- In the `$effect` that watches `open`: when transitioning to `true`, capture `document.activeElement`
- In `onclose` wrapper: after calling the parent's `onclose`, restore focus to `triggerElement`

#### 4c. Replace from-notes inline section
- Import `FromNotesPanel`
- Replace the `{#if showFromNotes}` block (lines 650–677) with:
  ```svelte
  {#if showFromNotes}
    <FromNotesPanel {mode} ongenerate={handleGenerateFromNotes} onclose={() => { showFromNotes = false; }} />
  {/if}
  ```
- Move `generateFromNotes` logic into a `handleGenerateFromNotes(text: string)` that receives the notes text from the child
- Remove `notesText`, `notesGenerating` state variables
- Remove `.from-notes-section`, `.notes-*` styles (moved to child)

#### 4d. Fix video a11y
- Line 613: Replace `<!-- svelte-ignore a11y_media_has_caption -->` + `<video>` with `<video muted>` and remove the ignore comment

#### 4e. Touch targets (CSS)
```css
@media (pointer: coarse) {
  .close-btn,
  .focus-btn {
    min-width: 44px;
    min-height: 44px;
  }
  .remove-media-btn {
    width: 32px;
    height: 32px;
  }
}
```

#### 4f. Mobile responsive CSS
```css
@media (max-width: 640px) {
  .modal {
    width: 100vw;
    max-width: 100vw;
    height: 100vh;
    max-height: 100vh;
    border-radius: 0;
    display: flex;
    flex-direction: column;
  }
  .modal-body {
    flex: 1;
    overflow-y: auto;
  }
  .modal-footer {
    flex-wrap: wrap;
    gap: 8px;
    padding: 12px 16px;
  }
  .modal-footer .footer-spacer {
    display: none;
  }
  .modal-footer .submit-btn {
    width: 100%;
    justify-content: center;
    order: -1;
  }
  .media-attach-section {
    flex-direction: column;
    align-items: flex-start;
  }
  .mode-tabs {
    padding: 0 16px;
  }
  .modal-header {
    padding: 12px 16px;
  }
  .modal-body {
    padding: 16px;
  }
}
```

#### 4g. Fix backdrop keyboard handler
The backdrop `onkeydown` handler currently fires `onclose()` on Enter/Space, which conflicts with typing. Change to only handle Escape:
```svelte
onkeydown={(e) => {
  if (e.key === 'Escape') onclose();
}}
```

**Net line count estimate:** ComposeModal goes from 1311 → ~1180 lines (from-notes extraction removes ~130 lines of template + styles; new imports/logic add ~20). Still above 400 limit but R5-1 acknowledged this is a phased process.

---

### Step 5: Update `ThreadComposer.svelte` — touch targets and mobile layout
**File:** `dashboard/src/lib/components/ThreadComposer.svelte`

#### 5a. Touch targets
```css
@media (pointer: coarse) {
  .action-btn,
  .remove-card-btn {
    min-width: 44px;
    min-height: 44px;
  }
  .drag-handle {
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .add-card-btn {
    min-height: 44px;
  }
}
```

#### 5b. Card actions visible on touch devices
```css
@media (hover: none) {
  .card-actions {
    opacity: 1;
  }
}
```

#### 5c. Mobile card layout
```css
@media (max-width: 640px) {
  .tweet-card {
    padding: 10px;
  }
  .card-footer {
    flex-wrap: wrap;
    gap: 8px;
  }
  .card-gutter {
    width: 20px;
  }
  .card-textarea {
    font-size: 16px; /* Prevent iOS zoom on focus */
  }
}
```

#### 5d. Drag handle a11y improvement
Update `aria-label` to include reorder instructions:
```svelte
aria-label="Reorder tweet {i + 1}. Use Alt+Up or Alt+Down to move."
```

---

### Step 6: Update `CommandPalette.svelte` — a11y and mobile
**File:** `dashboard/src/lib/components/CommandPalette.svelte`

#### 6a. Remove `svelte-ignore a11y_no_static_element_interactions`
Replace the backdrop div (line 146–151):
```svelte
<div
  class="palette-backdrop"
  onclick={(e) => { if (e.target === e.currentTarget) onclose(); }}
  onkeydown={handleKeydown}
  role="presentation"
>
```
The `role="presentation"` removes the interactive element warning since the div is purely structural. The `onkeydown` is justified because it manages keyboard navigation for the palette.

#### 6b. Focus trap
Import and apply `use:focusTrap` on `.palette-panel`.

#### 6c. Mobile layout
```css
@media (max-width: 640px) {
  .palette-backdrop {
    padding-top: 20px;
  }
  .palette-panel {
    width: 100%;
    max-width: 100%;
    border-radius: 0;
    max-height: calc(100vh - 40px);
  }
  .palette-item {
    padding: 12px 14px;
    min-height: 44px;
  }
}
```

---

### Step 7: Update `MediaSlot.svelte` — touch targets and a11y
**File:** `dashboard/src/lib/components/MediaSlot.svelte`

#### 7a. Touch targets
```css
@media (pointer: coarse) {
  .remove-btn {
    width: 32px;
    height: 32px;
  }
  .attach-btn {
    min-height: 44px;
    padding: 8px 12px;
  }
}
```

#### 7b. Fix video a11y
Line 139: Replace `<!-- svelte-ignore a11y_media_has_caption -->` with `muted` attribute on `<video>`.

#### 7c. Descriptive remove button labels
```svelte
aria-label="Remove media attachment {mediaPaths.indexOf(path) + 1}"
```

---

### Step 8: Update `TweetPreview.svelte` — responsive and a11y
**File:** `dashboard/src/lib/components/TweetPreview.svelte`

#### 8a. Add `aria-label` on preview region
Already has `aria-label="Tweet {index + 1} of {total}"` on the article — this is adequate.

#### 8b. Responsive sizing for mobile
```css
@media (max-width: 640px) {
  .tweet-preview {
    gap: 8px;
    padding: 10px 0;
  }
  .preview-gutter {
    width: 28px;
  }
  .avatar-placeholder {
    width: 28px;
    height: 28px;
  }
  .preview-text {
    font-size: 14px;
  }
}
```

---

### Step 9: Write documentation
**File:** `docs/roadmap/typefully-composer-ui-parity/session-06-polish-notes.md`

Document all changes made, contrast verification results, touch target measurements, and reduced-motion behavior.

**File:** `docs/roadmap/typefully-composer-ui-parity/session-06-handoff.md`

Standard handoff with: what changed, decisions, open risks, test coverage, exact inputs for Session 07.

---

## Execution Order

| Order | Step | Depends On | Reason |
|-------|------|------------|--------|
| 1 | Create `focusTrap.ts` action | — | Foundation utility needed by steps 4 and 6 |
| 2 | Create `FromNotesPanel.svelte` | — | Standalone extraction, no dependencies |
| 3 | Update `app.css` | — | Global tokens needed before component CSS |
| 4 | Update `ComposeModal.svelte` | Steps 1, 2, 3 | Uses focusTrap, imports FromNotesPanel, relies on updated tokens |
| 5 | Update `ThreadComposer.svelte` | Step 3 | Relies on updated tokens |
| 6 | Update `CommandPalette.svelte` | Step 1, 3 | Uses focusTrap, relies on updated tokens |
| 7 | Update `MediaSlot.svelte` | Step 3 | Relies on updated tokens |
| 8 | Update `TweetPreview.svelte` | Step 3 | Relies on updated tokens |
| 9 | Run quality gates | Steps 1–8 | Verify all changes pass |
| 10 | Write documentation | Step 9 | Document verified state |

---

## Risks and Mitigations

| # | Risk | Severity | Mitigation |
|---|------|----------|------------|
| R6-1 | `--color-text-subtle` change affects all 37 component files using transitions | Medium | The color change is minor (~2 shades lighter in dark, ~2 shades darker in light). Visual impact is minimal. Only subtle text labels are affected — no primary content. |
| R6-2 | Global `:focus-visible` outline may clash with component-specific focus styles | Low | ComposeModal and ThreadComposer already use `border-color: var(--color-accent)` on `:focus`. The `:focus-visible` outline will layer on top. Use `outline-offset: 2px` to avoid visual overlap. Components that set `outline: none` on `:focus` will still get the `:focus-visible` ring since `:focus-visible` is more specific for keyboard users. |
| R6-3 | `prefers-reduced-motion` global `!important` may override intentional animations | Low | Only CSS transitions/animations are affected. JavaScript-driven animations (e.g., scroll position) are unaffected. The `0.01ms` duration (not `0s`) avoids breaking `animationend`/`transitionend` event listeners. |
| R6-4 | Focus trap may interfere with CommandPalette-within-modal nesting | Medium | CommandPalette has its own focus trap. When palette is open, its trap takes precedence because it's rendered inside the modal and its focusable elements are a subset. The modal trap won't fire because focus stays within the palette. Test this specifically. |
| R6-5 | ComposeModal still exceeds 400-line limit after extraction | Low | Goes from 1311 to ~1180 lines. Further extraction (TweetComposeSection, ThreadComposeSection) is possible but risks over-fragmenting state management. Document as follow-up for Session 07 or a future initiative. |
| R6-6 | iOS input zoom with font-size < 16px | Medium | Add `font-size: 16px` on textareas in mobile breakpoint. This prevents Safari's auto-zoom behavior on input focus. |
| R6-7 | `@media (pointer: coarse)` may not cover all touch devices | Low | Supplement with `@media (hover: none)` for card actions visibility. Most modern touch devices correctly report `pointer: coarse`. |
| R6-8 | Focus return to trigger element may fail if trigger is removed from DOM | Low | Guard with `if (triggerElement instanceof HTMLElement) triggerElement.focus()`. Fallback: no-op (browser default focus behavior). |

---

## Quality Gate Verification

### Primary gates (must all pass)
```bash
cd dashboard && npm run check    # svelte-check — 0 errors
cd dashboard && npm run build    # production build — success
```

### No Rust changes expected — skip Rust gates

### Manual verification checklist
1. **Focus trap:** Tab through modal; verify focus wraps from last to first element and vice versa
2. **Focus return:** Open modal via Compose button; close with Escape; verify Compose button regains focus
3. **`:focus-visible`:** Tab to any button; verify blue outline ring appears; click same button; verify no outline
4. **`prefers-reduced-motion`:** Toggle in Chrome DevTools > Rendering > Emulate CSS media feature; verify no transitions animate
5. **Mobile viewport (640px):** Resize browser; verify modal fills viewport; verify footer wraps submit button to full width; verify card actions visible without hover
6. **Touch targets:** In Chrome DevTools device mode, verify all interactive elements have >=44px tap targets
7. **Contrast:** Use axe DevTools extension; verify zero contrast violations in compose modal
8. **CommandPalette mobile:** Open palette on 640px viewport; verify full-width layout
9. **Thread on mobile:** Create 5-card thread on 640px viewport; verify scrolling works, cards don't overflow
10. **`svelte-ignore` count:** Search compose components for remaining `a11y_*` directives; target: zero in modified files (except justified cases)

### Performance verification
- Open compose modal with 10-card thread
- Measure: modal opens in < 100ms (no animation lag)
- Type in card textarea: no visible input delay
- Reorder cards: animation completes within frame budget (16ms)
- Tab between 10 cards: focus moves instantly

---

## Deliverables Summary

| Deliverable | Path |
|-------------|------|
| Focus trap utility | `dashboard/src/lib/actions/focusTrap.ts` |
| From-notes panel component | `dashboard/src/lib/components/FromNotesPanel.svelte` |
| Updated global styles | `dashboard/src/app.css` |
| Updated compose modal | `dashboard/src/lib/components/ComposeModal.svelte` |
| Updated thread composer | `dashboard/src/lib/components/ThreadComposer.svelte` |
| Updated command palette | `dashboard/src/lib/components/CommandPalette.svelte` |
| Updated media slot | `dashboard/src/lib/components/MediaSlot.svelte` |
| Updated tweet preview | `dashboard/src/lib/components/TweetPreview.svelte` |
| Polish notes doc | `docs/roadmap/typefully-composer-ui-parity/session-06-polish-notes.md` |
| Handoff doc | `docs/roadmap/typefully-composer-ui-parity/session-06-handoff.md` |
