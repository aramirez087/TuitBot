# Session 2 Implementation Plan: Composer Shell Redesign

## Objective

Rebuild the compose shell into a cleaner, calmer writing surface. Strip dashboard-like chrome (title, date, mode tabs, busy footer), replace with a minimal header bar, full-width canvas, and floating submit button. No editor internals change — `TweetEditor` and `ThreadComposer` remain untouched.

---

## Files to Create

### 1. `dashboard/src/lib/components/composer/ComposerHeaderBar.svelte` (~80 lines)

New minimal header bar replacing the current `modal-header` + `mode-tabs` sections.

**Props** (from `ui-architecture.md` spec):
```typescript
{
  focusMode: boolean;
  previewMode: boolean;
  ontogglefocus: () => void;
  ontogglepreview: () => void;
  onclose: () => void;
}
```

**Layout** (left to right):
- Close button (X icon) — left-aligned
- Spacer (flex: 1)
- Preview toggle button (Eye / EyeOff icon) — right-aligned, active state when preview on
- Focus mode toggle button (Maximize2 / Minimize2 icon)

**What is NOT rendered**: "Compose" title, date subtitle, mode tabs, any text labels.

**Styling decisions**:
- No bottom border (the current `.modal-header` has `border-bottom: 1px solid var(--color-border-subtle)` — removed for a cleaner look)
- Padding: `8px 16px` (reduced from current `16px 20px` — less vertical chrome)
- Background: transparent (inherits from modal)
- Button styling: reuse the existing `.close-btn` and `.focus-btn` patterns from current `ComposerShell.svelte`
- Touch targets: maintain `min-width: 44px; min-height: 44px` on `(pointer: coarse)` media query

**Preview toggle**: Session 2 adds the button but the preview toggle state doesn't switch content yet (no inline preview implementation until Session 3/4). The button will be wired to a `previewMode` prop and will visually indicate active state, but `ComposeModal` will pass `false` for now and the toggle handler will be a no-op. This avoids dead affordances — the button simply won't render until a future session enables it. **Decision: hide the preview toggle button in Session 2 since there's no inline preview yet. Add it in Session 3 when the unibody editor can actually toggle.**

### 2. `dashboard/src/lib/components/composer/ComposerCanvas.svelte` (~100 lines)

Layout wrapper that arranges the writing area. Future-proofs for inspector rail (Session 4).

**Props**:
```typescript
{
  children: Snippet;          // main writing area content
  inspector?: Snippet;        // inspector rail content (unused in Session 2)
  inspectorOpen?: boolean;    // whether inspector is visible (default false)
}
```

**Layout**:
- Default: `canvas-main` fills full width
- When inspector is open (Session 4): CSS grid `1fr 280px`
- Padding: `20px` on `canvas-main`

**Session 2 scope**: Only the `canvas-main` slot is used. The inspector slot exists in the interface but renders nothing. No inspector toggle button in header yet.

**Contains the floating submit button**: The submit button is positioned as `position: sticky; bottom: 16px;` inside the canvas area. It's a pill-shaped button (`border-radius: 20px`, height `40px`) using `--color-accent` background and white text.

**Floating submit button props**:
```typescript
{
  canSubmit: boolean;
  submitting: boolean;
  selectedTime: string | null;
  onsubmit: () => void;
}
```

**Rationale for putting submit in Canvas**: The submit button is visually part of the canvas — it floats over the writing area. Keeping it in `ComposerCanvas` rather than `ComposeModal` keeps the layout responsibility with the layout component. The submit handler still lives in `ComposeModal`; Canvas just renders the button and calls the callback.

---

## Files to Modify

### 3. `dashboard/src/lib/components/composer/ComposerShell.svelte` (516 → ~180 lines)

**Goal**: Strip to a thin structural shell — backdrop, modal container, recovery banner, focus-mode fullscreen. Delegate header to `ComposerHeaderBar`, body layout to `ComposerCanvas`.

**What stays in ComposerShell**:
- Backdrop with click-to-close
- Modal container with `role="dialog"`, `aria-modal`, `use:focusTrap`
- Recovery banner (lines 71–79)
- Focus-mode fullscreen CSS (`.modal.focus-mode`)
- CSS for `.modal` dimensions, `.backdrop`, `.recovery-*` classes
- Mobile responsive styles for modal sizing

**What gets removed from ComposerShell**:
- `modal-header` section (lines 81–102) → delegated to `ComposerHeaderBar`
- `mode-tabs` section (lines 105–124) → removed entirely per D1
- `modal-footer` section (lines 134–152) → replaced by floating submit in `ComposerCanvas`
- All CSS for `.modal-header`, `.modal-title`, `.date-subtitle`, `.header-actions`, `.close-btn`, `.focus-btn`, `.mode-tabs`, `.tab`, `.modal-footer`, `.assist-btn`, `.cancel-btn`, `.submit-btn`, `.footer-spacer`, `.notes-btn` — all migrated or deleted

**Props to remove**:
- `mode` — no longer needed (tabs removed)
- `dateLabel` — no longer displayed in header
- `canSubmit`, `submitting`, `selectedTime` — moved to floating submit in Canvas
- `assisting`, `tweetHasText` — only used in footer for AI Assist button label
- `showFromNotes` — only used in footer notes button
- `onmodechange` — tabs removed
- `onsubmit` — submit button moves to Canvas
- `onaiassist` — AI assist button moves out of footer (command palette only)
- `ontogglefromnotes` — notes button moves out of footer
- `submitError` — stays, but rendered differently

**Simplified props**:
```typescript
{
  open: boolean;
  focusMode: boolean;
  showRecovery: boolean;
  submitError: string | null;
  onclose: () => void;
  onrecover: () => void;
  ondismissrecovery: () => void;
  children: Snippet;
}
```

**Structural change**: The `children` snippet now contains `ComposerHeaderBar` + `ComposerCanvas` (rendered by `ComposeModal`). `ComposerShell` only wraps them in the modal container with backdrop.

### 4. `dashboard/src/lib/components/ComposeModal.svelte` (~455 → ~450 lines)

**Goal**: Rewire to use new subcomponents. Remove 50/50 grid layout. Keep all state management, autosave, and submission logic unchanged.

**Changes**:

1. **Import new components**: Add `ComposerHeaderBar` and `ComposerCanvas` imports.

2. **Add preview state**: `let previewMode = $state(false);` — wired to header toggle but not functional in Session 2. Actually, per the decision above, the preview toggle is hidden in Session 2, so no new state needed yet.

3. **Remove mode-tab-related props from ComposerShell call**: Remove `mode`, `dateLabel`, `canSubmit`, `submitting`, `assisting`, `tweetHasText`, `showFromNotes`, `selectedTime`, `onmodechange`, `onsubmit`, `onaiassist`, `ontogglefromnotes`.

4. **Keep passing to ComposerShell**: `open`, `focusMode`, `showRecovery`, `submitError`, `onclose`, `onrecover`, `ondismissrecovery`.

5. **Add `ontogglefocus` to ComposerShell or handle differently**: `ontogglefocus` was a ComposerShell prop. Now focus toggle lives in `ComposerHeaderBar`. ComposeModal renders `ComposerHeaderBar` inside the children snippet and passes `ontogglefocus` directly.

6. **Restructure children snippet**: Replace the current flat layout with:
   ```svelte
   {#snippet children()}
     <ComposerHeaderBar
       {focusMode}
       ontogglefocus={toggleFocusMode}
       onclose={handleCloseModal}
     />

     <ComposerCanvas
       {canSubmit} {submitting} {selectedTime}
       onsubmit={handleSubmit}
     >
       {#snippet children()}
         <VoiceContextPanel ... />

         <!-- Editor (full width, no grid split) -->
         {#if mode === 'tweet'}
           <TweetEditor ... />
         {:else}
           <ThreadComposer ... />
         {/if}

         <!-- Preview (shown below editor, not side-by-side) -->
         {#if mode === 'thread' || tweetText.trim()}
           <div class="preview-section">
             <ThreadPreviewRail ... />
           </div>
         {/if}

         {#if showFromNotes}
           <FromNotesPanel ... />
         {/if}

         {#if showUndo && !showFromNotes}
           <div class="undo-banner">...</div>
         {/if}

         <div class="schedule-section">
           <TimePicker ... />
         </div>
       {/snippet}
     </ComposerCanvas>
   {/snippet}
   ```

7. **Remove the 50/50 grid**: Delete `.compose-layout`, `.editor-pane`, `.preview-pane` CSS. Replace with a single-column flow. Preview moves below the editor as a collapsible section (not a side-by-side pane).

8. **Preview section styling**: The `ThreadPreviewRail` now appears below the editor in a section with a subtle top border, collapsible via a toggle. In Session 2, it renders inline below the editor — the inline-preview-toggle (swapping edit/preview) is a Session 3/4 feature.

   **Decision change**: Rather than removing preview entirely and breaking the current workflow, keep preview as a collapsible section below the editor. This preserves existing functionality while removing the wasteful 50/50 split. The preview section has a small toggle header ("Preview") that collapses/expands it.

---

## Key Design Decisions

### DD1: Preview toggle hidden in Session 2
The `ComposerHeaderBar` spec includes a preview toggle, but inline preview (swapping edit/preview in the same space) isn't implemented until Session 3+. Rather than shipping a dead affordance, the preview toggle button is omitted from the header in Session 2. Preview remains as a collapsible section below the editor.

### DD2: Close button in both Shell and HeaderBar
Currently `ComposerShell` has the close button in `modal-header`. After refactoring, `ComposerHeaderBar` owns the close button. The `onclose` callback is passed from `ComposeModal` → `ComposerHeaderBar`. `ComposerShell` still handles backdrop click-to-close.

### DD3: AI Assist and From Notes remain accessible
The footer is removed, but:
- **AI Assist**: Already accessible via `Cmd+J` and command palette (`Cmd+K` → "AI Improve"). No visible button needed in Session 2.
- **From Notes**: Already accessible via command palette (`Cmd+K` → "Generate from notes"). No visible button needed.
- Both will get dedicated spots in the inspector rail (Session 4).

### DD4: Floating submit button placement
The submit button uses `position: sticky; bottom: 16px` inside the canvas. It renders at the bottom of the scroll area and sticks when the content is taller than the viewport. This keeps it always visible without a fixed footer.

On mobile (≤640px), it anchors to `bottom: 0` with safe-area insets and spans full width.

### DD5: Modal width change
- Current: 520px (tweet) / 900px (thread) — the 900px was needed for the 50/50 grid
- New: 640px for both modes — single-column layout doesn't need 900px, but the extra width over 520px gives the editor more breathing room
- Focus mode: still 100vw × 100vh

### DD6: VoiceContextPanel, TimePicker, FromNotesPanel stay in place for Session 2
These controls are scheduled to move to the inspector rail in Session 4. In Session 2, they remain in the same position within the children snippet. This avoids breaking existing workflows.

### DD7: `submitError` rendering moves to Canvas
The error message was inside `modal-body` in `ComposerShell`. It moves to `ComposerCanvas` since that's now where the submit button lives — keeping error display near the action that triggered it.

---

## Detailed Implementation Order

### Step 1: Create `ComposerHeaderBar.svelte`
1. Create the file at `dashboard/src/lib/components/composer/ComposerHeaderBar.svelte`
2. Implement minimal header: close button (left), spacer, focus toggle (right)
3. Port button styling from current `ComposerShell.svelte` `.close-btn` and `.focus-btn` classes
4. Add touch target media queries
5. No preview toggle button yet (DD1)

### Step 2: Create `ComposerCanvas.svelte`
1. Create the file at `dashboard/src/lib/components/composer/ComposerCanvas.svelte`
2. Implement `canvas-main` layout with `children` snippet slot
3. Add floating submit button with sticky positioning
4. Add `submitError` display near the submit button
5. Style: padding 20px, submit pill button, error message
6. Add mobile responsive styles (full-width submit on mobile)
7. Include inspector slot placeholder (renders nothing in Session 2)

### Step 3: Refactor `ComposerShell.svelte`
1. Remove `modal-header` section and all header-related CSS
2. Remove `mode-tabs` section and all tab-related CSS
3. Remove `modal-footer` section and all footer-related CSS
4. Simplify props: remove `mode`, `dateLabel`, `canSubmit`, `submitting`, `assisting`, `tweetHasText`, `showFromNotes`, `selectedTime`, `onmodechange`, `onsubmit`, `onaiassist`, `ontogglefromnotes`
5. Keep: backdrop, modal container, recovery banner, focus-mode CSS, `use:focusTrap`
6. Remove `ontogglefocus` prop — focus toggle now in `ComposerHeaderBar`
7. Move `submitError` rendering to `ComposerCanvas`
8. Verify file is under 500 lines (target ~180)

### Step 4: Update `ComposeModal.svelte`
1. Add imports for `ComposerHeaderBar` and `ComposerCanvas`
2. Simplify props passed to `ComposerShell` (remove all the props that were stripped)
3. Restructure the `{#snippet children()}` block:
   - Render `ComposerHeaderBar` at top
   - Render `ComposerCanvas` wrapping the editor content
   - Move `VoiceContextPanel`, editor (`TweetEditor`/`ThreadComposer`), preview, FromNotesPanel, undo banner, TimePicker inside Canvas's children snippet
4. Remove the 50/50 `compose-layout` grid CSS
5. Replace with single-column flow for editor and preview
6. Change preview to a collapsible section below editor instead of side-by-side pane
7. Update modal width: remove `.modal.thread-mode { width: 900px }` → handled by ComposerShell's simplified width

### Step 5: Update `ComposerShell.svelte` CSS for new modal width
1. Change default modal width from 520px to 640px
2. Remove `.modal.thread-mode { width: 900px }` since no more 50/50 grid
3. Keep focus-mode fullscreen CSS
4. Keep mobile responsive breakpoints

### Step 6: Verify and test
1. Run `cd dashboard && npm run check`
2. Run `cd dashboard && npm run build`
3. Run Rust CI: `cargo fmt --all && cargo fmt --all --check`
4. Run `RUSTFLAGS="-D warnings" cargo test --workspace`
5. Run `cargo clippy --workspace -- -D warnings`

---

## Prop Flow Diagram (After Refactoring)

```
ComposeModal (orchestrator — owns all state)
├── ComposerShell (structural shell)
│   Props: open, focusMode, showRecovery, submitError, onclose, onrecover, ondismissrecovery
│   └── {children} snippet:
│       ├── ComposerHeaderBar
│       │   Props: focusMode, ontogglefocus, onclose
│       ├── ComposerCanvas
│       │   Props: canSubmit, submitting, selectedTime, submitError, onsubmit
│       │   └── {children} snippet:
│       │       ├── VoiceContextPanel (unchanged)
│       │       ├── TweetEditor or ThreadComposer (unchanged)
│       │       ├── ThreadPreviewRail (collapsible section, no grid)
│       │       ├── FromNotesPanel (when showFromNotes)
│       │       ├── undo-banner (when showUndo)
│       │       └── TimePicker (schedule section)
│       └── CommandPalette (when paletteOpen)
```

---

## Risks and Mitigations

| Risk | Severity | Mitigation |
|------|----------|------------|
| Removing footer breaks AI Assist discoverability | Medium | AI Assist is still available via Cmd+J and Cmd+K command palette. Will be restored in inspector rail (Session 4). Document this in handoff. |
| Floating submit button overlaps content | Low | `position: sticky` with `bottom: 16px` ensures it doesn't overlap. Add a `padding-bottom: 60px` to the canvas content so the last content isn't hidden behind the button. |
| Focus trap breaks with restructured DOM | Low | `focusTrap` action on the modal container still wraps all child content. No change to trap boundaries. |
| `submitError` display in two places | Low | Remove from `ComposerShell`, add to `ComposerCanvas` near submit button. Single source of truth. |
| ComposerShell prop changes break TypeScript | Medium | All prop changes are coordinated in a single step. Run `npm run check` to catch type errors immediately. |
| Preview removal confuses users | Low | Preview is kept as a collapsible section, not removed. Just moved from side-by-side to below-editor. |
| Thread mode losing 900px width | Low | The 900px was only needed for the 50/50 grid. Single-column at 640px is actually more writing space than the old 450px editor pane (half of 900px). |

---

## CSS Changes Summary

### New CSS patterns introduced:
1. **Floating submit pill**: `position: sticky; bottom: 16px; border-radius: 20px; height: 40px;` using `--color-accent` background
2. **Canvas wrapper**: Simple padding container with `overflow-y: auto; flex: 1;`
3. **Collapsible preview section**: `border-top: 1px solid var(--color-border-subtle)` with toggle header

### CSS removed:
1. `.modal-header`, `.modal-title`, `.date-subtitle`, `.header-actions` → moved to `ComposerHeaderBar`
2. `.mode-tabs`, `.tab`, `.tab.active` → deleted (tabs removed)
3. `.modal-footer`, `.assist-btn`, `.cancel-btn`, `.submit-btn`, `.footer-spacer`, `.notes-btn` → deleted (footer removed)
4. `.compose-layout`, `.editor-pane`, `.preview-pane` → deleted (grid layout removed)

### CSS kept (in ComposerShell):
1. `.backdrop` — unchanged
2. `.modal` — width changed from 520px to 640px, thread-mode width rule removed
3. `.recovery-*` — unchanged
4. `.modal.focus-mode` — unchanged
5. `.error-msg` — moved to ComposerCanvas
6. Mobile responsive `.modal` styles — adjusted for new width

---

## Verification Steps

1. **Type check**: `cd dashboard && npm run check` — must pass with zero errors
2. **Build**: `cd dashboard && npm run build` — must succeed
3. **Rust CI** (no Rust changes expected, but verifies nothing is broken):
   - `cargo fmt --all && cargo fmt --all --check`
   - `RUSTFLAGS="-D warnings" cargo test --workspace`
   - `cargo clippy --workspace -- -D warnings`
4. **Manual verification points** (for handoff documentation):
   - Modal opens with minimal header (close + focus toggle, no title/tabs)
   - Floating submit button visible and functional
   - Cmd+Enter still submits
   - Cmd+Shift+F toggles focus mode
   - Cmd+K opens command palette
   - Cmd+J triggers AI assist
   - Cmd+Shift+N/T switches mode (state change, no visible tabs)
   - Escape closes modal (or exits focus mode first)
   - Recovery banner appears when autosaved draft exists
   - Autosave continues working
   - Preview visible as collapsible section below editor
   - Mobile: modal goes full-viewport at ≤640px

---

## Line Count Estimates

| File | Before | After | Delta |
|------|--------|-------|-------|
| `ComposerHeaderBar.svelte` | — | ~75 | +75 (new) |
| `ComposerCanvas.svelte` | — | ~120 | +120 (new) |
| `ComposerShell.svelte` | 516 | ~180 | -336 |
| `ComposeModal.svelte` | 455 | ~430 | -25 |
| **Net** | 971 | ~805 | **-166** |

All files well within the 400-line (Svelte) / 500-line (Rust) limits from CLAUDE.md.

---

## Session 2 Deliverables Checklist

- [ ] `dashboard/src/lib/components/composer/ComposerHeaderBar.svelte` — created
- [ ] `dashboard/src/lib/components/composer/ComposerCanvas.svelte` — created
- [ ] `dashboard/src/lib/components/composer/ComposerShell.svelte` — refactored to ~180 lines
- [ ] `dashboard/src/lib/components/ComposeModal.svelte` — updated layout
- [ ] `docs/roadmap/composer-ui-typefully-plus/session-02-handoff.md` — written
- [ ] All quality gates pass
- [ ] No changes to `ThreadComposer.svelte`, `TweetEditor.svelte`, or any Rust code

---

## What Session 3 Needs From Session 2

Session 3 (Thread Interactions) depends on:
1. `ComposerCanvas.svelte` accepting editor content via children snippet — this is where `ThreadFlowEditor` will render
2. `ComposerShell.svelte` being structurally stable — Session 3 won't touch shell
3. Floating submit button already working — Session 3 only changes editor internals
4. The preview section being positioned below the editor — Session 3 will replace it with inline preview toggle
5. `ComposeModal.svelte` still passing `mode`, `threadBlocks`, `tweetText` to editors — data flow unchanged
