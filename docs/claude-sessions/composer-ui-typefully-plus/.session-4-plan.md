# Session 4 Implementation Plan: Inspector Rail & Polish

## Current State Assessment

After Sessions 2–3, the composer has a clean writing surface with a minimal shell (`ComposerShell` → `ComposerHeaderBar` + `ComposerCanvas`) and a continuous thread flow editor (`ThreadFlowLane` → `ThreadFlowCard`). However, **all secondary controls still live stacked vertically inside the canvas children snippet**, making the writing area feel crowded:

```
ComposerCanvas children:
  VoiceContextPanel          ← above editor, always visible
  TweetEditor / ThreadComposer
  preview-section            ← collapsible, below editor
  FromNotesPanel             ← conditional, below editor
  undo-banner                ← conditional
  schedule-section           ← always, below everything
```

This session moves those secondary surfaces into a collapsible **inspector rail** alongside the canvas, so the writing area stays clean while schedule, voice, AI, and notes remain one click/shortcut away.

---

## Design Decisions

### D1: Inspector as a snippet slot on ComposerCanvas

ComposerCanvas already accepts a `children` snippet. We add an `inspector` snippet prop. When `inspectorOpen` is true, the canvas renders a two-column CSS grid: `canvas-main` (1fr) + `canvas-inspector` (280px). When false, inspector is hidden and canvas-main fills the width.

**Rationale:** Keeps ComposerCanvas as a pure layout component. The inspector content is authored in ComposeModal (where all the state lives) and passed as a snippet — no prop drilling through an intermediate component.

### D2: ComposerInspector is a thin section container

`ComposerInspector.svelte` (~130 lines) provides the rail's scrollable container, section dividers, section headers, and mobile drawer behavior. It receives its content sections as snippets or children. Each section has a consistent header label (uppercase, 11px, muted) matching VoiceContextPanel's existing style.

**Sections (top to bottom):**
1. **Schedule** — TimePicker (always visible in inspector)
2. **Voice** — VoiceContextPanel (collapsible, state persisted in localStorage)
3. **AI Actions** — Two buttons: "AI Generate" (handleAiAssist) and "From Notes" (toggles FromNotesPanel)
4. **From Notes** — FromNotesPanel (shown when toggled from AI section or Cmd+K palette)

### D3: Inspector toggle via Cmd+I and header button

- New keyboard shortcut: `Cmd+I` / `Ctrl+I` toggles inspector open/closed
- New button in ComposerHeaderBar: `PanelRight` (lucide) icon, between the spacer and focus toggle
- Inspector defaults to **open on desktop** (≥768px) and **closed on mobile** (<768px)
- State persisted in localStorage (`tuitbot:inspector:open`)

### D4: Preview toggle in header bar

- New button in ComposerHeaderBar: `Eye` / `EyeOff` (lucide) icon
- Toggles `previewCollapsed` state (already exists in ComposeModal)
- Keyboard shortcut: `Cmd+Shift+P` / `Ctrl+Shift+P`
- Preview section stays inline in canvas-main (below editor), not in inspector

**Rationale:** Preview needs to be visually adjacent to the editor for comparison. Putting it in the inspector (which is only 280px wide) would make the preview too narrow to be useful. The toggle just gives a header-level affordance for an existing feature.

### D5: Mode unification (SC1) deferred to Session 5

Mode unification requires merging TweetEditor's `AttachedMedia[]` model with ThreadComposer's `ThreadBlock[].media_paths` model. This touches submission logic, autosave format, and recovery. The risk is too high for a session focused on inspector polish.

**Scope cut:** Document explicitly. Session 5 can attempt it with the inspector in place.

### D6: AI Generate button in inspector

The `handleAiAssist` function in ComposeModal (lines 284–307) is currently only reachable from the code but has no visible UI trigger. Session 4 adds a visible button in the inspector's AI Actions section. Behavior:
- Tweet mode + content → improve full text
- Tweet mode + empty → generate tweet from topic
- Thread mode → generate thread outline

### D7: Empty-state guidance cues

Lightweight, non-blocking hints that teach power features:
- **Empty editor (tweet mode):** Placeholder updated to "What's on your mind? Press ⌘⇧T for a thread"
- **Inspector AI section:** Subtle hint text: "Use ⌘J to improve selected text"
- **Inspector schedule section when no time selected:** "Posts immediately unless scheduled"
- **Inspector voice section when no voice configured:** Already has "Set voice in Settings → Content Persona" (VoiceContextPanel line 116). Keep as-is.

### D8: Mobile inspector as overlay drawer

On screens < 768px, the inspector renders as a fixed-position bottom drawer with backdrop overlay:
- Slides up from bottom with `transform: translateY(0)` transition
- Backdrop click closes
- 60vh max height, scrollable
- Swipe-down to dismiss (optional — defer if complex)

### D9: ThreadCardActions cleanup

Delete `ThreadCardActions.svelte` (124 lines). It's been orphaned since Session 3. No component imports it.

---

## Files to Create

### 1. `dashboard/src/lib/components/composer/ComposerInspector.svelte` (~140 lines)

**Role:** Scrollable rail container with section dividers.

**Props:**
```typescript
{
  open: boolean;
  mobile: boolean;   // true when < 768px — renders as drawer
  onclose: () => void; // close drawer on mobile
  children: Snippet;  // section content passed from ComposeModal
}
```

**Template structure:**
```svelte
{#if mobile}
  <!-- backdrop + bottom drawer -->
  <div class="inspector-backdrop" onclick={onclose}>
    <div class="inspector-drawer" onclick|stopPropagation>
      <div class="drawer-handle"></div>
      <div class="inspector-scroll">{@render children()}</div>
    </div>
  </div>
{:else}
  <!-- inline rail -->
  <div class="inspector-rail">
    <div class="inspector-scroll">{@render children()}</div>
  </div>
{/if}
```

**Styles:**
- Rail: `width: 280px`, `border-left: 1px solid var(--color-border-subtle)`, `background: var(--color-surface)`, `padding: 16px`, `overflow-y: auto`
- Drawer: `position: fixed`, `bottom: 0`, `left: 0`, `right: 0`, `max-height: 60vh`, `border-radius: 12px 12px 0 0`, `z-index: 1100`
- Backdrop: `position: fixed`, `inset: 0`, `background: rgba(0,0,0,0.4)`, `z-index: 1099`

---

## Files to Modify

### 2. `dashboard/src/lib/components/composer/ComposerCanvas.svelte`

**Current:** 125 lines. Single column with `canvas-main` and sticky submit button.

**Changes (~40 lines added, ~10 lines modified → ~155 lines total):**

- Add `inspectorOpen` prop (boolean)
- Add `inspector` snippet prop (optional)
- Wrap `.canvas` in a grid layout when `inspectorOpen && inspector`:
  ```css
  .canvas.with-inspector {
    display: grid;
    grid-template-columns: 1fr 280px;
  }
  ```
- Render inspector snippet in a `.canvas-inspector` div when open
- Submit button stays inside `canvas-main` (unchanged)
- At ≤768px, inspector content is NOT rendered here (it's a separate drawer handled by ComposeModal)

**Key CSS additions:**
```css
.canvas.with-inspector {
  display: grid;
  grid-template-columns: 1fr 280px;
  gap: 0;
}

.canvas-inspector {
  border-left: 1px solid var(--color-border-subtle);
  overflow-y: auto;
  padding: 16px;
  min-height: 0;
}

@media (max-width: 768px) {
  .canvas.with-inspector {
    grid-template-columns: 1fr;
  }
  .canvas-inspector {
    display: none; /* handled as drawer overlay instead */
  }
}
```

### 3. `dashboard/src/lib/components/composer/ComposerHeaderBar.svelte`

**Current:** 77 lines. Close button + spacer + focus toggle.

**Changes (~40 lines added → ~117 lines total):**

- Add props: `inspectorOpen`, `previewVisible`, `ontoggleinspector`, `ontogglepreview`
- Add inspector toggle button (PanelRight icon from lucide-svelte)
- Add preview toggle button (Eye/EyeOff icon from lucide-svelte)
- Button order (left to right): Close | spacer | Preview toggle | Inspector toggle | Focus toggle
- Active states: accent color on icon when respective panel is open
- Tooltip titles with keyboard shortcuts

**New props:**
```typescript
{
  focusMode: boolean;
  inspectorOpen: boolean;
  previewVisible: boolean;
  ontogglefocus: () => void;
  ontoggleinspector: () => void;
  ontogglepreview: () => void;
  onclose: () => void;
}
```

### 4. `dashboard/src/lib/components/ComposeModal.svelte`

**Current:** 489 lines. This is the most significant change in the session.

**Changes (net ~-30 lines → ~460 lines):**

**New state variables:**
```typescript
let inspectorOpen = $state(loadInspectorState()); // persisted in localStorage
let isMobile = $state(false); // derived from matchMedia
```

**New effect for responsive detection:**
```typescript
$effect(() => {
  const mql = window.matchMedia('(max-width: 768px)');
  isMobile = mql.matches;
  const handler = (e: MediaQueryListEvent) => { isMobile = e.matches; };
  mql.addEventListener('change', handler);
  return () => mql.removeEventListener('change', handler);
});
```

**Move out of canvas children snippet → into inspector snippet:**
- VoiceContextPanel (line 331)
- TimePicker / schedule-section (lines 390–395)
- FromNotesPanel (lines 372–381)
- Undo banner (lines 383–388) — stays in canvas (it's a global notification, not an inspector section)

**New keyboard shortcuts:**
- `Cmd+I` → toggle inspector
- `Cmd+Shift+P` → toggle preview

**New command palette action handler:**
- `'toggle-inspector'` → toggle inspectorOpen
- `'ai-generate'` → call handleAiAssist

**Template restructure:**
```svelte
<ComposerCanvas
  {canSubmit} {submitting} {selectedTime} {submitError}
  inspectorOpen={inspectorOpen && !isMobile}
  onsubmit={handleSubmit}
>
  {#snippet children()}
    <!-- Editor only (TweetEditor or ThreadComposer) -->
    {#if mode === 'tweet'}
      <TweetEditor ... />
    {:else}
      <ThreadComposer ... />
    {/if}

    <!-- Preview (inline, toggled) -->
    {#if hasPreviewContent && !previewCollapsed}
      <div class="preview-section">...</div>
    {:else if hasPreviewContent && previewCollapsed}
      <!-- collapsed hint removed — toggle is in header now -->
    {/if}

    <!-- Undo banner (stays in canvas) -->
    {#if showUndo && !showFromNotes}
      <div class="undo-banner">...</div>
    {/if}
  {/snippet}

  {#snippet inspector()}
    <!-- Schedule -->
    <div class="inspector-section">
      <div class="inspector-section-label">Schedule</div>
      <TimePicker ... />
      {#if !selectedTime}
        <p class="inspector-hint">Posts immediately unless scheduled</p>
      {/if}
    </div>

    <!-- Voice -->
    <div class="inspector-section">
      <VoiceContextPanel bind:this={voicePanelRef} ... />
    </div>

    <!-- AI Actions -->
    <div class="inspector-section">
      <div class="inspector-section-label">AI</div>
      <div class="ai-actions-row">
        <button class="ai-action-btn" onclick={handleAiAssist} disabled={assisting}>
          {assisting ? 'Generating...' : hasExistingContent ? 'AI Improve' : 'AI Generate'}
        </button>
        <button class="ai-action-btn secondary" onclick={() => { showFromNotes = true; }}>
          From Notes
        </button>
      </div>
      <p class="inspector-hint">⌘J to improve selected text</p>
    </div>

    <!-- From Notes (conditional) -->
    {#if showFromNotes}
      <div class="inspector-section">
        <FromNotesPanel ... />
      </div>
    {/if}
  {/snippet}
</ComposerCanvas>

<!-- Mobile inspector drawer -->
{#if isMobile && inspectorOpen}
  <ComposerInspector
    open={inspectorOpen}
    mobile={true}
    onclose={() => { inspectorOpen = false; }}
  >
    {#snippet children()}
      <!-- Same inspector sections as above -->
    {/snippet}
  </ComposerInspector>
{/if}
```

**Styles to remove from ComposeModal:**
- `.schedule-section` (moves to inspector section styling)
- `.preview-toggle.collapsed` (replaced by header button)

**Styles to add:**
- `.inspector-section` — `padding: 12px 0`, `border-bottom: 1px solid var(--color-border-subtle)`
- `.inspector-section-label` — `font-size: 11px`, `font-weight: 600`, `text-transform: uppercase`, `letter-spacing: 0.04em`, `color: var(--color-text-muted)`, `margin-bottom: 8px`
- `.inspector-hint` — `font-size: 11px`, `color: var(--color-text-subtle)`, `margin-top: 6px`
- `.ai-actions-row` — `display: flex`, `gap: 8px`
- `.ai-action-btn` — pill button style matching existing accent buttons

### 5. `dashboard/src/lib/components/CommandPalette.svelte`

**Current:** 342 lines.

**Changes (~6 lines added → ~348 lines total):**

Add two new actions to `allActions` array:
```typescript
{ id: 'toggle-inspector', label: 'Toggle inspector', icon: PanelRight, category: 'Mode', shortcut: 'cmd+i', when: 'always' },
{ id: 'ai-generate', label: 'AI Generate / Improve', icon: Sparkles, category: 'AI', when: 'always' },
```

Import `PanelRight` from lucide-svelte.

### 6. `dashboard/src/lib/components/composer/VoiceContextPanel.svelte`

**Current:** 284 lines.

**Changes (~15 lines modified → ~284 lines total):**

- When rendered inside the inspector, the collapsible toggle wrapper is unnecessary — the panel is always expanded (the inspector itself is the collapsible element). Add an `inline` prop (default false) that, when true, renders the body content directly without the toggle button wrapper.
- Keep the collapsed/expanded toggle for backwards compatibility when `inline = false`.

```typescript
let {
  cue,
  oncuechange,
  inline = false  // NEW: when true, renders expanded body only (no toggle)
}: { ... } = $props();
```

When `inline = true`:
- Skip the `.voice-context-panel` border/background wrapper
- Skip the toggle button
- Render voice-body content directly
- Section label comes from the inspector section header (ComposeModal), not from VoiceContextPanel

### 7. `dashboard/src/lib/components/FromNotesPanel.svelte`

**Current:** 313 lines.

**Changes (~10 lines → ~313 lines):**

Minor: Remove the outer `.from-notes-section` border/padding when rendered inside inspector (the inspector section provides its own). Add a `compact` prop (default false) that suppresses the outer border.

```typescript
let {
  ...existing,
  compact = false  // NEW: suppresses outer border/padding for inspector context
}: { ... } = $props();
```

When `compact = true`:
- `.from-notes-section` gets `border: none; padding: 0; background: transparent;`

### 8. `docs/composer-mode.md`

**Current:** 432 lines.

**Updates:**
- Add "Inspector Rail" section describing the collapsible right panel, its sections, and toggle
- Update "Keyboard Shortcuts" table with Cmd+I (toggle inspector) and Cmd+Shift+P (toggle preview)
- Update "Distraction-Free Mode" section to note inspector behavior in focus mode
- Update "Voice Context" section to note inspector placement
- Update "AI Assist" section to document the visible AI Generate/Improve button

---

## Files to Delete

### 9. `dashboard/src/lib/components/composer/ThreadCardActions.svelte`

124 lines. Orphaned since Session 3 (no imports). Safe to delete.

---

## Files NOT Changed (Intentionally)

| File | Reason |
|------|--------|
| `ThreadComposer.svelte` | External API frozen; internal rendering unchanged |
| `ThreadFlowCard.svelte` | No changes needed |
| `ThreadFlowLane.svelte` | No changes needed |
| `TweetEditor.svelte` | No changes needed (placeholder text change happens in ComposeModal via props if needed) |
| `ComposerShell.svelte` | Layout unchanged — inspector is inside canvas, not shell |
| `ThreadPreviewRail.svelte` | Same props, same rendering |
| `TimePicker.svelte` | No interface changes needed |
| `content/+page.svelte` | ComposeModal API unchanged; calendar entry point works identically |
| All Rust files | No backend changes |

---

## Order of Operations

### Phase 1: Create the Inspector Container (~25 min)

1. **Create `ComposerInspector.svelte`** — Rail container with mobile drawer mode. ~140 lines. Test renders as static HTML first.

### Phase 2: Extend Canvas Layout (~20 min)

2. **Modify `ComposerCanvas.svelte`** — Add `inspectorOpen` and `inspector` snippet props. Add CSS grid layout. Verify canvas-main still works alone when inspector is closed.

### Phase 3: Extend Header Bar (~15 min)

3. **Modify `ComposerHeaderBar.svelte`** — Add inspector toggle button (`PanelRight`), preview toggle button (`Eye`/`EyeOff`), new props. Verify button layout and active states.

### Phase 4: Rewire ComposeModal (~40 min — largest change)

4. **Modify `ComposeModal.svelte`** — Move VoiceContextPanel, TimePicker, FromNotesPanel into inspector snippet. Add `inspectorOpen` state with localStorage persistence. Add mobile media query detection. Add Cmd+I and Cmd+Shift+P keyboard shortcuts. Add handleAiAssist button in inspector AI section. Add empty-state hints. Wire new header bar props.

### Phase 5: Adapt Panels for Inspector Context (~15 min)

5. **Modify `VoiceContextPanel.svelte`** — Add `inline` prop to suppress toggle wrapper when inside inspector.
6. **Modify `FromNotesPanel.svelte`** — Add `compact` prop to suppress outer border when inside inspector.

### Phase 6: Command Palette & Cleanup (~10 min)

7. **Modify `CommandPalette.svelte`** — Add `toggle-inspector` and `ai-generate` actions.
8. **Delete `ThreadCardActions.svelte`** — Orphaned since Session 3.

### Phase 7: Documentation (~20 min)

9. **Update `docs/composer-mode.md`** — Inspector rail section, updated shortcuts table, updated AI section.
10. **Write `docs/roadmap/composer-ui-typefully-plus/session-04-handoff.md`** — Decisions, files changed, scope cuts, risks, next session inputs.

### Phase 8: Quality Gates (~10 min)

11. Run all quality gates:
    ```bash
    cargo fmt --all && cargo fmt --all --check
    RUSTFLAGS="-D warnings" cargo test --workspace
    cargo clippy --workspace -- -D warnings
    cd dashboard && npm run check
    cd dashboard && npm run build
    ```

---

## Keyboard Shortcuts (Final State After Session 4)

| Shortcut | Context | Behavior | Status |
|----------|---------|----------|--------|
| Cmd+K | Modal | Open command palette | Unchanged |
| Cmd+Enter | Modal | Submit | Unchanged |
| Cmd+Shift+F | Modal | Toggle focus mode | Unchanged |
| Cmd+J | Modal | AI inline assist | Unchanged |
| Cmd+Shift+N | Modal | Switch to tweet mode | Unchanged |
| Cmd+Shift+T | Modal | Switch to thread mode | Unchanged |
| **Cmd+I** | **Modal** | **Toggle inspector rail** | **NEW** |
| **Cmd+Shift+P** | **Modal** | **Toggle preview** | **NEW** |
| Escape | Modal | Close (layered: FromNotes → inspector on mobile → focus mode → modal) | **Updated escape cascade** |
| Cmd+Shift+Enter | Card textarea | Insert separator / split at cursor | Unchanged |
| Backspace (at pos 0) | Card textarea | Merge with previous card | Unchanged |
| Tab | Card textarea | Focus next card | Unchanged |
| Shift+Tab | Card textarea | Focus previous card | Unchanged |
| Alt+ArrowUp | Card textarea | Move card up | Unchanged |
| Alt+ArrowDown | Card textarea | Move card down | Unchanged |
| Cmd+D | Card textarea | Duplicate card | Unchanged |
| Cmd+Shift+S | Card textarea | Split at cursor | Unchanged |
| Cmd+Shift+M | Card textarea | Merge with next | Unchanged |

---

## Risks and Mitigations

| # | Risk | Severity | Mitigation |
|---|------|----------|------------|
| R1 | ComposeModal exceeds 500 lines | Medium | Moving sections to inspector snippet should net-reduce lines. If still over, extract inspector section snippet to a separate helper component. |
| R2 | Inspector grid breaks mobile layout | Medium | Use `@media (max-width: 768px)` to hide grid inspector column. Mobile uses drawer overlay instead. Test at 640px and 768px. |
| R3 | Cmd+I conflicts with browser italic shortcut | Low | Only active when compose modal is open (e.preventDefault stops browser default). Test in Tauri where browser shortcuts don't apply. |
| R4 | VoiceContextPanel inline mode breaks existing collapsed behavior | Medium | `inline` prop defaults to `false`. Only the inspector call site passes `inline={true}`. Non-inspector uses are unaffected. |
| R5 | Inspector drawer z-index conflicts with CommandPalette | Medium | Inspector backdrop at z-index 1099, drawer at 1100. CommandPalette backdrop at z-index 10 (relative to modal). The compose modal is z-index 1000. Palette renders inside the modal, so its z-index stacks correctly. |
| R6 | Calendar entry point regression | Low | ComposeModal's external API (`open`, `prefillTime`, `prefillDate`, `schedule`, `onclose`, `onsubmit`) is unchanged. content/+page.svelte requires zero changes. |
| R7 | Autosave format change | None | No changes to autosave format. Inspector state (open/closed) is persisted separately. |
| R8 | Preview toggle Cmd+Shift+P conflicts | Low | No existing shortcut uses this combo. In browsers, Cmd+Shift+P opens private window — but we preventDefault inside the modal handler. |

---

## Scope Cuts (Carried Forward or New)

| ID | Item | Reason |
|----|------|--------|
| SC1 | Content-determined mode (unified editor) | Requires merging media models. Deferred to Session 5. |
| SC3 | Cross-card media drag-and-drop | Deferred post-Session 5. |
| SC4 | Cmd+Enter for separator | Deferred pending user feedback. |
| SC10 | Swipe-down-to-dismiss on mobile drawer | Complex touch gesture handling. Use backdrop click and Escape for now. Defer to polish pass. |
| SC11 | Inspector section reordering | Users can't reorder the inspector sections (Schedule, Voice, AI). Fixed order for now. |
| SC12 | Inline preview in inspector | Preview stays in canvas-main (too narrow at 280px for useful preview). |

---

## Verification Steps

1. **Inspector toggle:** Open composer → press Cmd+I → inspector appears as right rail with Schedule, Voice, AI sections. Press again → inspector hides. Canvas fills width.
2. **Preview toggle:** Open composer → type content → press Cmd+Shift+P → preview hides. Press again → preview shows. Header button shows active state.
3. **AI Generate button:** Open inspector → click "AI Generate" with empty tweet → tweet text populated. Click with existing text → text improved.
4. **From Notes in inspector:** Open inspector → click "From Notes" → FromNotesPanel appears in inspector. Type notes → generate → content replaces editor.
5. **Schedule in inspector:** Open inspector → preferred times visible → click a time → submit button changes to "Schedule". Clear → back to "Post now".
6. **Voice in inspector:** Open inspector → voice chips visible. Type cue → press Cmd+J → cue used in AI call.
7. **Mobile drawer:** Resize to <768px → inspector auto-closes. Press Cmd+I → bottom drawer slides up. Click backdrop → closes.
8. **Calendar entry point:** Navigate to Content Calendar → click time slot → composer opens with prefilled date/time. Inspector shows scheduled time. Submit works.
9. **Command palette:** Press Cmd+K → "Toggle inspector" visible in Mode category. "AI Generate" visible in AI category.
10. **Focus mode:** Toggle focus mode → inspector persists alongside fullscreen canvas. Toggle inspector in focus mode → works correctly.
11. **Escape cascade:** Open composer → open inspector (mobile) → press Escape → inspector closes. Press Escape → modal closes.
12. **Quality gates:** All five gates pass (fmt, test, clippy, check, build).

---

## Estimated Line Counts After Session 4

| File | Before | After | Delta |
|------|--------|-------|-------|
| `composer/ComposerInspector.svelte` | — | ~140 | +140 |
| `composer/ComposerCanvas.svelte` | 125 | ~160 | +35 |
| `composer/ComposerHeaderBar.svelte` | 77 | ~120 | +43 |
| `ComposeModal.svelte` | 489 | ~465 | -24 |
| `composer/VoiceContextPanel.svelte` | 284 | ~290 | +6 |
| `FromNotesPanel.svelte` | 313 | ~318 | +5 |
| `CommandPalette.svelte` | 342 | ~350 | +8 |
| `composer/ThreadCardActions.svelte` | 124 | — | -124 |
| **Net** | **1754** | **1843** | **+89** |

All files stay well under the 400-line Svelte limit.
