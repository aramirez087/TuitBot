# Session 5 Plan: Validation & Release

## Mission

Validate the completed composer overhaul across Sessions 2–4, fix ship-blocking regressions, and produce a release-readiness decision with concrete evidence.

## Codebase State Summary

### File Inventory (Post-Session 4)

| File | Lines | Notes |
|------|-------|-------|
| `ComposeModal.svelte` | 674 | Orchestrator — component file, not `+page.svelte` |
| `composer/ComposerShell.svelte` | 150 | Modal chrome |
| `composer/ComposerHeaderBar.svelte` | 122 | Minimal header: close, preview, inspector, focus |
| `composer/ComposerCanvas.svelte` | 163 | Flex layout with inspector rail |
| `composer/ComposerInspector.svelte` | 115 | Mobile drawer overlay |
| `composer/ThreadFlowCard.svelte` | 294 | Borderless card with separator |
| `composer/ThreadFlowLane.svelte` | 136 | Flow container |
| `composer/TweetEditor.svelte` | 327 | Single-tweet editor |
| `composer/VoiceContextPanel.svelte` | 330 | Voice context + cue |
| `composer/ThreadPreviewRail.svelte` | 90 | Preview rendering |
| `ThreadComposer.svelte` | 433 | Thread orchestrator |
| `FromNotesPanel.svelte` | 323 | Notes-to-content |
| `CommandPalette.svelte` | 344 | Cmd+K palette |
| `MediaSlot.svelte` | 293 | Per-card media |
| `content/+page.svelte` | 407 | **Over 400-line limit** |
| **Total** | 3784 | |

---

## Pre-Implementation Findings (Code Audit)

### Finding F1: `SHORTCUT_CATALOG` Missing Session 4 Shortcuts (Regression)

**File**: `dashboard/src/lib/utils/shortcuts.ts`
**Issue**: The `SHORTCUT_CATALOG` array does not include `cmd+i` (Toggle inspector) or `cmd+shift+p` (Toggle preview) shortcuts added in Session 4. While the CommandPalette uses its own `allActions` array (which includes `toggle-inspector`), the `SHORTCUT_CATALOG` is the canonical reference and is incomplete.
**Severity**: Low — cosmetic inconsistency; functionality is not affected.
**Fix**: Add two entries to `SHORTCUT_CATALOG`.

### Finding F2: `content/+page.svelte` at 407 Lines (Pre-existing)

**File**: `dashboard/src/routes/(app)/content/+page.svelte`
**Issue**: At 407 lines, this file exceeds the 400-line CLAUDE.md limit for `+page.svelte` files. However, this file was **not modified** during the composer overhaul (Sessions 2–4). The ComposeModal external API is unchanged.
**Severity**: None for this epic — pre-existing condition, not a regression.
**Action**: Document as non-blocking follow-up.

### Finding F3: `attach-media` Palette Action Only Works in Tweet Mode

**File**: `ComposeModal.svelte:261`
**Issue**: The `attach-media` palette action calls `tweetEditorRef?.triggerFileSelect()`, which only works when `mode === 'tweet'` (since `tweetEditorRef` is only bound when TweetEditor is rendered). In thread mode, media attachment is per-card via MediaSlot, so this action silently does nothing. The CommandPalette shows it with `when: 'always'`.
**Severity**: Low — the action gracefully does nothing in thread mode (no crash, no error). Per-card media attachment via MediaSlot is the correct path in thread mode.
**Fix**: Either (a) change `when` to `'tweet'` in CommandPalette, or (b) leave as-is since media semantics differ between modes. Recommend (a) for clarity.

### Finding F4: Mobile Inspector VoiceContextPanel Missing `bind:this`

**File**: `ComposeModal.svelte:494-498`
**Issue**: The mobile inspector's VoiceContextPanel instance does not have `bind:this={voicePanelRef}`. The desktop version in the inspector snippet also omits this (line 435), but the desktop version never needs it because `voicePanelRef` is bound to the standalone VoiceContextPanel that was removed. Wait — looking more carefully, neither the desktop inspector snippet (line 435) nor the mobile inspector (line 494) has `bind:this`. The `voicePanelRef` is declared (line 51) and used in `handleInlineAssist` (line 284) and `handleGenerateFromNotes` (line 310) to call `saveCueToHistory()`. This means `voicePanelRef` is always `undefined`, so cue history is **never saved** during AI operations.
**Severity**: Medium — `saveCueToHistory()` silently fails (`voicePanelRef?.saveCueToHistory()` is guarded by optional chaining). The cue is still used for the current session, but never persisted to the MRU list in localStorage.
**Fix**: Add `bind:this={voicePanelRef}` to the desktop inspector's VoiceContextPanel (line 435). The mobile version would need a separate ref or the same ref (since only one is rendered at a time).

### Finding F5: Inspector Escape Handler Duplication

**File**: `ComposerInspector.svelte:21-25` and `ComposeModal.svelte:243`
**Issue**: The mobile inspector drawer (`ComposerInspector.svelte`) has its own `handleBackdropKeydown` that calls `e.stopPropagation()` on Escape. The ComposeModal's `handleKeydown` (line 243) also handles `isMobile && inspectorOpen` to close the inspector on Escape. Both paths work, but the stopPropagation means the ComposeModal handler never fires when the inspector backdrop has focus. When a textarea inside the inspector has focus (not the backdrop), the ComposeModal handler runs instead. This dual path is benign — both produce the same result — but is worth noting.
**Severity**: None — behavior is correct in all cases.

### Finding F6: Mode Unification (SC1) Not Implemented — Deliberate Deviation

**Files**: `ComposeModal.svelte:39`, `CommandPalette.svelte:43-46`
**Issue**: Charter Principle 3 states "Content Determines Mode — No tweet vs. thread selector." The current implementation retains explicit mode state (`let mode = $state<'tweet' | 'thread'>('tweet')`) with `Cmd+Shift+N/T` shortcuts and CommandPalette actions for switching. The mode tabs are visually removed (Session 2), but mode is still an explicit user choice rather than being derived from block count.
**Severity**: This was a deliberate scope cut documented in every session (SC1 in S3, D10 in S4). The stated reason is that merging the media models (`AttachedMedia[]` in TweetEditor vs `string[]` in MediaSlot/ThreadComposer) carries significant risk. The current implementation preserves functionality while removing the visual tabs — a reasonable halfway point.
**Action**: Document as deliberate deviation with rationale. Not a release blocker.

### Finding F7: Preview Rendered Inline Below Editor, Not as Mode Toggle

**Files**: `ComposeModal.svelte:397-411`, `ComposerHeaderBar.svelte:35-48`
**Issue**: Charter Principle "Inline Preview Toggle" describes preview as replacing the editor canvas (modal toggle between edit/preview in same space). The implementation renders preview as a collapsible section below the editor, toggled by the header bar Eye button and `Cmd+Shift+P`. This is a hybrid: the preview is inline (not a side panel) but doesn't replace the editor.
**Severity**: This is arguably better than the charter spec — users can see both editor and preview simultaneously. Documented in Session 2 (D2: "Preview as collapsible section, not removed").
**Action**: Document as deliberate deviation. Not a release blocker.

### Finding F8: ThreadFlowEditor/ThreadSeparator Architecture Deviation

**Files**: `ThreadFlowCard.svelte`, `ThreadFlowLane.svelte`
**Issue**: The UI Architecture doc (`ui-architecture.md`) planned `ThreadFlowEditor.svelte` (unibody with contenteditable) and `ThreadSeparator.svelte` (standalone separator). Session 3 chose stacked textareas instead (D1), creating `ThreadFlowCard.svelte` + `ThreadFlowLane.svelte` with the separator integrated into each card.
**Severity**: None — this was the planned fallback strategy documented in the architecture. The interaction model is preserved.
**Action**: Document as implemented variation. Not a release blocker.

### Finding F9: Inspector Width 260px vs Spec 280px

**File**: `ComposerCanvas.svelte:83`
**Issue**: Architecture spec says 280px. Session 4 used 260px (D1).
**Severity**: None — minor deviation that prevents the canvas from getting too narrow on smaller desktops. Q3 from Session 1 explicitly flagged this as a concern.

---

## Implementation Plan

### Phase 1: Run Quality Gates

**Order**: Run all 5 quality gates. If any fail, assess whether the failure is a regression from Sessions 2–4 or a pre-existing condition.

#### Step 1.1: Rust Quality Gates (Parallel)

Run these three commands. No Rust files were changed in Sessions 2–4, so these should all pass.

```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
```

**Expected**: All pass (confirmed in Session 4 handoff).
**If fail**: Investigate. If pre-existing, document. If regression from frontend build changes, fix.

#### Step 1.2: Frontend Quality Gates (Sequential)

```bash
cd dashboard && npm run check
cd dashboard && npm run build
```

**Expected**: Both pass (confirmed in Session 4 handoff).
**If fail**: These are the most likely to surface regressions. Fix only what's attributable to Sessions 2–4.

### Phase 2: Fix Ship-Blocking Regressions

Based on the code audit findings above, only F4 is potentially ship-blocking (cue history never saved). The others are cosmetic or deliberate.

#### Step 2.1: Fix F4 — Restore `voicePanelRef` binding

**File to modify**: `dashboard/src/lib/components/ComposeModal.svelte`
**Change**: Add `bind:this={voicePanelRef}` to the VoiceContextPanel inside the desktop inspector snippet (line ~435). This is the instance that's always rendered when the inspector is open on desktop — the majority case.

```svelte
<!-- In the inspector snippet, around line 435 -->
<VoiceContextPanel
    bind:this={voicePanelRef}
    cue={voiceCue}
    oncuechange={(c) => { voiceCue = c; }}
    inline={true}
/>
```

**Rationale**: The `voicePanelRef` was being bound to a VoiceContextPanel instance in the pre-Session 4 layout. When VoiceContextPanel moved into the inspector snippet, the `bind:this` was lost. This means `saveCueToHistory()` calls after AI operations are no-ops.

**Risk**: Low. Adding `bind:this` to one of the two VoiceContextPanel instances is sufficient because:
- On desktop, the inspector snippet renders the panel
- On mobile, the mobile inspector renders it
- Only one is visible at a time
- The ref is used only for `saveCueToHistory()` which writes to localStorage

For mobile, we should also add the bind:

```svelte
<!-- In the mobile inspector, around line 494 -->
<VoiceContextPanel
    bind:this={voicePanelRef}
    cue={voiceCue}
    oncuechange={(c) => { voiceCue = c; }}
    inline={true}
/>
```

Since only one is rendered at a time (desktop hides at <768px, mobile shows at <768px), both can safely bind to the same ref.

#### Step 2.2: Fix F1 — Update SHORTCUT_CATALOG

**File to modify**: `dashboard/src/lib/utils/shortcuts.ts`
**Change**: Add two entries to `SHORTCUT_CATALOG`:

```typescript
{ combo: 'cmd+i', label: 'Toggle inspector', category: 'Mode', when: 'always' },
{ combo: 'cmd+shift+p', label: 'Toggle preview', category: 'Mode', when: 'always' },
```

**Rationale**: The catalog should be the single source of truth for all keyboard shortcuts. Session 4 added these shortcuts to the handler but not to the catalog.

#### Step 2.3: Fix F3 — Scope `attach-media` to tweet mode

**File to modify**: `dashboard/src/lib/components/CommandPalette.svelte`
**Change**: Change the `attach-media` action's `when` from `'always'` to `'tweet'`:

```typescript
{ id: 'attach-media', label: 'Attach media', icon: Image, category: 'Compose', when: 'tweet' },
```

**Rationale**: In thread mode, media is attached per-card via MediaSlot. The `tweetEditorRef?.triggerFileSelect()` handler only works in tweet mode. Showing this action in thread mode is misleading.

### Phase 3: Re-run Quality Gates

After the fixes in Phase 2, re-run all 5 quality gates to confirm nothing was broken:

```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
cd dashboard && npm run check
cd dashboard && npm run build
```

### Phase 4: Code Audit of Main Flows

Systematically trace each user flow through the code to verify correctness. This is a read-only audit — document findings but don't fix non-blockers.

#### Flow 4.1: Open from Calendar

**Entry point**: `content/+page.svelte:51-55` → `openCompose(date, time)`
**Path**: Sets `composePrefillDate` and `composePrefillTime` → passes to `ComposeModal` as props → `ComposeModal` `$effect` (line 146) sets `selectedTime = prefillTime` on open
**Props verified**: `open`, `prefillTime`, `prefillDate`, `schedule`, `onclose`, `onsubmit` — all unchanged from pre-overhaul.
**Expected result**: Modal opens with TimePicker pre-filled to the clicked slot's time. The TimePicker is now in the inspector rail (defaults open on desktop).

#### Flow 4.2: Draft a Tweet

**Path**: Modal opens in tweet mode (default) → TweetEditor renders → user types in textarea → `onchange` callback updates `tweetText` in ComposeModal → `tweetChars` derived → `canSubmitTweet` derived → floating submit pill enables
**Autosave**: `$effect` on line 164 fires `autoSave()` on `tweetText` change → 500ms debounce → saves to localStorage
**Preview**: `hasPreviewContent` derived (line 184) → preview section shows below editor if not collapsed

#### Flow 4.3: Draft a Thread

**Path**: User switches to thread mode via `Cmd+Shift+T` or CommandPalette → `mode` becomes `'thread'` → ThreadComposer renders with default 2 blocks → user types → `onchange` callback updates `threadBlocks` → `onvalidchange` updates `threadValid` → `canSubmit` derived
**New card**: `Cmd+Shift+Enter` → `handleCardKeydown` in ThreadComposer → `addBlockAfter` or `splitBlock`
**Autosave**: Same $effect triggers on `threadBlocks` change

#### Flow 4.4: Reorder Thread Items

**Keyboard**: `Alt+ArrowUp/Down` in card textarea → `handleCardKeydown` → `moveBlock` → `normalizeOrder` → `emitChange`
**Drag-and-drop**: `ondragstart` on separator handle → `handleDragStart` → `handleCardDragOver/Enter/Leave` → `handleCardDrop` → `moveBlock`
**ARIA**: `reorderAnnouncement` set on move → read by sr-only status div in ThreadFlowLane

#### Flow 4.5: Attach Media

**Tweet mode**: TweetEditor → file input → `handleFileSelect` → `api.media.upload` → `onmediachange` callback
**Thread mode**: MediaSlot per-card → `handleFiles` → `api.media.upload` → `onmediachange` → `updateBlockMedia` in ThreadComposer
**Validation**: Max 4 images, exclusive GIF/video — enforced in both TweetEditor and MediaSlot independently

#### Flow 4.6: Use AI Assist

**Cmd+J (inline improve)**: `handleInlineAssist` in ComposeModal → gets selection from textarea → `api.assist.improve` → replaces selection or full text → `voicePanelRef?.saveCueToHistory()` (**currently broken — F4**)
**Inspector AI button**: `handleAiAssist` → context-aware (improve if content exists, generate if empty, thread generation in thread mode) → `voicePanelRef?.saveCueToHistory()` (**currently broken — F4**)
**From Notes**: Inspector section → FromNotesPanel → `handleGenerateFromNotes` → undo snapshot → `api.assist.thread` or `api.assist.improve` → `voicePanelRef?.saveCueToHistory()` (**currently broken — F4**)

#### Flow 4.7: Schedule Content

**Path**: TimePicker in inspector rail → `onselect` callback → `selectedTime` state in ComposeModal → submit handler reads `selectedTime` → creates `Date` with `targetDate` + time → formats as ISO 8601 without `Z` → sets `data.scheduled_for`
**Submit button label**: Changes from "Post now" to "Schedule" when `selectedTime` is set (ComposerCanvas line 41)

#### Flow 4.8: Recover Autosave

**Path**: Modal opens → `checkRecovery()` → reads localStorage `tuitbot:compose:draft` → checks TTL (7 days) → checks for content → if found, sets `showRecovery = true` → ComposerShell renders recovery banner → user clicks Recover/Discard → `recoverDraft()` or `dismissRecovery()`

#### Flow 4.9: Close Modal Cleanly

**Escape cascade** (ComposeModal line 241-247):
1. If `showFromNotes` → close notes panel
2. If `isMobile && inspectorOpen` → close mobile inspector
3. If `focusMode` → exit focus mode
4. Else → `handleCloseModal()` → `onclose()` + return focus to trigger element

**Backdrop click**: ComposerShell `handleBackdropClick` → `onclose()`
**X button**: ComposerHeaderBar → `onclose`
**Focus return**: `triggerElement` captured on open (line 148), focused on close (line 226)

### Phase 5: Charter Compliance Assessment

Compare the final state against each Session 01 charter principle:

| Charter Principle | Status | Evidence |
|---|---|---|
| **1. Writing First** | Achieved | Card borders removed (ThreadFlowCard uses left accent bar only), no header title, no tabs, no footer chrome. Canvas is the primary visual element. |
| **2. Progressive Disclosure** | Achieved | Inspector rail hides Schedule/Voice/AI behind a toggle. Command palette for power users. Separator tools appear on hover. |
| **3. Content Determines Mode** | Partially achieved | Mode tabs removed from UI. Mode still requires explicit switch via Cmd+Shift+N/T or command palette. Block-count-derived mode (SC1) deferred. |
| **4. Keyboard-Native** | Achieved | 16 shortcuts covering all operations. Command palette accessible via Cmd+K. Thread operations fully keyboard-driven. |
| **5. Mobile-Ready** | Achieved | Full-viewport modal on ≤640px, inspector drawer on <768px, 44px touch targets, 16px font size on mobile. |
| **6. Preserve What Works** | Achieved | Autosave format unchanged, ThreadBlock[] contract preserved, ComposeModal external API unchanged, all keyboard shortcuts preserved. |

#### Success Criteria Check

| Criterion | Target | Actual | Met? |
|---|---|---|---|
| Visible chrome elements (default) | ≤5 | 4 (close, inspector toggle, preview toggle, focus toggle) + floating submit = 5 | Yes |
| Thread creation interactions (3-tweet) | 2 shortcuts | Mode switch (1) + 2× Cmd+Shift+Enter = 3 interactions (or just 2 if already in thread mode) | Partially — SC1 would eliminate the mode switch |
| Feature coverage | All features preserved | All 12 features functional. Cue history save broken (F4 — fix planned). | Yes (after F4 fix) |

### Phase 6: Write Deliverables

#### Deliverable 6.1: `release-readiness.md`

**Path**: `docs/roadmap/composer-ui-typefully-plus/release-readiness.md`

**Structure**:
1. Executive summary (go/no-go decision)
2. Quality gate results table
3. Flow audit results table (each flow: pass/conditional/fail)
4. Charter compliance matrix
5. Known limitations (non-blocking)
6. Ship-blocking issues found and fixed
7. Follow-up work backlog (non-blocking)

#### Deliverable 6.2: `session-05-handoff.md`

**Path**: `docs/roadmap/composer-ui-typefully-plus/session-05-handoff.md`

**Structure**:
1. Session summary
2. Decisions made (fixing F1, F3, F4)
3. Files changed
4. Quality gate final results
5. Charter deviations documented
6. Non-blocking follow-up work
7. Final component inventory
8. Final keyboard shortcuts table
9. Risk register closure

---

## Exact Order of Operations

1. **Run Rust quality gates** (`cargo fmt`, `cargo test`, `cargo clippy`) — parallel
2. **Run frontend quality gates** (`npm run check`, `npm run build`) — sequential
3. **Record results** — note any failures
4. **Invoke `frontend-design` skill** — required by CLAUDE.md before writing frontend code
5. **Fix F4**: Add `bind:this={voicePanelRef}` to both VoiceContextPanel instances in ComposeModal
6. **Fix F1**: Add `cmd+i` and `cmd+shift+p` to SHORTCUT_CATALOG in shortcuts.ts
7. **Fix F3**: Change `attach-media` action `when` from `'always'` to `'tweet'` in CommandPalette
8. **Re-run frontend quality gates** (`npm run check`, `npm run build`)
9. **Trace all 9 flows** (read-only audit, document results)
10. **Assess charter compliance** (compare against Session 01 principles)
11. **Write `release-readiness.md`**
12. **Write `session-05-handoff.md`**
13. **Final quality gate run** (all 5 gates, record results for handoff)

## Files to Create

| File | Purpose |
|------|---------|
| `docs/roadmap/composer-ui-typefully-plus/release-readiness.md` | Go/no-go report |
| `docs/roadmap/composer-ui-typefully-plus/session-05-handoff.md` | Session handoff |

## Files to Modify

| File | Change | Lines Affected |
|------|--------|----------------|
| `ComposeModal.svelte` | Add `bind:this={voicePanelRef}` to 2 VoiceContextPanel instances | ~2 lines |
| `shortcuts.ts` | Add 2 entries to SHORTCUT_CATALOG | ~2 lines |
| `CommandPalette.svelte` | Change `attach-media` `when` from `'always'` to `'tweet'` | 1 line |

## Files NOT Modified (Intentionally)

| File | Reason |
|------|--------|
| `content/+page.svelte` | Pre-existing 407-line issue; not a regression |
| `ThreadComposer.svelte` | External API frozen |
| `ComposerShell.svelte` | No changes needed |
| `ComposerCanvas.svelte` | No changes needed |
| `ComposerHeaderBar.svelte` | No changes needed |
| `ComposerInspector.svelte` | No changes needed |
| `ThreadFlowCard.svelte` | No changes needed |
| `ThreadFlowLane.svelte` | No changes needed |
| `TweetEditor.svelte` | No changes needed |
| `VoiceContextPanel.svelte` | No changes needed (bind:this is on the parent) |
| `FromNotesPanel.svelte` | No changes needed |
| `MediaSlot.svelte` | No changes needed |
| `ThreadPreviewRail.svelte` | No changes needed |
| All Rust files | No backend changes in this epic |

## Key Design Decisions

### KD1: Ship Decision Criteria

**Go** if: All 5 quality gates pass, all 9 flows are functional (no crashes, no data loss), and the 3 fixes (F1, F3, F4) land cleanly.

**No-go** if: Any quality gate fails with a regression from Sessions 2–4, or any core flow (submit, schedule, autosave) is broken.

### KD2: SC1 (Mode Unification) is Not a Release Blocker

The charter's "Content Determines Mode" principle is partially achieved — mode tabs are removed, but explicit mode switching via shortcuts/palette remains. This is acceptable for initial release because:
- The UI no longer shows mode tabs (reduced chrome)
- Mode switching via Cmd+Shift+N/T is discoverable via command palette
- Full SC1 requires merging incompatible media models (high risk for a validation session)
- The current approach is functionally correct and visually clean

### KD3: Fixes Are Minimal and Surgical

The three fixes (F1, F3, F4) are chosen because:
- F4 restores a broken feature (cue history) with a 2-line change
- F1 updates a reference catalog (no runtime impact)
- F3 prevents user confusion (hiding non-functional action)
- None of them change architecture, layout, or interaction patterns

## Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Quality gates fail with pre-existing issues | Medium | Document as pre-existing; don't fix in this session |
| `bind:this` on snippet-rendered VoiceContextPanel doesn't work | Low | Test after fix; Svelte 5 supports bind:this in snippets |
| ComposeModal at 674 lines exceeds some arbitrary limit | Low | Not a `+page.svelte` file; CLAUDE.md limit is 400 for pages, 500 for Rust. Component files are not explicitly limited. Session 4 noted 472 lines for the `<script>` portion. |

## Verification Steps

1. `cargo fmt --all && cargo fmt --all --check` — passes
2. `RUSTFLAGS="-D warnings" cargo test --workspace` — passes
3. `cargo clippy --workspace -- -D warnings` — passes
4. `cd dashboard && npm run check` — passes (0 errors)
5. `cd dashboard && npm run build` — passes
6. Manual trace of all 9 flows confirms functional correctness
7. Charter compliance matrix shows no unacceptable deviations
