# Session 3 Implementation Plan: Thread Interactions & Media

## Executive Summary

Refactor the thread editor from a stack of bordered card components into a connected writing flow. Extract `ThreadComposer`'s inline card rendering into two new components (`ThreadFlowCard`, `ThreadFlowLane`), restyle to eliminate card borders in favor of separator-line boundaries, improve media integration, and add a `Cmd+Shift+Enter` shortcut for inline separator insertion. The `ThreadBlock[]` contract, exported methods, autosave format, and preview synchronization are all preserved.

---

## Design Decisions

### D1: Stacked Textareas (not contenteditable)

**Decision**: Use stacked `<textarea>` elements with visual connectors. Do NOT use `contenteditable`.

**Rationale**: The Session 2 handoff flagged `contenteditable` as High risk (R1). The specific problems:
- Unreliable undo/redo across browsers (Chrome, Safari, Firefox each handle it differently)
- IME input (CJK) breaks frequently with custom contenteditable handling
- Cursor management at separator boundaries is a multi-week engineering effort
- Selection across tweet boundaries doesn't map to the underlying data model (each tweet is a separate post on X)
- Mobile keyboard behavior is unpredictable

Stacked textareas deliver 90% of the UX improvement (no card borders, connected flow, clean writing surface) with 20% of the risk. Each textarea maps 1:1 to a `ThreadBlock`, preserving the existing data model perfectly. Native undo/redo, IME, and selection all work automatically per-card.

The visual treatment (no borders, transparent background, left accent bar for focus, thin separator lines between cards) makes the stacked textareas feel like a continuous writing surface even though they're separate DOM elements.

### D2: Component decomposition — ThreadFlowCard + ThreadFlowLane + ThreadComposer

**Decision**: Extract card rendering and flow layout into two new components while keeping `ThreadComposer` as the state orchestrator.

**Architecture**:
```
ThreadComposer.svelte              ← State owner (blocks, mutations, validation, AI, exports)
  └── ThreadFlowLane.svelte        ← Flow rendering (connected visual layout, separators)
       └── ThreadFlowCard.svelte   ← Individual card (textarea, media, separator below)
            └── MediaSlot.svelte   ← Media attachments (refined)
```

**Rationale**:
- `ComposeModal` uses `bind:this={threadComposerRef}` to call `getBlocks()`, `setBlocks()`, `handleInlineAssist()`, `handlePaletteAction()`. Keeping these methods on `ThreadComposer` preserves the API contract without changing `ComposeModal`.
- `ThreadComposer` is currently 427 lines. Extracting card rendering (~150 lines of template + styles) into `ThreadFlowCard` and flow layout (~80 lines) into `ThreadFlowLane` drops it to ~200 lines.
- `ThreadFlowCard` at ~200 lines and `ThreadFlowLane` at ~120 lines are both well under the 500-line limit.
- This follows the existing crate pattern (`commands/settings/` → thin orchestrator + focused submodules).

### D3: Separator as part of ThreadFlowCard (not a standalone component)

**Decision**: Each `ThreadFlowCard` renders its own separator line below it (except the last card). The separator is not a standalone `ThreadSeparator.svelte` component.

**Rationale**:
- The separator is tightly coupled to the card above it (shows that card's char count, provides actions for that card).
- Making it part of `ThreadFlowCard` keeps the component self-contained and avoids cross-component coordination.
- The separator's hover actions (drag handle, merge/remove) are card-level operations that map directly to the card's callbacks.
- This keeps the total component count lower while staying well under line limits.
- The architecture doc's `ThreadSeparator.svelte` was designed for the contenteditable model where separators are free-standing dividers. In the textarea model, separators are card footers.

### D4: Keep mode switching in ComposeModal (no content-determined mode yet)

**Decision**: `ComposeModal` still switches between `TweetEditor` (tweet mode) and `ThreadComposer` (thread mode) using the existing `mode` state. Mode unification is deferred.

**Rationale**:
- Unifying modes requires merging `tweetText` (string) and `threadBlocks` (ThreadBlock[]) state, reconciling the media models (`AttachedMedia[]` in TweetEditor vs `string[]` in MediaSlot/ThreadComposer), and changing submission logic.
- `ComposeModal` is already at 488 lines. Adding mode derivation logic pushes it further.
- The Session 2 handoff constraint says "ComposerShell and ComposerHeaderBar should not need changes." Mode unification would require changes to both (preview toggle in header).
- Session 4 (Inspector) is the natural home for this, alongside moving VoiceContext/TimePicker/FromNotes into the inspector rail.

**Scope cut documented**: Future session should unify `TweetEditor` + `ThreadComposer` into a single `ThreadFlowLane` that handles both modes. `ComposeModal` would derive mode from block count (1 block = tweet, 2+ = thread).

### D5: Cmd+Shift+Enter for separator insertion (not Cmd+Enter)

**Decision**: Use `Cmd+Shift+Enter` to insert a separator/split at cursor position. Keep `Cmd+Enter` as submit.

**Rationale**:
- `Cmd+Enter` is already the submit shortcut in `ComposeModal` (line 198). Changing it breaks muscle memory and existing documentation.
- The Typefully model uses `Cmd+Enter` for separator, but that means submit must use a different shortcut. This is a significant behavior change that should be validated with users before committing.
- `Cmd+Shift+Enter` is intuitive (Shift modifies Enter to mean "break/split" rather than "send"), conflict-free, and discoverable via the command palette.
- Document the tradeoff: a future session could swap these if user feedback prefers the Typefully model.

### D6: Action buttons move to separator + keyboard (deprecate ThreadCardActions inline display)

**Decision**: The separator line between cards shows char count + drag handle + merge/remove on hover. Split and duplicate are keyboard-only (Cmd+Shift+S, Cmd+D) and command palette actions. The `ThreadCardActions` component is no longer imported by the new flow.

**Rationale**:
- The current `ThreadCardActions` shows 2-4 action buttons on every card's footer. In a 5-tweet thread, that's 20 buttons competing for attention — exactly the "form-filling" problem the charter identifies.
- Typefully shows minimal affordances on separators. Split/duplicate are power-user operations that belong behind keyboard shortcuts and the command palette.
- Merge/remove are the most common separator-level operations and deserve visible hover affordances on the separator line.
- `ThreadCardActions.svelte` is NOT deleted — it's kept in the codebase but no longer imported. It can be removed in a cleanup pass.

### D7: Inline preview toggle deferred to Session 4

**Decision**: Keep the collapsible preview section below the editor (as implemented in Session 2). Do NOT add preview toggle to `ComposerHeaderBar`.

**Rationale**:
- The Session 2 handoff anticipated this: "Session 3 will replace the collapsible preview with an inline preview toggle in ComposerHeaderBar." However, the actual Session 3 task list focuses entirely on thread editor internals and media.
- Adding inline preview toggle requires: (1) new props on ComposerHeaderBar, (2) preview mode state in ComposeModal, (3) conditional rendering to swap editor/preview in ComposerCanvas. This is orthogonal to the thread flow work.
- Session 4 (Inspector & Polish) is a better home — the inline preview toggle belongs alongside the inspector rail toggle in the header.

### D8: MediaSlot visual refinement, no cross-card drag

**Decision**: Refine MediaSlot visuals (larger thumbnails, cleaner attach button, drop zone styling). Do NOT implement drag-and-drop media between cards.

**Rationale**:
- Cross-card media drag requires: (1) HTML5 drag-and-drop between separate MediaSlot instances, (2) coordinating state across two ThreadFlowCards, (3) media path ownership transfer in the parent. This is a multi-day feature.
- The task says "a path toward moving media between cards if feasible." The path: each MediaSlot could emit a `onmove(path, direction)` event, and the parent (ThreadComposer) would handle the transfer. This interface is documented in the handoff for a future session.
- For this session, media feels more integrated by: removing the gap between textarea and media, making thumbnails slightly larger (48→56px), and showing a cleaner empty-state drop zone.

---

## Files to Create

### 1. `dashboard/src/lib/components/composer/ThreadFlowCard.svelte` (~200 lines)

**Role**: Individual card in the connected flow. Renders borderless textarea, media slot, and separator line below.

**Props**:
```typescript
{
  block: ThreadBlock;              // block data
  index: number;                   // 0-based position
  total: number;                   // total card count
  focused: boolean;                // whether this card is focused
  assisting: boolean;              // whether AI is processing this card
  dragging: boolean;               // whether this card is being dragged
  dropTarget: boolean;             // whether this is a drop target
  ontext: (text: string) => void;  // text change
  onfocus: () => void;             // card focused
  onblur: () => void;              // card blurred
  onkeydown: (e: KeyboardEvent) => void;  // keyboard event
  onmedia: (paths: string[]) => void;     // media change
  onmerge: () => void;             // merge with next (separator action)
  onremove: () => void;            // remove card (separator action)
  ondragstart: (e: DragEvent) => void;    // drag from separator handle
  ondragend: () => void;
  ondragover: (e: DragEvent) => void;     // card-level drag target
  ondragenter: (e: DragEvent) => void;
  ondragleave: (e: DragEvent) => void;
  ondrop: (e: DragEvent) => void;
}
```

**Template structure**:
```html
<div class="flow-card" class:focused class:assisting class:dragging class:drop-target>
  <div class="card-writing-area">
    <textarea class="flow-textarea" .../>
    <MediaSlot mediaPaths={block.media_paths} onmediachange={onmedia} />
  </div>
  {#if index < total - 1}
    <div class="card-separator">
      <span class="sep-char-count">{charCount}/{maxChars}</span>
      <div class="sep-handle" draggable="true">
        <GripVertical size={12} />
      </div>
      <div class="sep-actions">
        {#if total > 2}
          <button class="sep-action-btn" onclick={onmerge}>
            <Merge size={12} />
          </button>
          <button class="sep-action-btn sep-remove" onclick={onremove}>
            <Trash2 size={12} />
          </button>
        {/if}
      </div>
    </div>
  {/if}
</div>
```

**Key CSS**:
- `.flow-card`: No border, no border-radius, no background. Transparent container.
- `.flow-textarea`: No border, transparent background, `padding: 12px 0`, full width, `font-size: 14px`, `line-height: 1.5`. Focus: `outline: none`.
- `.card-writing-area`: `border-left: 2px solid transparent`. When `.focused`: `border-left-color: var(--color-accent)`. Padding-left: 12px.
- `.card-separator`: `height: 32px`, flex row, `border-top: 1px solid var(--color-border-subtle)`, `margin: 4px 0 8px`.
- `.sep-handle`, `.sep-actions`: `opacity: 0`, transition 150ms, visible on `.card-separator:hover`.
- `.sep-char-count`: `font-size: 11px`, `font-family: var(--font-mono)`, `color: var(--color-text-subtle)`.
- Over-limit state: char count turns `--color-danger`, textarea gets `border-left: 2px solid var(--color-danger)`.
- Warning state (260-280): char count turns `--color-warning`.
- Assisting state: `opacity: 0.7`, `pointer-events: none`.
- Mobile: textarea font bumps to 16px, touch targets ≥ 44px.

### 2. `dashboard/src/lib/components/composer/ThreadFlowLane.svelte` (~120 lines)

**Role**: Connected flow container rendering ThreadFlowCards. Handles the overall flow layout.

**Props**:
```typescript
{
  blocks: ThreadBlock[];           // sorted blocks to render
  focusedBlockId: string | null;
  assistingBlockId: string | null;
  draggingBlockId: string | null;
  dropTargetBlockId: string | null;
  // Card event forwarding
  ontext: (id: string, text: string) => void;
  onfocus: (id: string) => void;
  onblur: (id: string) => void;
  onkeydown: (e: KeyboardEvent, id: string) => void;
  onmedia: (id: string, paths: string[]) => void;
  onmerge: (id: string) => void;
  onremove: (id: string) => void;
  ondragstart: (e: DragEvent, id: string) => void;
  ondragend: () => void;
  ondragover: (e: DragEvent, id: string) => void;
  ondragenter: (e: DragEvent, id: string) => void;
  ondragleave: (e: DragEvent, id: string) => void;
  ondrop: (e: DragEvent, id: string) => void;
  onaddcard: () => void;
}
```

**Template structure**:
```html
<div class="flow-lane" role="list" aria-label="Thread editor">
  <div class="sr-only" role="status" aria-live="polite">{announcement}</div>
  {#each blocks as block, i (block.id)}
    <ThreadFlowCard
      {block}
      index={i}
      total={blocks.length}
      focused={focusedBlockId === block.id}
      assisting={assistingBlockId === block.id}
      dragging={draggingBlockId === block.id}
      dropTarget={dropTargetBlockId === block.id}
      ontext={(text) => ontext(block.id, text)}
      onfocus={() => onfocus(block.id)}
      onblur={() => onblur(block.id)}
      onkeydown={(e) => onkeydown(e, block.id)}
      onmedia={(paths) => onmedia(block.id, paths)}
      onmerge={() => onmerge(block.id)}
      onremove={() => onremove(block.id)}
      ondragstart={(e) => ondragstart(e, block.id)}
      ondragend={ondragend}
      ondragover={(e) => ondragover(e, block.id)}
      ondragenter={(e) => ondragenter(e, block.id)}
      ondragleave={(e) => ondragleave(e, block.id)}
      ondrop={(e) => ondrop(e, block.id)}
    />
  {/each}
  <button class="add-separator-btn" onclick={onaddcard}>
    <Plus size={12} /> Add tweet
  </button>
</div>
```

**Key CSS**:
- `.flow-lane`: `display: flex; flex-direction: column; gap: 0;` — no gap between cards, separators handle spacing.
- `.add-separator-btn`: Minimal dashed-border button (like current `add-card-btn`), shown below the last card.

**Why this component exists**: Separates rendering concerns from state management. `ThreadComposer` handles mutations; `ThreadFlowLane` handles layout. This keeps both under 300 lines.

---

## Files to Modify

### 3. `dashboard/src/lib/components/ThreadComposer.svelte` (427 → ~220 lines)

**Changes**:

1. **Remove inline card template** (~100 lines of `{#each}` block with card HTML removed from lines 322-384).
2. **Remove inline card styles** (~50 lines of card CSS removed from lines 387-425).
3. **Import and render `ThreadFlowLane`** instead of inline cards.
4. **Add `Cmd+Shift+Enter` handler** in `handleCardKeydown`: calls `splitBlock(blockId)` or `addBlock()` if cursor is at end.
5. **Add `Backspace at position 0` handler** in `handleCardKeydown`: calls `mergeWithPrevious(blockId)` (new method, reverse of `mergeWithNext`).
6. **New method: `mergeWithPrevious(id)`** — merges current block into the previous one. This is the keyboard counterpart to the separator's merge button.
7. **Pass `reorderAnnouncement` to ThreadFlowLane** via prop.

**What stays**: All state (`blocks`, `focusedBlockId`, `draggingBlockId`, `dropTargetBlockId`), all block operations (`addBlock`, `removeBlock`, `updateBlockText`, `updateBlockMedia`, `moveBlock`, `focusBlock`, `duplicateBlock`, `splitBlock`, `mergeWithNext`, `normalizeOrder`), all drag handlers, all exported methods (`getBlocks`, `setBlocks`, `handleInlineAssist`, `handlePaletteAction`), validation logic.

**Template becomes**:
```html
<ThreadFlowLane
  blocks={sortedBlocks}
  {focusedBlockId}
  {assistingBlockId}
  {draggingBlockId}
  {dropTargetBlockId}
  ontext={updateBlockText}
  onfocus={(id) => { focusedBlockId = id; }}
  onblur={(id) => { if (focusedBlockId === id) focusedBlockId = null; }}
  onkeydown={handleCardKeydown}
  onmedia={updateBlockMedia}
  onmerge={mergeWithNext}
  onremove={removeBlock}
  ondragstart={handleDragStart}
  ondragend={handleDragEnd}
  ondragover={handleCardDragOver}
  ondragenter={handleCardDragEnter}
  ondragleave={handleCardDragLeave}
  ondrop={handleCardDrop}
  onaddcard={addBlock}
/>
{#if mergeError}<div class="merge-error" role="alert">{mergeError}</div>{/if}
{#if validationErrors.length > 0}
  <div class="validation-summary" role="status" aria-live="polite">
    {#each validationErrors as err}<p class="validation-error">{err}</p>{/each}
  </div>
{/if}
```

### 4. `dashboard/src/lib/components/MediaSlot.svelte` (293 → ~280 lines)

**Changes** (visual refinement, no API changes):

1. **Thumbnail size**: 48px → 56px (`.thumb` width/height).
2. **Remove gap between textarea and media**: `.media-slot` margin-top: 4px → 0. Padding-top: 4px only when media is present.
3. **Drop zone styling**: When `mediaPaths.length === 0` and `canAttachMore`, show a subtle dashed-border drop zone (1px dashed `--color-border-subtle`, `border-radius: 6px`, `padding: 8px`, `opacity: 0` → `opacity: 1` on `.flow-card:hover`). This makes it clear where media can be attached without cluttering the default view.
4. **Attach button**: Smaller, more subtle. Text changes: "Attach media" → icon-only with tooltip when media already present.

### 5. `dashboard/src/lib/components/TweetPreview.svelte` (137 → ~140 lines)

**Minimal changes**: No structural changes needed. Preview synchronization is already handled by `ComposeModal` passing `sortedPreviewBlocks` to `ThreadPreviewRail`. The refactored `ThreadComposer` still emits blocks via `onchange` exactly as before.

Only change: ensure the preview handles empty `mediaPaths` gracefully (already does, but verify).

### 6. `dashboard/src/lib/components/ComposeModal.svelte` (489 → ~490 lines)

**Minimal changes**:
1. **No structural changes** — `ComposeModal` still renders `TweetEditor` in tweet mode and `ThreadComposer` in thread mode.
2. **Command palette action**: Add `'add-separator'` action ID mapping (passes through to `threadComposerRef.handlePaletteAction('add-card')`). This is optional — the existing `'add-card'` action works fine.
3. **Verify**: Preview section still receives `sortedPreviewBlocks` correctly after ThreadComposer refactor. (It will — the `onchange` contract is unchanged.)

---

## Files NOT Changed

| File | Reason |
|------|--------|
| `composer/ComposerShell.svelte` | Session 2 output, no changes needed (D7) |
| `composer/ComposerHeaderBar.svelte` | Preview toggle deferred to Session 4 (D7) |
| `composer/ComposerCanvas.svelte` | ThreadFlowLane renders inside the existing children snippet |
| `composer/TweetEditor.svelte` | Tweet mode unchanged (D4) |
| `composer/ThreadPreviewRail.svelte` | Receives blocks via same props contract |
| `composer/VoiceContextPanel.svelte` | Moves to inspector in Session 4 |
| `composer/CommandPalette.svelte` | Existing thread actions work with new flow |
| `composer/MediaCropPreview.svelte` | Preview rendering unchanged |
| `FromNotesPanel.svelte` | Unchanged |
| `TimePicker.svelte` | Unchanged |
| All Rust files | No backend changes |

---

## Order of Operations

### Phase 1: Create ThreadFlowCard (foundation)

1. Create `dashboard/src/lib/components/composer/ThreadFlowCard.svelte`.
2. Implement the borderless card template: textarea, MediaSlot, separator line.
3. Style the connected flow appearance: no card borders, accent bar focus, separator with char count / hover actions.
4. This component is purely presentational — all events forwarded to parent via callbacks.

### Phase 2: Create ThreadFlowLane (container)

1. Create `dashboard/src/lib/components/composer/ThreadFlowLane.svelte`.
2. Renders `ThreadFlowCard` instances from a sorted blocks array.
3. Includes the "Add tweet" button at the bottom.
4. Forwards all events to parent with block ID binding.
5. Screen reader live region for reorder announcements.

### Phase 3: Refactor ThreadComposer (state orchestrator)

1. Remove inline card template from `ThreadComposer.svelte` (lines 319-385).
2. Remove inline card styles (lines 387-427).
3. Import `ThreadFlowLane`, render it with blocks and callbacks.
4. Add `mergeWithPrevious(id)` method (reverse of `mergeWithNext`).
5. Add `Cmd+Shift+Enter` handler in `handleCardKeydown`:
   - If cursor is at end of text (or text is empty): call `addBlock()` after current block's index, focus the new block.
   - If cursor is in the middle: call `splitBlock(blockId)`.
6. Add `Backspace at position 0` handler in `handleCardKeydown`:
   - If cursor is at position 0 and there's a previous block: call `mergeWithPrevious(blockId)`.
7. Keep all exported methods (`getBlocks`, `setBlocks`, `handleInlineAssist`, `handlePaletteAction`).
8. Verify `ThreadCardActions` import is removed (actions now in ThreadFlowCard separator).

### Phase 4: Refine MediaSlot

1. Increase thumbnail size (48 → 56px).
2. Remove margin-top gap.
3. Add subtle hover-revealed drop zone in empty state.
4. Minor attach button refinement.

### Phase 5: Verify integration

1. Test thread creation workflow: open modal → switch to thread mode → type in first card → Cmd+Shift+Enter → type in second card → preview updates.
2. Test all keyboard shortcuts: Tab between cards, Alt+Arrow reorder, Cmd+D duplicate, Cmd+Shift+S split, Cmd+Shift+M merge, Backspace-at-start merge.
3. Test drag-and-drop reordering via separator handles.
4. Test media attachment per card.
5. Test AI inline assist (Cmd+J in thread mode).
6. Test command palette thread actions.
7. Test autosave and recovery.

### Phase 6: Quality gates

```bash
cargo fmt --all && cargo fmt --all --check
RUSTFLAGS="-D warnings" cargo test --workspace
cargo clippy --workspace -- -D warnings
cd dashboard && npm run check
cd dashboard && npm run build
```

### Phase 7: Write session handoff

Create `docs/roadmap/composer-ui-typefully-plus/session-03-handoff.md` documenting:
- Files changed
- Decisions made
- Scope cuts
- Risk register update
- What Session 4 needs

---

## Risks and Mitigations

| # | Risk | Severity | Mitigation |
|---|------|----------|------------|
| R1 | Textarea focus management between cards | Medium | Preserve existing `focusBlock()` logic (querySelector + focus). Test Tab/Shift+Tab navigation. |
| R2 | Drag-and-drop regression | Medium | Keep all drag handlers in ThreadComposer (proven working). Only change is drag handle moves from card gutter to separator. |
| R3 | CSS specificity conflicts | Low | ThreadFlowCard uses scoped styles. No global selectors needed (unlike current `ThreadCardActions` which uses `:global(.tweet-card:hover)`). |
| R4 | ThreadComposer exported methods break | Medium | Methods are unchanged — only template extraction. Test via `bind:this` calls from ComposeModal. |
| R5 | MediaSlot visual changes break attachment | Low | No prop/API changes. Only CSS modifications. |
| R6 | Separator drag reorder confusion | Low | Drag handle on separator reorders the card above it. Tooltip clarifies: "Drag to reorder." |
| R7 | ComposeModal line count bloat | Low | Minimal changes to ComposeModal (~5 lines). Stays at ~490. |
| R8 | ThreadFlowCard exceeds 500 lines | Low | Estimated at ~200 lines. Separator is integrated, not a separate component. |
| R9 | Autosave format breakage | Low | Zero changes to data model. ThreadBlock[] emitted identically. |

---

## Scope Cuts (Documented for Handoff)

### SC1: Content-determined mode (unified editor)
**What**: A single editor component handles both tweet and thread modes. Mode is derived from block count (1 = tweet, 2+ = thread). TweetEditor is deprecated.
**Why deferred**: Requires merging media models (`AttachedMedia[]` vs `string[]`), changing ComposeModal state management, and updating submission logic. Too much scope alongside the visual redesign.
**When**: Session 4 or 5.

### SC2: Inline preview toggle in header
**What**: ComposerHeaderBar gets a preview toggle button (Eye icon). Clicking it swaps the editor canvas for preview rendering in the same space.
**Why deferred**: The Session 3 tasks focus on thread editor internals. Preview toggle is orthogonal and belongs with the inspector rail work.
**When**: Session 4 (Inspector & Polish).

### SC3: Cross-card media drag-and-drop
**What**: Drag a media thumbnail from one card's MediaSlot and drop it on another card.
**Why deferred**: Requires HTML5 drag-and-drop coordination across separate component instances and state transfer in the parent. The interface is designed for it (MediaSlot could emit `onmove(path, direction)`), but implementation is multi-day.
**When**: Future session, post-Session 5.

### SC4: Cmd+Enter for separator (Typefully model)
**What**: Swap Cmd+Enter from "submit" to "add separator." Use Cmd+Shift+Enter or a different shortcut for submit.
**Why deferred**: Breaking the established submit shortcut requires user validation. The current Cmd+Shift+Enter for separator is safe and discoverable.
**When**: Evaluate based on user feedback after Session 5 release.

### SC5: ThreadCardActions component removal
**What**: Delete `composer/ThreadCardActions.svelte` since its functionality moved to separator hover + keyboard.
**Why deferred**: The file is no longer imported but isn't hurting anything. Clean up in a maintenance pass.
**When**: Session 5 (Validation & Release) cleanup sweep.

---

## Keyboard Shortcuts (Final State After Session 3)

| Shortcut | Context | Behavior | Status |
|----------|---------|----------|--------|
| Cmd+K | Modal | Open command palette | Unchanged |
| Cmd+Enter | Modal | Submit | Unchanged |
| Cmd+Shift+F | Modal | Toggle focus mode | Unchanged |
| Cmd+J | Modal | AI inline assist | Unchanged |
| Cmd+Shift+N | Modal | Switch to tweet mode | Unchanged |
| Cmd+Shift+T | Modal | Switch to thread mode | Unchanged |
| Escape | Modal | Close (layered) | Unchanged |
| **Cmd+Shift+Enter** | **Card textarea** | **Insert separator / split at cursor** | **NEW** |
| **Backspace (at pos 0)** | **Card textarea** | **Merge with previous card** | **NEW** |
| Tab | Card textarea | Focus next card | Unchanged |
| Shift+Tab | Card textarea | Focus previous card | Unchanged |
| Alt+ArrowUp | Card textarea | Move card up | Unchanged |
| Alt+ArrowDown | Card textarea | Move card down | Unchanged |
| Cmd+D | Card textarea | Duplicate card | Unchanged |
| Cmd+Shift+S | Card textarea | Split at cursor | Unchanged |
| Cmd+Shift+M | Card textarea | Merge with next | Unchanged |

---

## Estimated Line Counts

| File | Before | After | Delta |
|------|--------|-------|-------|
| `composer/ThreadFlowCard.svelte` | — | ~200 | +200 |
| `composer/ThreadFlowLane.svelte` | — | ~120 | +120 |
| `ThreadComposer.svelte` | 427 | ~220 | -207 |
| `MediaSlot.svelte` | 293 | ~280 | -13 |
| `TweetPreview.svelte` | 137 | ~140 | +3 |
| `ComposeModal.svelte` | 489 | ~490 | +1 |
| **Net** | **1,346** | **~1,450** | **+104** |

New code is +320 lines across 2 new files. Extraction from ThreadComposer removes ~207 lines. Net increase of ~104 lines, all within file-size limits.

---

## Verification Checklist

### Functional
- [ ] Thread creation: type → Cmd+Shift+Enter → type → see 2 cards in flow
- [ ] Card navigation: Tab / Shift+Tab moves between cards
- [ ] Card reorder: Alt+Up/Down, drag handle on separator
- [ ] Split: Cmd+Shift+S splits at cursor with word-boundary snapping
- [ ] Merge: Cmd+Shift+M merges with next, Backspace-at-0 merges with previous
- [ ] Duplicate: Cmd+D duplicates current card
- [ ] Remove: Separator remove button removes card (if > 2 cards)
- [ ] Media: Attach, remove, drag-drop upload per card
- [ ] AI assist: Cmd+J improves focused card's text
- [ ] Command palette: All thread actions work (add, duplicate, split, merge, move)
- [ ] Preview: ThreadPreviewRail updates in real-time with block changes
- [ ] Autosave: Draft saves to localStorage with correct ThreadBlock[] format
- [ ] Recovery: Recovered draft loads correctly into refactored ThreadComposer
- [ ] Validation: 2+ non-empty blocks required, char limit per block, media limit per block
- [ ] Submit: Cmd+Enter submits thread correctly

### Visual
- [ ] No card borders — clean writing surface
- [ ] Focused card shows left accent bar (2px --color-accent)
- [ ] Separator lines between cards with char count
- [ ] Drag handle and merge/remove appear on separator hover
- [ ] Over-limit state: red accent bar, red char count
- [ ] Warning state (260-280): yellow char count
- [ ] AI assisting state: card faded, pointer-events: none
- [ ] Drop target: dashed border during drag

### Responsive
- [ ] Mobile (≤640px): textarea font 16px, touch targets ≥ 44px
- [ ] Modal still works at 640px width (no horizontal overflow)
- [ ] Touch devices: separator actions always visible (no hover)

### CI
- [ ] `cargo fmt --all && cargo fmt --all --check` — pass
- [ ] `RUSTFLAGS="-D warnings" cargo test --workspace` — pass
- [ ] `cargo clippy --workspace -- -D warnings` — pass
- [ ] `cd dashboard && npm run check` — pass (0 errors)
- [ ] `cd dashboard && npm run build` — pass
