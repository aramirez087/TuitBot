# Session 04 Implementation Plan — Validation & Go/No-Go

## Mission

Validate the completed composer overhaul across Sessions 01–03, fix ship-blocking regressions, update docs to match delivered code, and produce an explicit go/no-go release decision.

## Current State Summary

### What was delivered

**Session 02 (Distraction-Free Writer):**
- ComposeModal refactored from 1,273 → 454 lines (orchestrator)
- New: ComposerShell (516), TweetEditor (327), VoiceContextPanel (284), ThreadCardActions (124)
- Generator module split: mod.rs (490), parser.rs (55), tests.rs (317)
- `_with_context` methods added to ContentGenerator for tweet, thread, and reply
- VoiceContextPanel with brand_voice/content_style/pillars display, quick-cue input, saved cues MRU
- FromNotesPanel enhanced: inline confirmation, shimmer, 10-second undo
- Voice cue threaded into all AI assist calls

**Session 03 (X-Accurate Preview):**
- New: mediaDimensions.ts (62), MediaCropPreview.svelte (186), ThreadPreviewRail.svelte (89)
- TweetPreview rewritten: 191 → 137 lines, delegates to MediaCropPreview
- Unified compose-layout for both tweet and thread modes (editor | preview grid)
- 1/2/3/4 image grids matching X's CSS patterns
- Crop severity indicator (>30% threshold)
- Video poster frame with play icon overlay
- Mobile stacking (<768px)

### File size audit (confirmed)

| File | Lines | Status |
|------|-------|--------|
| ComposeModal.svelte | 454 | Over 400 — D11 justified |
| ComposerShell.svelte | 516 | Over 400 — pre-existing from S02 |
| ThreadComposer.svelte | 426 | Over 400 — D6 justified |
| TweetPreview.svelte | 137 | OK |
| FromNotesPanel.svelte | 313 | OK |
| MediaSlot.svelte | 293 | OK |
| TweetEditor.svelte | 327 | OK |
| VoiceContextPanel.svelte | 284 | OK |
| ThreadCardActions.svelte | 124 | OK |
| MediaCropPreview.svelte | 186 | OK |
| ThreadPreviewRail.svelte | 89 | OK |
| mediaDimensions.ts | 62 | OK |
| generator/mod.rs | 490 | OK (under 500) |
| generator/parser.rs | 55 | OK |
| generator/tests.rs | 317 | OK |
| assist.rs | 276 | OK |
| compose_contract_tests.rs | 659 | Test file — limit doesn't apply |

---

## Execution Plan

### Phase 1: Run All Quality Gates (first, before any changes)

**Order of operations:**

1. **Rust formatting:**
   ```bash
   cargo fmt --all && cargo fmt --all --check
   ```

2. **Rust tests:**
   ```bash
   RUSTFLAGS="-D warnings" cargo test --workspace
   ```

3. **Rust linting:**
   ```bash
   cargo clippy --workspace -- -D warnings
   ```

4. **Frontend type-check:**
   ```bash
   cd dashboard && npm run check
   ```

5. **Frontend build:**
   ```bash
   cd dashboard && npm run build
   ```

**Decision point:** If any gate fails, categorize the failure:
- **Ship-blocking**: fix immediately in Phase 2
- **Pre-existing / cosmetic**: document in release-readiness report as known limitation

**Risk:** The Rust CI gates might fail if there were any upstream changes on `feat/ghostwriter_improvements` that introduced warnings. Mitigation: inspect failures carefully; fix only what's attributable to Sessions 02–03 work or is a genuine ship-blocker.

### Phase 2: Fix Ship-Blocking Regressions (only if Phase 1 fails)

**Scope:** Only fix issues that prevent the quality gates from passing. Do not refactor, improve, or beautify code beyond what's necessary.

**Possible issues and mitigations:**

| Potential Issue | Likely Cause | Fix Strategy |
|----------------|--------------|--------------|
| Clippy warnings in generator/mod.rs | New `_with_context` methods may trigger clippy | Add targeted `#[allow]` or fix the code |
| svelte-check type errors | Svelte 5 runes type inference | Fix prop types or add type annotations |
| Build failure in dashboard | Import path changes from S02/S03 | Verify all import paths are correct |
| Test failures in compose_contract_tests | Unlikely — tests were passing in S02 | Re-run; if flaky, investigate isolation |

**Files that may need fixes (targeted only):**
- `crates/tuitbot-core/src/content/generator/mod.rs`
- `crates/tuitbot-server/src/routes/assist.rs`
- `dashboard/src/lib/components/ComposeModal.svelte`
- `dashboard/src/lib/components/composer/*.svelte`

### Phase 3: Charter Verification Audit

Systematically verify each charter deliverable against the actual code.

#### Pillar 1: Distraction-Free Writing Assistance

| Charter Item | Expected | Verification Method |
|-------------|----------|-------------------|
| Voice context bar | Collapsible panel showing brand_voice, content_style, up to 3 pillars | Read VoiceContextPanel.svelte — confirm props, settings store subscription, localStorage persistence |
| Quick-cue input | One-line text field, threaded into all assist calls | Read ComposeModal.svelte — confirm `voiceCue` flows to `api.assist.improve()`, `api.assist.tweet()`, `api.assist.thread()` |
| Saved cue shortcuts | MRU list (up to 5) in localStorage | Read VoiceContextPanel.svelte — confirm `SAVED_CUES_KEY`, `MAX_SAVED_CUES=5`, `saveCueToHistory()` |
| Winning DNA integration | **Deferred (D5)** — `_with_context` methods exist but no winning DNA module | Confirm in assist.rs that handlers still call `generate_tweet()` not `generate_tweet_with_context()` — this is expected deferred work |
| Notes → tweet/thread | Inline confirmation, shimmer, 10s undo | Read FromNotesPanel.svelte — confirm `confirmReplace` flow, `.loading-shimmer`, undo button |
| Component extraction | ComposeModal ≤400 target | Actual: 454 (D11 justified). Document deviation. |

#### Pillar 2: High-Fidelity Thread Preview

| Charter Item | Expected | Verification Method |
|-------------|----------|-------------------|
| X-accurate 1-image grid | 16:9 landscape crop | Read mediaDimensions.ts — confirm `X_SLOT_RATIOS[1] = [16/9]`; MediaCropPreview `.single` CSS |
| X-accurate 2-image grid | Side-by-side ~4:5 | Confirm `X_SLOT_RATIOS[2] = [4/5, 4/5]`; `.double` CSS |
| X-accurate 3-image grid | Left tall + right stacked | Confirm `X_SLOT_RATIOS[3] = [2/3, 1, 1]`; `.triple` CSS with `grid-row: 1/3` |
| X-accurate 4-image grid | 2x2 squares | Confirm `X_SLOT_RATIOS[4] = [1, 1, 1, 1]`; `.quad` CSS |
| Crop indicator | Badge when severity >30% | Confirm `CROP_SEVERITY_THRESHOLD = 0.3`, `.crop-badge` element |
| Tweet-mode preview | Preview alongside editor on desktop | Confirm `.compose-layout` grid in ComposeModal, ThreadPreviewRail handles `mode='tweet'` |
| Mobile stacking | Vertical below 768px | Confirm `@media (max-width: 768px)` in ComposeModal changes grid to `1fr` |
| Video poster frame | First frame + play icon | Confirm `<video preload="metadata">` + `.play-overlay` SVG in MediaCropPreview |

### Phase 4: Code Audit — Functional Flows

Read through each flow in the code to verify correctness (no runtime execution available, so this is static analysis).

#### 4a. Focus mode
- **Entry:** `ComposeModal.svelte:185` — `toggleFocusMode()` sets `focusMode = !focusMode`
- **CSS:** ComposerShell `.modal.focus-mode` — 100vw/100vh, no border-radius, flex column
- **Exit:** Escape cascade in `handleKeydown` — line 195-200
- **Preview in focus mode:** `.compose-layout` is inside `.modal-body` which gets `flex: 1` in focus mode — preview should be visible
- **Verify:** All keyboard shortcuts still dispatch via `handleKeydown` regardless of `focusMode`

#### 4b. Notes-to-thread flow
- **Entry:** ComposeModal line 244 `handleGenerateFromNotes`
- **Thread mode:** Calls `api.assist.thread()` with optional voice cue prepended
- **Tweet mode:** Calls `api.assist.improve()` with cue as context
- **Undo:** `undoSnapshot` saved before generation, `showUndo` with 10s timer
- **Verify:** `showFromNotes` controls FromNotesPanel visibility; undo banner appears when `showUndo && !showFromNotes`

#### 4c. Thread restructuring
- **ThreadComposer.svelte** lines 100-260: moveBlock, duplicateBlock, splitBlock, mergeWithNext
- **Preview sync:** `onchange` callback triggers `threadBlocks` update in ComposeModal → `sortedPreviewBlocks` derived → ThreadPreviewRail re-renders
- **Verify:** All CRUD operations call `emitChange()` which calls `onchange([...blocks])`

#### 4d. Autosave recovery
- **Save:** ComposeModal line 74-85 — debounced 500ms to localStorage
- **Check:** `checkRecovery()` on open — line 87-99
- **Recover:** line 101-108 — restores mode, tweetText, threadBlocks
- **Clear:** On successful submit — line 172
- **Verify:** Recovery banner in ComposerShell line 71-79

#### 4e. Approval mode routing
- **ComposeModal.handleSubmit** sends data via `onsubmit(data)` — the compose endpoint handles approval routing server-side
- **Verify:** No changes to ComposeRequest interface; compose_contract_tests confirm both `"scheduled"` and `"queued_for_approval"` statuses

#### 4f. Scheduling flow
- **TimePicker** component receives `selectedTime` and `schedule` — unchanged
- **ComposeModal line 165-170:** Constructs `scheduled_for` from targetDate + selectedTime
- **Verify:** No changes to scheduling logic in any session

### Phase 5: Update Documentation

**File: `docs/composer-mode.md`**

Audit the current docs against delivered code and fix discrepancies:

1. **Voice Context section** — Verify the described behavior matches VoiceContextPanel.svelte exactly:
   - Confirm collapsible state persistence key matches (`tuitbot:voice:expanded`)
   - Confirm saved cues key matches (`tuitbot:voice:saved-cues`)
   - Confirm max 5 saved cues matches `MAX_SAVED_CUES = 5`

2. **Preview Fidelity section** — Verify media grid rules match mediaDimensions.ts:
   - Confirm aspect ratios match `X_SLOT_RATIOS`
   - Confirm threshold matches `CROP_SEVERITY_THRESHOLD = 0.3`

3. **Keyboard shortcuts table** — Verify all 14 shortcuts are listed and match the code:
   - ComposeModal.handleKeydown: Cmd+K, Cmd+Shift+F, Cmd+Enter, Cmd+J, Cmd+Shift+N, Cmd+Shift+T, Escape
   - ThreadComposer.handleCardKeydown: Alt+Up, Alt+Down, Cmd+D, Cmd+Shift+S, Cmd+Shift+M, Tab, Shift+Tab

4. **Generate from Notes section** — Verify inline confirmation, shimmer, undo are documented

5. **Migration Notes** — Ensure current (no stale references to old architecture)

6. **Known limitations** — Add any newly discovered limitations

**Changes expected:** Minor text corrections only. The doc was updated in S02 and S03 — likely needs only verification and minor alignment.

### Phase 6: Write Release-Readiness Report

**File: `docs/roadmap/typefully-beating-composer/release-readiness.md`**

Structure:

```
# Release Readiness Report — Composer Overhaul

## Decision: GO / NO-GO

## Evidence

### Pillar 1: Distraction-Free Writing Assistance
- [Shipped / Partial / Not shipped] for each charter item
- What improved vs baseline

### Pillar 2: High-Fidelity Thread Preview
- [Shipped / Partial / Not shipped] for each charter item
- What improved vs baseline

## Quality Gate Results
- Results from Phase 1

## File Size Audit
- Table with all files and compliance status

## Backward Compatibility
- ComposeRequest interface unchanged
- Contract test results
- API endpoint behavior preserved

## Known Limitations
- Winning DNA not wired (D5)
- 3 files over 400-line limit (D6, D11, ComposerShell)
- No URL unfurling
- No GIF animation toggle
- No quote-tweet/poll preview
- Client-side only dimension detection

## Deferred Items
- Winning DNA module + wiring
- ComposerShell/ComposeModal/ThreadComposer strict compliance
- Server-side image dimension metadata

## Follow-Up Recommendations
- Priority-ordered list of next improvements
```

### Phase 7: Write Session-04 Handoff

**File: `docs/roadmap/typefully-beating-composer/session-04-handoff.md`**

Structure:

```
# Session 04 Handoff — Validation & Release Decision

## What changed
- Documentation updates (if any)
- Bug fixes (if any)
- Release decision

## Quality gate results
- Full table of all gates

## Charter compliance summary
- Pillar 1 status
- Pillar 2 status

## Files modified in this session
- (list)

## Deferred items with exact file paths
- (list with paths)

## Release status
- GO / NO-GO with reasoning
```

---

## Exact Order of Operations

1. **Run quality gates** (Phase 1) — all 5 commands sequentially
2. **Fix blockers** (Phase 2) — only if Phase 1 fails
   - Re-run failed gates after each fix
   - Do not batch fixes; fix one issue at a time
3. **Charter verification** (Phase 3) — static audit against code already read
4. **Code flow audit** (Phase 4) — read through 6 functional flows
5. **Update docs/composer-mode.md** (Phase 5) — minor corrections only
6. **Write release-readiness.md** (Phase 6) — comprehensive report with evidence
7. **Write session-04-handoff.md** (Phase 7) — handoff for future work
8. **Final gate re-run** — if any files were modified in steps 2 or 5, re-run affected gates
9. **Verify deliverables** — confirm all 3 deliverable files exist and are complete

## Files to Create

| File | Purpose |
|------|---------|
| `docs/roadmap/typefully-beating-composer/release-readiness.md` | Go/no-go decision + evidence |
| `docs/roadmap/typefully-beating-composer/session-04-handoff.md` | Handoff for future sessions |

## Files to Potentially Modify

| File | Condition |
|------|-----------|
| `docs/composer-mode.md` | If any discrepancies found between docs and code |
| Any source file | Only if quality gates fail and require a ship-blocking fix |

## Key Design Decisions

### D13: No source code changes unless gates fail
Session 04 is a validation session. The implementation is done. Changes are only warranted if quality gates fail or documentation is inaccurate. No refactoring, no feature additions, no "improvements."

### D14: File size violations documented, not fixed
Three files exceed the 400-line Svelte limit: ComposeModal (454), ComposerShell (516), ThreadComposer (426). These were justified in D6 and D11. Session 04 documents them in the release report as known deviations, not blockers. Fixing them would require significant refactoring that risks regressions — exactly the wrong thing to do in a validation session.

### D15: Winning DNA is not a ship-blocker
The `_with_context` methods exist and are tested. The winning DNA module (`context/winning_dna.rs`) was never built (it doesn't exist in the codebase — D5). The assist handlers call the non-context methods, which is correct. This is deferred work, not a regression.

## Risks

| Risk | Likelihood | Mitigation |
|------|-----------|------------|
| Rust tests fail due to upstream changes | Low | Fix only what's related to S02-S03 work |
| svelte-check reports new errors | Low | S03 handoff confirmed 0 errors; check for dep updates |
| npm build fails | Very low | S03 handoff confirmed pass |
| Docs have significant inaccuracies | Low | Docs were updated in both S02 and S03 |
| File size regressions | None | Already measured; no source changes planned |

## Verification Checklist (from Session 03 handoff)

These items are verified through static code analysis in Phase 3-4:

- [audit] Thread mode: preview renders 2+ cards — ThreadPreviewRail uses `visibleBlocks` with `#each`
- [audit] Media grids: verified through X_SLOT_RATIOS and CSS grid classes
- [audit] Tweet mode: preview in `.compose-layout` grid, `mode='tweet'` handled by ThreadPreviewRail
- [audit] Mobile stacking: `@media (max-width: 768px)` in ComposeModal sets `grid-template-columns: 1fr`
- [audit] Crop indicator: `CROP_SEVERITY_THRESHOLD = 0.3`, `.crop-badge` shown when severity exceeds threshold
- [audit] Video: `<video preload="metadata">` + `.play-overlay` in MediaCropPreview
- [audit] Thread operations update preview: all CRUD ops call `emitChange()` → `onchange` → ComposeModal state → derived → preview
- [audit] Draft recovery: `checkRecovery()` on open, `recoverDraft()` restores state, preview re-renders from restored state
- [audit] Focus mode: `focusMode` CSS preserves `.compose-layout` inside `.modal-body` which gets `flex: 1`
- [audit] Empty states: ThreadPreviewRail lines 43 and 57 — correct text for each mode
- [audit] Approval mode: ComposeRequest unchanged; server handles routing
- [audit] Scheduling: selectedTime → scheduled_for construction unchanged
- [audit] Keyboard shortcuts: all 14 verified in handleKeydown + handleCardKeydown
- [CI] `npm run check` + `npm run build` — run in Phase 1
- [CI] Full Rust CI suite — run in Phase 1
