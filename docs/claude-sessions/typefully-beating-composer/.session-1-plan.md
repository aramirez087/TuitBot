# Session 1 Implementation Plan: Composer Overhaul Charter & Slicing

## Objective

Produce three deliverables — `charter.md`, `implementation-plan.md`, and `session-01-handoff.md` — under `docs/roadmap/typefully-beating-composer/`. No source code changes.

---

## Current State Assessment

### Codebase Inventory (what exists)

| Component | Lines | Status |
|-----------|-------|--------|
| `ComposeModal.svelte` | 1,273 | **3x over** 400-line limit |
| `ThreadComposer.svelte` | 858 | **2x over** 400-line limit |
| `TweetPreview.svelte` | 191 | Within limits |
| `FromNotesPanel.svelte` | 179 | Within limits |
| `MediaSlot.svelte` | 293 | Within limits |
| `content/+page.svelte` | 407 | Barely over limit |
| `server/routes/assist.rs` | 277 | Within limits |
| `server/routes/content/compose.rs` | 403 | Within limits |
| `compose_contract_tests.rs` | 660 | Test file — ok to exceed |

### Gap Analysis: Distraction-Free Writing Assistance

**What we have:**
- Focus mode (fullscreen modal) — structural feature exists
- From-notes panel that generates tweet/thread from pasted notes
- AI Improve (`Cmd+J`) on selection or full text
- AI Assist button (generate from scratch or improve)
- 14 keyboard shortcuts, command palette
- Auto-save with recovery

**What's missing vs "beats Typefully":**
1. **Voice awareness in assist** — The assist endpoints (`/api/assist/improve`, `/api/assist/tweet`, `/api/assist/thread`) call `ContentGenerator` which reads `brand_voice`, `reply_style`, `content_style` from config. But the compose UI has **zero visibility** into which voice settings are active. Users can't see or refine voice cues during composition.
2. **Reusable writer cues** — `persona_opinions`, `persona_experiences`, `content_pillars` exist in config but are never surfaced in the composer. The user must leave the modal, go to Settings, and edit them separately. There's no "I want this tone" quick-cue mechanism.
3. **Winning DNA context** — The `winning_dna` system extracts patterns from historical performance and injects them via RAG into replies. But **assist endpoints don't use it** — `assist_improve` just wraps the draft in a "rewrite" prompt without any historical context. The existing intelligence pipeline is disconnected from the composer.
4. **Notes-to-content UX** — `FromNotesPanel` works but: (a) destructive replacement with only a `confirm()` dialog, (b) no undo after generation, (c) no loading skeleton during generation, (d) thread generation loses source context after conversion.
5. **Oversized Svelte files** — `ComposeModal.svelte` (1,273 lines) and `ThreadComposer.svelte` (858 lines) both far exceed the 400-line limit. Any feature work amplifies the problem.

### Gap Analysis: High-Fidelity Thread Preview

**What we have:**
- `TweetPreview.svelte` — renders avatar placeholder, handle, text, and basic media grid
- Thread connector line between tweets
- Media grid with `single/double/triple/quad` CSS class variants
- Media images rendered via `object-fit: cover` at `16:9` aspect ratio

**What's missing vs "beats Typefully":**
1. **X-accurate media layouts** — X uses specific grid ratios depending on media count:
   - 1 image: 16:9 (landscape) or original ratio for tall images, max 512px tall
   - 2 images: side-by-side, each cropped to ~1:1 in a row
   - 3 images: one large left (2:1 aspect), two stacked right
   - 4 images: 2x2 grid, each ~1:1
   Current preview uses generic `16:9` for all items regardless of count, which misrepresents actual crop behavior.
2. **Intrinsic dimension awareness** — Preview shows images at fixed aspect ratio with no knowledge of the actual image dimensions. Users can't tell how their portrait vs landscape images will be cropped.
3. **Tweet-mode preview** — Preview only exists for thread mode. Tweet mode has no preview at all — you type into a textarea and see character count but no visual representation of how the tweet will look.
4. **Video thumbnail** — Videos in media grid show the raw `<video>` element with no play button overlay or poster frame, unlike X's presentation.
5. **Link card preview** — Tweets containing URLs show link cards on X. The preview doesn't detect or render these at all.

### Prior Session Plans (from `docs/claude-sessions/`)

Session plan documents (00-04) exist as **prompt templates** — they describe what each session should do but no actual artifacts (charter, implementation plan, handoffs) have been written yet under `docs/roadmap/typefully-beating-composer/`. That directory doesn't exist. This session is the first execution.

---

## Design Decisions

### D1: V1 Voice Learning Definition

**Decision:** "Learns your voice" in v1 means **transparent voice context threading**, not opaque model training.

Concretely:
1. **Voice summary visible in composer** — A collapsible panel shows the active `brand_voice`, `content_style`, and up to 3 `content_pillars` so the user knows what the AI will produce.
2. **Quick-cue overrides** — Before hitting "AI Improve" or "Generate from notes", the user can type a one-line instruction (e.g., "make it more casual", "add a hot take") that gets appended to the LLM prompt alongside the configured voice.
3. **Winning DNA injection** — Wire the existing `winning_dna::build_draft_context()` into the assist improve/tweet/thread endpoints so generated content draws from historically successful patterns. This is the actual "learning" — it already exists in core but isn't connected to the compose flow.
4. **Explicit cue persistence** — Frequently-used quick cues are saved to localStorage (top 5) so the user builds a personal shortcut palette over time. NOT stored server-side in v1.

**What v1 is NOT:** Auto-updating `brand_voice` config fields. No implicit style fingerprinting. No engagement-weighted archetype selection. Those are v2+.

**Rationale:** This approach uses existing infra (persona config, winning DNA, content generator context parameter), requires no DB migrations, and delivers visible value immediately. Users see exactly what the AI knows about their voice and can steer it per-request.

### D2: Preview Fidelity Scope

**Decision:** V1 preview emulates X's layout rules for text + images in threads and single tweets. It does NOT attempt link cards or video poster frames.

Concretely:
1. **X-accurate media grid** — 1/2/3/4 image layouts matching X's exact grid ratios:
   - 1 image: 16:9 landscape crop (X's default for uploaded images)
   - 2 images: side-by-side, each ~1:1
   - 3 images: large left (spanning full height) + two stacked right
   - 4 images: 2x2 grid
2. **Crop indicator overlay** — For images where the preview crops significantly (e.g., portrait photos in 16:9 slots), show a subtle dotted border or "cropped" indicator.
3. **Tweet-mode preview** — Add a preview pane for single tweets (not just threads), showing avatar + text + media in X style.
4. **Video: poster frame only** — Show first frame with a play icon overlay. No link card rendering.

**What's explicitly deferred:** Link card / URL unfurling preview. GIF animation toggle. Dark/light theme preview switching.

### D3: Component Refactoring Strategy

**Decision:** Extract `ComposeModal.svelte` into a `composer/` directory with focused subcomponents. Follow the existing `commands/settings/` pattern from CLAUDE.md.

Target structure:
```
dashboard/src/lib/components/composer/
  ComposerShell.svelte        — Modal chrome, focus mode, escape cascade, keyboard dispatch
  TweetEditor.svelte           — Tweet textarea, char counter, media for tweet mode
  ThreadEditor.svelte          — Card list (was ThreadComposer), validation
  PreviewRail.svelte           — Preview pane for both tweet and thread modes
  VoiceContextBar.svelte       — Voice summary + quick-cue input
  NotesToContentPanel.svelte   — Enhanced FromNotesPanel with undo + loading states
```

`ComposeModal.svelte` becomes a thin orchestrator importing these. Each subcomponent stays under 400 lines.

### D4: Backward Compatibility

**Decision:** No changes to compose request/response contracts in v1. Voice cues are sent as the existing `context` field on `/api/assist/improve`. Winning DNA injection happens server-side transparently. The `ComposeRequest` interface and all contract tests remain unchanged.

---

## Files to Create

| File | Purpose |
|------|---------|
| `docs/roadmap/typefully-beating-composer/charter.md` | Project charter: objectives, differentiators, v1 definitions, non-goals |
| `docs/roadmap/typefully-beating-composer/implementation-plan.md` | Session-by-session breakdown with file lists, risk controls, fallback cuts |
| `docs/roadmap/typefully-beating-composer/session-01-handoff.md` | What this session produced, decisions made, exact reading list for Session 02 |

## Files to Modify

None. This session is documentation-only.

---

## Exact Order of Operations

### Step 1: Create roadmap directory
```bash
mkdir -p docs/roadmap/typefully-beating-composer
```

### Step 2: Write `charter.md`

Content covers:
- **Objective** — Beat Typefully on two pillars
- **Pillar 1: Distraction-Free Writing Assistance** — What "writing-first" means, v1 voice learning definition (D1 above), what's in/out
- **Pillar 2: High-Fidelity Thread Preview** — What the preview must emulate (D2 above), fidelity rules, what's deferred
- **Hard constraints** — File size limits, backward compat, no placeholder UX, approval-mode preserved
- **Non-goals** — Link cards, auto voice training, analytics-driven generation tuning, SSR preview

### Step 3: Write `implementation-plan.md`

Structured as:

**Session 02: Distraction-Free Writer** (build session)
- Refactor ComposeModal into composer/ subcomponents (D3)
- Wire winning DNA into assist endpoints (core change)
- Add VoiceContextBar with voice summary + quick cues
- Enhance notes-to-content panel with loading states and undo
- Update contract tests if assist request shape changes
- Files touched: ~12 (6 new Svelte, 2 existing Svelte, 2 Rust, 1 API, 1 doc)
- Risk: Refactoring a 1,273-line file is error-prone → Mitigation: Extract one section at a time, run `npm run check` after each extraction
- Fallback cut: If running long, defer VoiceContextBar localStorage persistence (just keep the input, skip saved cues)

**Session 03: X-Accurate Preview** (build session)
- Replace TweetPreview with X-accurate layout component
- Add tweet-mode preview (currently missing)
- Implement 1/2/3/4 media grid layouts matching X ratios
- Add crop indicator for images losing significant content
- Add video poster frame with play overlay
- Keep preview synchronized with thread operations (reorder, split, merge)
- Files touched: ~8 (3 new Svelte, 3 existing Svelte, 1 utility, 1 doc)
- Risk: X layout rules may be complex to reverse-engineer accurately → Mitigation: Start with the 4 common grid patterns, accept minor spacing differences
- Fallback cut: If running long, drop crop indicator overlay (keep standard object-fit:cover)

**Session 04: Validation & Go/No-Go** (validation session)
- Run full CI checks (cargo fmt, clippy, test, npm check, npm build)
- Audit all composer flows manually: focus mode, notes→thread, voice cues, restructuring, autosave, preview
- Fix ship-blockers only
- Update `docs/composer-mode.md` with new features
- Write release-readiness report
- Files touched: ~5 (docs + targeted fixes)
- Risk: Accumulated defects from two build sessions → Mitigation: Each build session runs checks before handoff, so only edge-case regressions should surface

### Step 4: Write `session-01-handoff.md`

Content covers:
- **What changed:** Three docs created, no code changes
- **Key decisions made:** D1-D4 summarized
- **Open questions:** None blocking Session 02
- **Session 02 must read first:**
  - `docs/roadmap/typefully-beating-composer/charter.md`
  - `docs/roadmap/typefully-beating-composer/implementation-plan.md`
  - `docs/roadmap/typefully-beating-composer/session-01-handoff.md`
  - `dashboard/src/lib/components/ComposeModal.svelte` (to refactor)
  - `dashboard/src/lib/components/ThreadComposer.svelte` (to refactor)
  - `dashboard/src/lib/components/FromNotesPanel.svelte` (to enhance)
  - `dashboard/src/routes/(app)/settings/ContentPersonaSection.svelte` (voice fields reference)
  - `dashboard/src/lib/api.ts` (API types)
  - `crates/tuitbot-core/src/content/generator.rs` (voice injection)
  - `crates/tuitbot-core/src/context/winning_dna.rs` (RAG context)
  - `crates/tuitbot-server/src/routes/assist.rs` (endpoints to wire)
  - `crates/tuitbot-server/tests/compose_contract_tests.rs` (contract stability)

---

## Risks and Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| ComposeModal refactor breaks existing behavior | High — approval mode, scheduling, recovery | Extract incrementally; run `npm run check` after each subcomponent; contract tests catch API regressions |
| Winning DNA wiring requires DB access in assist handlers | Medium — assist handlers currently don't access DB for content history | The `AppState` already has `db` pool; `build_draft_context` is async and takes `&SqlitePool` — straightforward integration |
| X media layout rules are more complex than documented | Medium — could look wrong | Start with the 4 standard grid patterns; accept minor deviations; document known gaps in handoff |
| Session 02 scope too large (refactor + voice + notes) | High — could leave session incomplete | Clear fallback: defer localStorage cue persistence; focus on refactor + winning DNA wiring as minimum viable |
| Thread preview sync issues after refactoring | Medium — reorder/split/merge might not update preview | Keep existing reactive bindings; test each operation after extraction |

## Verification Steps

Since this session creates only markdown files:
1. Verify all three files exist with correct paths:
   - `docs/roadmap/typefully-beating-composer/charter.md`
   - `docs/roadmap/typefully-beating-composer/implementation-plan.md`
   - `docs/roadmap/typefully-beating-composer/session-01-handoff.md`
2. Verify charter includes explicit v1 voice learning definition
3. Verify implementation plan scopes Sessions 02, 03, and 04 with file lists
4. Verify handoff lists exact files Session 02 must read
5. No CI checks needed (no code changes)
