# Work Packages: ReplyGuy - Autonomous X Growth Assistant

**Inputs**: Design documents from `kitty-specs/001-replyguy-autonomous-x-growth-assistant/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/cli-interface.md, quickstart.md

**Tests**: Include testing subtasks for critical paths (auth, API, persistence, scoring) per constitution.

**Organization**: Fine-grained subtasks (Txxx) roll up into work packages (WPxx). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/001-replyguy-autonomous-x-growth-assistant/tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Project Foundation + Configuration (Priority: P0)

**Goal**: Establish the Cargo workspace, error types, config system with full layering, and CLI skeleton.
**Independent Test**: `cargo build --workspace` succeeds; `cargo run --bin replyguy -- --help` prints usage; config loads from TOML with env/CLI overrides.
**Prompt**: `tasks/WP01-project-foundation-config.md`
**Estimated prompt size**: ~400 lines

### Included Subtasks
- [x] T001 Create Cargo workspace with `replyguy-core` (lib) and `replyguy-cli` (bin) crates
- [x] T002 Define error types with thiserror in `crates/replyguy-core/src/error.rs`
- [x] T003 [P] Define config types + defaults in `crates/replyguy-core/src/config/`
- [x] T004 [P] Implement config loading with layering (CLI > env > TOML > defaults)
- [x] T005 Implement config validation logic
- [x] T006 Create CLI skeleton with Clap in `crates/replyguy-cli/src/main.rs`

### Implementation Notes
- Workspace root `Cargo.toml` defines members: `crates/replyguy-core`, `crates/replyguy-cli`
- Error types cover: `ConfigError`, `XApiError`, `LlmError`, `StorageError`, `ScoringError`
- Config uses `serde::Deserialize` on a `Config` struct matching `config.toml` sections
- Env var prefix: `REPLYGUY_`, double underscore for nesting (e.g., `REPLYGUY_LLM__API_KEY`)
- CLI uses `clap::Parser` with derive macros; stub subcommands for all 8 commands

### Parallel Opportunities
- T003 (config types) and T004 (config loading) can proceed in parallel

### Dependencies
- None (starting package)

### Risks & Mitigations
- Config layering complexity: test each layer independently with unit tests

---

## Work Package WP02: SQLite Storage Layer (Priority: P0)

**Goal**: Set up SQLx with SQLite (WAL mode, embedded migrations) and implement CRUD operations for all entities.
**Independent Test**: Database initializes, migrations run, all entity CRUD operations pass unit tests.
**Prompt**: `tasks/WP02-sqlite-storage-layer.md`
**Estimated prompt size**: ~450 lines

### Included Subtasks
- [x] T007 Initialize database with SQLx pool, WAL mode, and `sqlx::migrate!()`
- [x] T008 Create initial migration schema in `migrations/20260221000000_initial_schema.sql`
- [x] T009 [P] Implement discovered tweets CRUD in `crates/replyguy-core/src/storage/tweets.rs`
- [x] T010 [P] Implement replies sent CRUD in `crates/replyguy-core/src/storage/replies.rs`
- [x] T011 [P] Implement original tweets + threads CRUD in `crates/replyguy-core/src/storage/threads.rs`
- [x] T012 [P] Implement action log operations in `crates/replyguy-core/src/storage/action_log.rs`

### Implementation Notes
- Pool: 4 max connections, `busy_timeout(5s)`, `optimize_on_close(true)`
- All timestamps as ISO-8601 TEXT, tweet IDs as TEXT (exceed i64 range)
- Use `sqlx::FromRow` derive on Rust structs matching schema
- Include `build.rs` with `cargo:rerun-if-changed=migrations`

### Parallel Opportunities
- T009-T012 (all CRUD modules) can proceed in parallel after T007+T008 complete

### Dependencies
- Depends on WP01 (error types, config types)

### Risks & Mitigations
- Migration schema changes later: use incremental migrations, never modify existing ones

---

## Work Package WP03: Rate Limiting + Safety Module (Priority: P0)

**Goal**: Implement rate limit tracking, duplicate prevention, and data retention cleanup.
**Independent Test**: Rate limits enforce correctly across period boundaries; duplicate replies are blocked; old records are pruned.
**Prompt**: `tasks/WP03-rate-limiting-safety.md`
**Estimated prompt size**: ~300 lines

### Included Subtasks
- [x] T013 Implement rate limit state CRUD in `crates/replyguy-core/src/storage/rate_limits.rs`
- [x] T014 Implement rate limiter (check, enforce, period reset) in `crates/replyguy-core/src/safety/mod.rs`
- [x] T015 [P] Implement duplicate reply prevention in `crates/replyguy-core/src/safety/dedup.rs`
- [x] T016 [P] Implement data retention cleanup in `crates/replyguy-core/src/storage/cleanup.rs`
- [x] T017 Safety orchestration combining rate limiter + dedup in `crates/replyguy-core/src/safety/mod.rs`

### Implementation Notes
- Rate limits: check `period_start + period_seconds` vs now; reset counter when period expires
- Dedup: query `replies_sent` for `target_tweet_id` before replying
- Cleanup: delete discovered_tweets older than retention period (unreplied: 7 days, replied: 90 days), action_log older than 14 days; never delete rate_limit rows
- VACUUM only after >1000 rows deleted

### Parallel Opportunities
- T015 (dedup) and T016 (cleanup) can proceed in parallel

### Dependencies
- Depends on WP02 (storage layer, database)

### Risks & Mitigations
- Cleanup deleting needed records: test retention boundaries carefully with edge-case timestamps

---

## Work Package WP04: X API Client + Authentication (Priority: P0)

**Goal**: Implement X API v2 client (search, mentions, post, reply) and OAuth 2.0 PKCE authentication with both manual and local callback modes.
**Independent Test**: OAuth flow completes successfully; API calls return parsed responses; tier detection reports correct capabilities.
**Prompt**: `tasks/WP04-x-api-client-auth.md`
**Estimated prompt size**: ~500 lines

### Included Subtasks
- [x] T018 Define X API types in `crates/replyguy-core/src/x_api/types.rs`
- [x] T019 Implement X API client trait + reqwest implementation in `crates/replyguy-core/src/x_api/client.rs`
- [x] T020 Implement OAuth 2.0 PKCE manual code entry flow in `crates/replyguy-core/src/x_api/auth.rs`
- [x] T021 [P] Implement OAuth 2.0 PKCE local callback mode in `crates/replyguy-core/src/x_api/auth.rs`
- [x] T022 Implement token management (store, load, auto-refresh) in `crates/replyguy-core/src/x_api/auth.rs`
- [x] T023 Implement API tier detection in `crates/replyguy-core/src/x_api/tier.rs`

### Implementation Notes
- Client trait: `XApiClient` with methods `search_tweets`, `get_mentions`, `post_tweet`, `reply_to_tweet`, `get_tweet`
- OAuth scopes: `tweet.read tweet.write users.read offline.access`
- Token refresh: access tokens expire every 2 hours; refresh automatically before expiry
- Token storage: `~/.replyguy/tokens.json` with chmod 600
- Tier detection: attempt search endpoint; if 403/not available, report Free tier
- Rate limit headers: parse `x-rate-limit-remaining` and `x-rate-limit-reset`

### Parallel Opportunities
- T021 (callback mode) can proceed in parallel with T020 (manual mode) since they share auth.rs but are separate functions

### Dependencies
- Depends on WP01 (error types, config types)

### Risks & Mitigations
- X API rate limits during testing: use wiremock for HTTP fixtures, avoid hitting live API in CI
- Token refresh race conditions: use a mutex/RwLock around token state

---

## Work Package WP05: LLM Integration + Content Generator (Priority: P0)

**Goal**: Implement multi-provider LLM abstraction (OpenAI, Anthropic, Ollama) and the content generator for replies, tweets, and threads.
**Independent Test**: Each provider returns completions; ContentGenerator produces properly formatted replies (<= 3 sentences), tweets (<= 280 chars), and threads (5-8 tweets).
**Prompt**: `tasks/WP05-llm-integration-content-generator.md`
**Estimated prompt size**: ~400 lines

### Included Subtasks
- [x] T024 Define LlmProvider trait + types in `crates/replyguy-core/src/llm/mod.rs`
- [x] T025 Implement OpenAI-compatible provider in `crates/replyguy-core/src/llm/openai_compat.rs`
- [x] T026 [P] Implement Anthropic native provider in `crates/replyguy-core/src/llm/anthropic.rs`
- [x] T027 Implement provider factory in `crates/replyguy-core/src/llm/factory.rs`
- [x] T028 Implement ContentGenerator in `crates/replyguy-core/src/content/generator.rs`

### Implementation Notes
- Trait: `LlmProvider` with `complete(system, user_message, params) -> LlmResponse` and `health_check()`
- OpenAI-compat covers both OpenAI (`api.openai.com/v1`) and Ollama (`localhost:11434/v1`) - same request/response format, different base URL and API key
- Anthropic uses native Messages API: `api.anthropic.com/v1/messages`, `x-api-key` header, `anthropic-version: 2023-06-01`
- ContentGenerator: `generate_reply(tweet, author)`, `generate_tweet(topic)`, `generate_thread(topic) -> Vec<String>`
- Reply prompt: <= 3 sentences, conversational, mention product only when natural
- Thread: parse LLM output into individual tweets, validate each <= 280 chars

### Parallel Opportunities
- T025 (OpenAI) and T026 (Anthropic) can proceed in parallel

### Dependencies
- Depends on WP01 (error types, config types)

### Risks & Mitigations
- LLM output format unpredictable: validate and retry if output doesn't match expected format (e.g., thread not properly delimited)

---

## Work Package WP06: Scoring Engine (Priority: P1)

**Goal**: Implement the heuristic tweet scoring engine with configurable weights and the CLI score command.
**Independent Test**: Scoring returns consistent 0-100 scores; weights are configurable; CLI displays formatted score breakdown.
**Prompt**: `tasks/WP06-scoring-engine.md`
**Estimated prompt size**: ~250 lines

### Included Subtasks
- [x] T029 Implement scoring signals in `crates/replyguy-core/src/scoring/signals.rs`
- [x] T030 Implement ScoringEngine in `crates/replyguy-core/src/scoring/mod.rs`
- [x] T031 [P] Implement score formatting for CLI display
- [x] T032 Implement CLI `replyguy score <tweet_id>` command in `crates/replyguy-cli/src/commands/score.rs`

### Implementation Notes
- Four signals: keyword_relevance (0-40), follower_count (0-20, log scale), recency (0-15), engagement_rate (0-25)
- All max values configurable via `[scoring]` section in config.toml
- Threshold default: 70; configurable
- CLI output: show total score, per-signal breakdown, and REPLY/SKIP verdict

### Parallel Opportunities
- T031 (formatting) can proceed alongside T029-T030

### Dependencies
- Depends on WP01 (config), WP04 (X API types for Tweet struct)

### Risks & Mitigations
- Scoring accuracy: provide `replyguy score` command for users to tune weights manually

---

## Work Package WP07: Automation Runtime + Scheduler (Priority: P1)

**Goal**: Build the loop scheduler, runtime orchestrator with graceful shutdown, serialized posting queue, and periodic status summary.
**Independent Test**: Scheduler fires at configured intervals with jitter; runtime spawns and stops loops cleanly; SIGTERM triggers graceful shutdown.
**Prompt**: `tasks/WP07-automation-runtime-scheduler.md`
**Estimated prompt size**: ~350 lines

### Included Subtasks
- [x] T033 Implement scheduler module in `crates/replyguy-core/src/automation/scheduler.rs`
- [x] T034 Implement runtime orchestrator in `crates/replyguy-core/src/automation/mod.rs`
- [x] T035 Implement graceful shutdown with signal handling and cancellation tokens
- [x] T036 [P] Implement posting queue (serialized posting, rate-limit aware)
- [x] T037 [P] Implement periodic status summary (configurable interval, stats collection)

### Implementation Notes
- Scheduler: `tokio::time::interval` with randomized jitter added to each tick
- Orchestrator: spawns each loop as a `tokio::spawn` task, holds `JoinHandle`s
- Shutdown: `tokio::signal::ctrl_c()` + Unix SIGTERM; set a `CancellationToken`, await all handles
- Posting queue: `tokio::sync::mpsc` channel; single consumer posts to X API with rate checking
- Status summary: collect counts from action_log since last summary; print if enabled

### Parallel Opportunities
- T036 (posting queue) and T037 (status summary) can proceed in parallel

### Dependencies
- Depends on WP03 (rate limiting, safety module)

### Risks & Mitigations
- Deadlock in posting queue: use bounded channel with timeout on send
- Missed signals: register signal handlers early in startup

---

## Work Package WP08: Mentions + Discovery Loops (Priority: P1) MVP

**Goal**: Implement the mentions monitoring loop and the tweet discovery + reply loop - the core engagement engine.
**Independent Test**: Mentions loop fetches and replies to mentions; discovery loop searches, scores, filters, and replies to qualifying tweets; dry-run mode works for both.
**Prompt**: `tasks/WP08-mentions-discovery-loops.md`
**Estimated prompt size**: ~450 lines

### Included Subtasks
- [x] T038 Implement mentions loop in `crates/replyguy-core/src/automation/mentions_loop.rs`
- [x] T039 Implement discovery loop in `crates/replyguy-core/src/automation/discovery_loop.rs`
- [x] T040 Integrate both loops with safety module (rate checks, dedup, action logging)
- [x] T041 [P] Implement dry-run support for both loops
- [x] T042 [P] Implement CLI `replyguy mentions` command in `crates/replyguy-cli/src/commands/mentions.rs`
- [x] T043 [P] Implement CLI `replyguy discover` command in `crates/replyguy-cli/src/commands/discover.rs`

### Implementation Notes
- Mentions loop: fetch mentions since last check (track `since_id`), generate reply via ContentGenerator, post via posting queue, record in DB
- Discovery loop: search each keyword, score results, filter >= threshold, generate reply, post via posting queue, record in DB
- Both loops: check rate limits before acting, log all actions, skip duplicates
- Dry-run: execute full pipeline but skip posting; print what would be posted
- CLI commands: single-shot execution (not looping), useful for testing

### Parallel Opportunities
- T041, T042, T043 can proceed in parallel after T038-T040 establish the core loop logic

### Dependencies
- Depends on WP04 (X API client), WP05 (LLM + content generator), WP07 (runtime + scheduler)

### Risks & Mitigations
- X API rate exhaustion during discovery: respect `x-rate-limit-remaining` headers, back off early
- LLM failures mid-loop: skip current tweet, log error, continue to next

---

## Work Package WP09: Content + Thread Loops (Priority: P2)

**Goal**: Implement the original content posting loop and the educational thread loop.
**Independent Test**: Content loop generates and posts educational tweets on schedule; thread loop generates and posts 5-8 tweet threads; dry-run works for both.
**Prompt**: `tasks/WP09-content-thread-loops.md`
**Estimated prompt size**: ~400 lines

### Included Subtasks
- [x] T044 Implement content loop in `crates/replyguy-core/src/automation/content_loop.rs`
- [x] T045 Implement thread loop in `crates/replyguy-core/src/automation/thread_loop.rs`
- [x] T046 Integrate both loops with safety (rate checks, action logging)
- [x] T047 [P] Implement dry-run support for both loops
- [x] T048 [P] Implement CLI `replyguy post` command in `crates/replyguy-cli/src/commands/post.rs`
- [x] T049 [P] Implement CLI `replyguy thread` command in `crates/replyguy-cli/src/commands/thread.rs`

### Implementation Notes
- Content loop: check last original tweet timestamp; if window elapsed, pick random topic from `industry_topics`, generate tweet, post, record
- Thread loop: check last thread timestamp; if interval elapsed, pick topic, generate 5-8 tweets via ContentGenerator, post as reply chain (each replying to previous), record thread + individual tweets
- Thread posting: capture each tweet's ID from response to chain replies; handle partial failure (some tweets posted, others failed)
- Dry-run: generate content and display without posting

### Parallel Opportunities
- T047, T048, T049 can proceed in parallel after core loops are implemented

### Dependencies
- Depends on WP05 (LLM + content generator), WP07 (runtime + scheduler)

### Risks & Mitigations
- Thread posting failure mid-chain: record partial thread with `status = 'partial'`, log which tweets succeeded
- Generated tweet exceeds 280 chars: validate length, regenerate if needed (max 3 retries)

---

## Work Package WP10: CLI Integration + Agent Startup (Priority: P1)

**Goal**: Wire up the full agent startup (`replyguy run`), auth and test commands, output modes, and config example file.
**Independent Test**: `replyguy run` starts all loops and shuts down cleanly; `replyguy auth` completes OAuth flow; `replyguy test` validates config and reports status; verbose/quiet modes work.
**Prompt**: `tasks/WP10-cli-integration-agent-startup.md`
**Estimated prompt size**: ~350 lines

### Included Subtasks
- [x] T050 Implement CLI `replyguy run` command in `crates/replyguy-cli/src/commands/run.rs`
- [x] T051 [P] Implement CLI `replyguy auth` command in `crates/replyguy-cli/src/commands/auth.rs`
- [x] T052 [P] Implement CLI `replyguy test` command in `crates/replyguy-cli/src/commands/test.rs`
- [x] T053 Configure verbose/quiet output modes with tracing-subscriber
- [x] T054 [P] Create `config.example.toml` with documented defaults
- [x] T055 [P] Create GitHub Actions CI workflow (.github/workflows/ci.yml) for Linux, macOS, Windows
- [x] T056 [P] Create README.md with project overview, installation, quickstart, and configuration reference

### Implementation Notes
- `run`: init DB, load config, detect tier, report enabled loops, start runtime orchestrator, await shutdown
- `auth`: select mode from config (overridable via `--mode`), run PKCE flow, store tokens, report success
- `test`: validate config sections, test X API connectivity, test LLM provider, report tier, report DB status
- Output: `tracing_subscriber::fmt()` with `EnvFilter`; quiet = `error`, default = `warn`, verbose = `debug`
- `config.example.toml`: fully documented example matching contracts/cli-interface.md

### Parallel Opportunities
- T051, T052, T054 can proceed in parallel

### Dependencies
- Depends on WP04 (auth flow), WP06 (score command), WP08 (mentions+discovery)
- Soft dependency on WP09 (content+threads): `replyguy run` starts only the loops whose WPs are complete. Content and thread loops are enabled when WP09 is done.

### Risks & Mitigations
- Missing loop dependencies at startup: `replyguy test` validates all prerequisites before `run`

---

## Dependency & Execution Summary

```
Wave 1: WP01 (foundation)
Wave 2: WP02, WP04, WP05 (parallel - all depend only on WP01)
Wave 3: WP03, WP06 (parallel - WP03 needs WP02, WP06 needs WP04)
Wave 4: WP07 (needs WP03)
Wave 5: WP08, WP09 (parallel - both need WP07 + earlier WPs)
Wave 6: WP10 (needs WP06, WP08, WP09)
```

**Critical path**: WP01 -> WP02 -> WP03 -> WP07 -> WP08 -> WP10

**Parallelization highlights**:
- Wave 2 runs 3 WPs in parallel (storage, X API, LLM)
- Wave 3 runs 2 WPs in parallel (safety, scoring)
- Wave 5 runs 2 WPs in parallel (engagement loops, content loops)

**MVP Scope**: WP01 + WP02 + WP03 + WP04 + WP05 + WP06 + WP07 + WP08 + WP10
- Delivers: config, auth, discovery, mentions, scoring, replies, `run` command
- Defers: WP09 (original content + thread posting - P2/P3 priority)
- Note: WP10 has a soft dependency on WP09. The `replyguy run` command starts only available loops â€” content+thread loops activate when WP09 is implemented.

---

## Subtask Index (Reference)

| Subtask | Summary | WP | Priority | Parallel? |
|---------|---------|-----|----------|-----------|
| T001 | Create Cargo workspace | WP01 | P0 | No |
| T002 | Error types (thiserror) | WP01 | P0 | No |
| T003 | Config types + defaults | WP01 | P0 | Yes |
| T004 | Config loading (layered) | WP01 | P0 | Yes |
| T005 | Config validation | WP01 | P0 | No |
| T006 | CLI skeleton (Clap) | WP01 | P0 | No |
| T007 | Database init (SQLx pool, WAL) | WP02 | P0 | No |
| T008 | Initial migration schema | WP02 | P0 | No |
| T009 | Discovered tweets CRUD | WP02 | P0 | Yes |
| T010 | Replies sent CRUD | WP02 | P0 | Yes |
| T011 | Original tweets + threads CRUD | WP02 | P0 | Yes |
| T012 | Action log operations | WP02 | P0 | Yes |
| T013 | Rate limit state CRUD | WP03 | P0 | No |
| T014 | Rate limiter (check/enforce) | WP03 | P0 | No |
| T015 | Duplicate reply prevention | WP03 | P0 | Yes |
| T016 | Data retention cleanup | WP03 | P0 | Yes |
| T017 | Safety orchestration | WP03 | P0 | No |
| T018 | X API types | WP04 | P0 | No |
| T019 | X API client trait + impl | WP04 | P0 | No |
| T020 | OAuth PKCE manual flow | WP04 | P0 | No |
| T021 | OAuth PKCE callback mode | WP04 | P0 | Yes |
| T022 | Token management | WP04 | P0 | No |
| T023 | API tier detection | WP04 | P0 | No |
| T024 | LlmProvider trait + types | WP05 | P0 | No |
| T025 | OpenAI-compat provider | WP05 | P0 | No |
| T026 | Anthropic native provider | WP05 | P0 | Yes |
| T027 | Provider factory | WP05 | P0 | No |
| T028 | ContentGenerator | WP05 | P0 | No |
| T029 | Scoring signals | WP06 | P1 | No |
| T030 | ScoringEngine | WP06 | P1 | No |
| T031 | Score formatting | WP06 | P1 | Yes |
| T032 | CLI `replyguy score` | WP06 | P1 | No |
| T033 | Scheduler module | WP07 | P1 | No |
| T034 | Runtime orchestrator | WP07 | P1 | No |
| T035 | Graceful shutdown | WP07 | P1 | No |
| T036 | Posting queue | WP07 | P1 | Yes |
| T037 | Status summary | WP07 | P1 | Yes |
| T038 | Mentions loop | WP08 | P1 | No |
| T039 | Discovery loop | WP08 | P1 | No |
| T040 | Loop safety integration | WP08 | P1 | No |
| T041 | Dry-run support (mentions+discovery) | WP08 | P1 | Yes |
| T042 | CLI `replyguy mentions` | WP08 | P1 | Yes |
| T043 | CLI `replyguy discover` | WP08 | P1 | Yes |
| T044 | Content loop | WP09 | P2 | No |
| T045 | Thread loop | WP09 | P2 | No |
| T046 | Loop safety integration | WP09 | P2 | No |
| T047 | Dry-run support (content+thread) | WP09 | P2 | Yes |
| T048 | CLI `replyguy post` | WP09 | P2 | Yes |
| T049 | CLI `replyguy thread` | WP09 | P2 | Yes |
| T050 | CLI `replyguy run` | WP10 | P1 | No |
| T051 | CLI `replyguy auth` | WP10 | P1 | Yes |
| T052 | CLI `replyguy test` | WP10 | P1 | Yes |
| T053 | Verbose/quiet output modes | WP10 | P1 | No |
| T054 | config.example.toml | WP10 | P1 | Yes |
| T055 | GitHub Actions CI (3 platforms) | WP10 | P1 | Yes |
| T056 | README quickstart | WP10 | P1 | Yes |
